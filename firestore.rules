rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ✅ FIXED: User profiles with safe access patterns
    match /users/{userId} {
      // Allow users to read their own profile
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // Allow public read for verified students (limited fields)
      allow get: if 
        resource.data.verificationStatus == 'verified' && 
        resource.data.userType == 'student';
      
      // Admins can read all profiles (without circular dependency)
      allow list: if 
        request.auth != null && 
        isUserAdmin(request.auth.uid);
      
      allow write: if 
        // Users can write their own profile
        (request.auth != null && request.auth.uid == userId) ||
        // Admins can update any user
        isUserAdmin(request.auth.uid);
      
      allow create: if 
        // Users can create their own profile during signup
        (request.auth != null && request.auth.uid == userId) &&
        // Validate required fields
        request.resource.data.firstName is string &&
        request.resource.data.surname is string &&
        request.resource.data.email is string;
      
      allow delete: if 
        // Users can delete their own account
        (request.auth != null && request.auth.uid == userId) ||
        // Admins can delete any user
        isUserAdmin(request.auth.uid);
    }
    
    // ✅ FIXED: Campaign rules with proper validation
    match /campaigns/{campaignId} {
      allow read: if true; // Public read access
      
      allow create: if 
        // Only authenticated users
        request.auth != null &&
        // User can only create campaigns for themselves
        request.auth.uid == request.resource.data.studentId &&
        // User must be verified student
        isVerifiedStudent(request.auth.uid) &&
        // Validate required campaign fields
        request.resource.data.title is string &&
        request.resource.data.description is string &&
        request.resource.data.goal_amount is number &&
        request.resource.data.goal_amount > 0 &&
        request.resource.data.category is string &&
        request.resource.data.status is string;
      
      allow update: if 
        // Students can update their own campaigns
        (request.auth != null && resource.data.studentId == request.auth.uid &&
         // Can only update certain fields
         onlyAllowedFieldsChanged(['title', 'description', 'updates', 'image_url'])) ||
        // Admins can update any campaign
        isUserAdmin(request.auth.uid);
      
      allow delete: if 
        // Students can delete their own campaigns
        (request.auth != null && resource.data.studentId == request.auth.uid) ||
        // Admins can delete any campaign
        isUserAdmin(request.auth.uid);
    }
    
    // ✅ FIXED: Donations with proper security
    match /donations/{donationId} {
      allow read: if 
        // Public can see donations (for transparency)
        true;
      
      allow create: if 
        // Only authenticated funders
        request.auth != null &&
        // Must be a funder
        getUserType(request.auth.uid) == 'funder' &&
        // Validate donation data
        request.resource.data.amount is number &&
        request.resource.data.amount > 0 &&
        request.resource.data.campaignId is string &&
        request.resource.data.funderId == request.auth.uid;
      
      allow update: if 
        // Only allow status updates by admins
        isUserAdmin(request.auth.uid) &&
        // Can only update status fields
        onlyAllowedFieldsChanged(['paymentStatus', 'adminNotes']);
      
      allow delete: if false; // Donations should not be deleted
    }
    
    // ✅ FIXED: Newsletter - public create, admin read
    match /newsletterSubscriptions/{email} {
      allow create: if 
        // Anyone can subscribe with valid email
        request.resource.data.email is string &&
        request.resource.data.email.matches('^[^@]+@[^@]+\\.[^@]+$') &&
        request.resource.id == request.resource.data.email; // Document ID should be email
      
      allow read: if isUserAdmin(request.auth.uid);
      allow update, delete: if false;
    }
    
    // ✅ FIXED: Contact submissions
    match /contactSubmissions/{document} {
      allow create: if 
        request.resource.data.email is string &&
        request.resource.data.email.matches('^[^@]+@[^@]+\\.[^@]+$') &&
        request.resource.data.message is string;
      
      allow read: if isUserAdmin(request.auth.uid);
      allow update, delete: if false;
    }

    // ✅ FIXED: Mail collection for email sending
    match /mail/{document} {
      allow create: if 
        request.resource.data.to is string &&
        request.resource.data.to.matches('^[^@]+@[^@]+\\.[^@]+$') &&
        request.resource.data.template is string;
      allow read, update, delete: if false;
    }
    
    // Helper functions to avoid circular dependencies
    function isUserAdmin(uid) {
      return request.auth != null && 
        exists(/databases/$(database)/documents/users/$(uid)) &&
        get(/databases/$(database)/documents/users/$(uid)).data.userType == 'admin';
    }
    
    function isVerifiedStudent(uid) {
      return request.auth != null && 
        exists(/databases/$(database)/documents/users/$(uid)) &&
        get(/databases/$(database)/documents/users/$(uid)).data.userType == 'student' &&
        get(/databases/$(database)/documents/users/$(uid)).data.verificationStatus == 'verified';
    }
    
    function getUserType(uid) {
      return get(/databases/$(database)/documents/users/$(uid)).data.userType;
    }
    
    function onlyAllowedFieldsChanged(allowedFields) {
      return request.resource.data.diff(resource.data).affectedKeys()
        .hasOnly(allowedFields);
    }
    
    // Other collections remain mostly the same but use helper functions
    match /adminSettings/{document} {
      allow read, write: if isUserAdmin(request.auth.uid);
    }
    
    match /notifications/{notificationId} {
      allow read, write: if 
        request.auth != null && 
        resource.data.userId == request.auth.uid;
    }
    
    match /auditLog/{logId} {
      allow read, write: if isUserAdmin(request.auth.uid);
    }
    
    match /thankYouMessages/{messageId} {
      allow read, write: if 
        request.auth != null && 
        (resource.data.funderId == request.auth.uid || 
         resource.data.studentId == request.auth.uid);
    }
    
    match /systemLogs/{logId} {
      allow read, write: if isUserAdmin(request.auth.uid);
    }
    
    // Default deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}