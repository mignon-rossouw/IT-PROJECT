rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ✅ FIXED: Allow public read access for student profiles
    match /users/{userId} {
      // Allow public read access for student profiles
      allow read: if 
        // Anyone can read student profiles
        resource.data.userType == 'student' ||
        // Users can read their own profile
        (request.auth != null && request.auth.uid == userId) ||
        // Admins can read all profiles
        isUserAdmin(request.auth.uid);
      
      allow write: if 
        // Users can write their own profile
        (request.auth != null && request.auth.uid == userId) ||
        // Admins can update any user
        isUserAdmin(request.auth.uid);
      
      allow create: if 
        // Users can create their own profile during signup
        (request.auth != null && request.auth.uid == userId) &&
        // Validate required fields
        request.resource.data.firstName is string &&
        request.resource.data.surname is string &&
        request.resource.data.email is string;
      
      allow delete: if 
        // Users can delete their own account
        (request.auth != null && request.auth.uid == userId) ||
        // Admins can delete any user
        isUserAdmin(request.auth.uid);
    }
    
    // ✅ FIXED: Campaign rules - allow public read and student updates
    match /campaigns/{campaignId} {
      allow read: if true; // Public read access for all campaigns
      
      allow create: if 
        // Only authenticated users
        request.auth != null &&
        // User can only create campaigns for themselves
        (request.auth.uid == request.resource.data.studentId || 
         request.auth.uid == request.resource.data.student_id) &&
        // Validate required campaign fields
        request.resource.data.title is string &&
        request.resource.data.description is string &&
        request.resource.data.goal_amount is number &&
        request.resource.data.goal_amount > 0 &&
        request.resource.data.category is string;
      
      allow update: if 
        // Students can update their own campaigns
        (request.auth != null && 
         (resource.data.studentId == request.auth.uid || 
          resource.data.student_id == request.auth.uid)) ||
        // Admins can update any campaign
        isUserAdmin(request.auth.uid);
      
      allow delete: if 
        // Students can delete their own campaigns
        (request.auth != null && 
         (resource.data.studentId == request.auth.uid || 
          resource.data.student_id == request.auth.uid)) ||
        // Admins can delete any campaign
        isUserAdmin(request.auth.uid);
    }
    
    // ✅ FIXED: Donations with proper security
    match /donations/{donationId} {
      allow read: if true; // Public can see donations (for transparency)
      
      allow create: if 
        // Only authenticated users
        request.auth != null &&
        // Validate donation data
        request.resource.data.amount is number &&
        request.resource.data.amount > 0 &&
        request.resource.data.campaignId is string &&
        request.resource.data.funderId == request.auth.uid;
      
      allow update: if 
        // Only allow status updates by admins
        isUserAdmin(request.auth.uid);
      
      allow delete: if false; // Donations should not be deleted
    }
    
    // ✅ FIXED: Newsletter - public create, admin read
    match /newsletterSubscriptions/{email} {
      allow create: if true; // Anyone can subscribe
      
      allow read: if 
        // Admins can read all
        isUserAdmin(request.auth.uid) ||
        // Users can check if their own email is subscribed
        (request.auth != null && request.auth.token.email == email);
      
      allow update, delete: if false;
    }
    
    // ✅ FIXED: Contact submissions - public create
    match /contactSubmissions/{document} {
      allow create: if true; // Anyone can submit contact form
      allow read: if isUserAdmin(request.auth.uid);
      allow update, delete: if false;
    }

    // ✅ FIXED: Mail collection for email sending
    match /mail/{document} {
      allow create: if true; // Allow email sending
      allow read, update, delete: if false;
    }
    
    // Helper functions
    function isUserAdmin(uid) {
      return uid != null && 
        exists(/databases/$(database)/documents/users/$(uid)) &&
        get(/databases/$(database)/documents/users/$(uid)).data.userType == 'admin';
    }
    
    // Other collections
    match /adminSettings/{document} {
      allow read, write: if isUserAdmin(request.auth.uid);
    }
    
    match /notifications/{notificationId} {
      allow read, write: if 
        request.auth != null && 
        resource.data.userId == request.auth.uid;
    }
    
    match /auditLog/{logId} {
      allow read, write: if isUserAdmin(request.auth.uid);
    }
    
    match /thankYouMessages/{messageId} {
      allow read, write: if 
        request.auth != null && 
        (resource.data.funderId == request.auth.uid || 
         resource.data.studentId == request.auth.uid);
    }
    
    match /systemLogs/{logId} {
      allow read, write: if isUserAdmin(request.auth.uid);
    }
    
    // Default deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}