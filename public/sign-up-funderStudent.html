<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Sign Up</title>

<!-- BOOTSTRAP -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
/* --- Your CSS --- */
.toggle-switch { position: relative; width: 220px; height: 50px; background-color: #012a4a2e; border-radius: 25px; display: flex; cursor: pointer; user-select: none;}
.toggle-option {flex:1; display:flex; justify-content:center; align-items:center; z-index:2; font-weight:bold; color:#0B93FB; transition: color 0.3s;}
.toggle-option.active { color:#fff; }
.toggle-indicator {position:absolute; top:2px; left:2px; width:108px; height:46px; background-color:#012A4A; border-radius:25px; transition:left 0.3s; z-index:1;}
.hidden { display:none; }
</style>

</head>
<body>

<div class="container mt-5">
  <h2 class="text-center mb-2">Sign Up</h2>

  <!-- User Type Toggle -->
  <div class="toggle-wrapper mb-4 d-flex justify-content-center">
    <div class="toggle-switch" id="toggleSwitch">
      <div class="toggle-option student active">Student</div>
      <div class="toggle-option funder">Funder</div>
      <div class="toggle-indicator" id="toggleIndicator"></div>
    </div>
    <input type="hidden" id="userType" value="student"/>
  </div>

  <!-- FORM -->
  <form id="signupForm">
    <!-- Common Fields -->
    <div class="mb-3">
      <label class="form-label">First Name *</label>
      <input type="text" class="form-control" id="firstName" required>
    </div>
    <div class="mb-3">
      <label class="form-label">Surname *</label>
      <input type="text" class="form-control" id="surName" required>
    </div>
    <div class="mb-3">
      <label class="form-label">ID Number or Passport Number *</label>
      <input type="text" class="form-control" id="idNumber" required>
    </div>
    <div class="mb-3">
      <label class="form-label">Date of Birth *</label>
      <input type="date" class="form-control" id="dob" required>
    </div>

    <!-- Student Fields -->
    <div id="studentFields" class="hidden">
      <div class="mb-3">
        <label class="form-label">Country of Citizenship *</label>
        <input type="text" class="form-control" id="coCitizenship" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Country of Birth *</label>
        <input type="text" class="form-control" id="coBirth" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Country of Residence *</label>
        <input type="text" class="form-control" id="coResidence" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Email *</label>
        <input type="email" class="form-control" id="studentEmail" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Contact Number *</label>
        <input type="tel" class="form-control" id="studentCNumber" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Password *</label>
        <input type="password" class="form-control" id="studentPassword" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Confirm Password *</label>
        <input type="password" class="form-control" id="studentCPassword" required>
      </div>
    </div>

    <!-- Funder Fields -->
    <div id="funderFields" class="hidden">
      <div class="mb-3">
        <label class="form-label">Email *</label>
        <input type="email" class="form-control" id="funderEmail" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Contact Number *</label>
        <input type="tel" class="form-control" id="funderCNumber" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Password *</label>
        <input type="password" class="form-control" id="funderPassword" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Confirm Password *</label>
        <input type="password" class="form-control" id="funderCPassword" required>
      </div>
    </div>

    <button type="submit" class="btn btn-primary mt-3">Sign Up</button>
  </form>
</div>

<!-- Firebase + Toggle JS -->
<script type="module">
import { auth, db } from './firebase-config.js';
import { createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
import { ref, set } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

// --- Toggle ---
const studentOption = document.querySelector(".toggle-option.student");
const funderOption = document.querySelector(".toggle-option.funder");
const indicator = document.getElementById("toggleIndicator");
const userTypeInput = document.getElementById("userType");
const studentFields = document.getElementById("studentFields");
const funderFields = document.getElementById("funderFields");

const selectUserType = (type) => {
  userTypeInput.value = type;
  studentFields.classList.toggle("hidden", type !== "student");
  funderFields.classList.toggle("hidden", type !== "funder");
  studentOption.classList.toggle("active", type === "student");
  funderOption.classList.toggle("active", type === "funder");
  indicator.style.left = type === "student" ? "2px" : "110px";
};

studentOption.addEventListener("click", () => selectUserType("student"));
funderOption.addEventListener("click", () => selectUserType("funder"));

// --- Form Submission ---
const signupForm = document.getElementById("signupForm");

signupForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  const userType = userTypeInput.value;

  const email = userType === "student" ? document.getElementById("studentEmail").value : document.getElementById("funderEmail").value;
  const password = userType === "student" ? document.getElementById("studentPassword").value : document.getElementById("funderPassword").value;
  const confirmPassword = userType === "student" ? document.getElementById("studentCPassword").value : document.getElementById("funderCPassword").value;

  if(password !== confirmPassword){
    alert("Passwords do not match.");
    return;
  }

  try {
    // Create Firebase Auth user
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    const uid = userCredential.user.uid;

    // Collect user data
    const userData = {
      uid,
      role: userType,
      firstName: document.getElementById("firstName").value,
      surName: document.getElementById("surName").value,
      idNumber: document.getElementById("idNumber").value,
      dob: document.getElementById("dob").value,
      email,
      contactNumber: userType === "student" ? document.getElementById("studentCNumber").value : document.getElementById("funderCNumber").value,
      createdAt: new Date().toISOString()
    };

    // Extra student fields
    if(userType === "student"){
      userData.coCitizenship = document.getElementById("coCitizenship").value;
      userData.coBirth = document.getElementById("coBirth").value;
      userData.coResidence = document.getElementById("coResidence").value;
    }

    // Save to Realtime Database
    await set(ref(db, "users/" + uid), userData);

    alert("Sign-up successful!");
    window.location.href = "login.html";

  } catch(error){
    console.error(error);
    alert("Error: " + error.message);
  }
});
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
