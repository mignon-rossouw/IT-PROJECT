<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Meta tags for character encoding and responsive viewport -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - FundMyFuture</title>


    
    <!-- Global Auth Manager -->
<script src="./js/auth-manager.js"></script>
    
  <!-- External CSS Libraries -->
  <!-- Bootstrap CSS for responsive layout and components -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome for icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <!-- Bootstrap Icons for additional icon set -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Custom global stylesheet -->
  <link rel="stylesheet" href="./css/styles.css">

    <style>
/* COLOUR PALLET (dark to light)
Blue 1:   #012A4A
Blue 2:   #013A63
Blue 3:   #01497C
Blue 4:   #014F86
Blue 5:   #2A6F97
Blue 6:   #2C7DA0
Blue 7:   #468FAF
Blue 8:   #61A5C2
Blue 9:   #89C2D9
Blue 10:  #A9D6E5
*/

/* Prevent horizontal scrolling */
body {
  overflow-x: hidden;
}

/* Dashboard header styling */
.dashboard-header {
  background-color: #2A6F97;
  padding: 30px 0;
  margin-bottom: 0px;
  color: white;
}

/* Background pattern for profile section */
  .profile-background {
  width: 100%;
    background:
      conic-gradient(from 120deg at 50% 87.5%, #a9d6e5 120deg, #0000 0),
      conic-gradient(from 120deg at 50% 87.5%, #a9d6e5 120deg, #0000 0) 0 97px,
      conic-gradient(from 180deg at 75%, #61A5C2 60deg, #0000 0),
      conic-gradient(from 60deg at 75% 75%, #a9d6e5 0 60deg, #0000 0),
      linear-gradient(150deg, #0000 8.33%, #a9d6e5 0 25%, #0000 0) 0 97px,
      conic-gradient(at 25% 25%, #0000 50%, #61A5C2 0 240deg, #a9d6e5 0 300deg, #61A5C2 0),
      linear-gradient(-150deg, #0000 8.33%, #a9d6e5 0 25%, #0000 0) #012a4a;
    background-size: 168px 194px;
  }

/* Edit Modal Styles */
.edit-modal .modal-content {
  background-color: #A9D6E5;
  border: 3px solid #012A4A;
}
.edit-modal .form-label {
  color: #012A4A;
  font-weight: bold;
}

/* Card Styling */
.card-header {
  background-color: #012A4A;
  color: #A9D6E5;
}

/* Edit button styling - Profile */
.btn-edit {
  background: none;
  border: none;
  color: #A9D6E5;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-edit:hover {
  color: #ffd60a;
  transform: scale(1.02);
}

/* Change Profile Picture Button */
.btn-change-photo {
  background-color: #012A4A;
  color: #A9D6E5;
  transition: all 0.3s ease;
}

.btn-change-photo:hover {
  background-color: #ffd60a;
  color: #012A4A;
  transform: scale(1.02);
}

/* Campaign card styles */
.campaign-card {
  transition: transform 0.2s;
}
.campaign-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 15px rgba(0,0,0,0.1);
}

/* Alert positioning */
.alert-fixed {
  position: fixed;
  top: 100px;
  right: 20px;
  z-index: 9999;
  min-width: 300px;
}

/* Loading spinner */
#loadingSpinner {
  z-index: 9999;
}

/* Profile picture upload */
.profile-picture-container {
  position: relative;
  display: inline-block;
}
.profile-picture-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.3s;
  cursor: pointer;
}
.profile-picture-container:hover .profile-picture-overlay {
  opacity: 1;
}

/* Profile icon color */
.profile-icon {
  color: #A9D6E5;
}

/* Custom progress bar container */
.custom-progress {
  height: 20px;
  background-color: #e0af0057;
  border-radius: 5px;
  overflow: hidden;
}

/* Custom progress bar fill */
.custom-bar {
  background-color: #e0b000;
  color: #012a4a;
  font-weight: bold;
  text-align: center;
  line-height: 30px;
  border-radius: 5px;
  transition: width 0.6s ease;
}

/* Progress section background */
.progress-section {
  background-color: #86a9c35e;
  border-radius: 5px;
}

/* Share button styling */
.btn-share {
  background-color: #012A4A;
  color: #A9D6E5;
  font-weight: 800;
  transition: all 0.3s ease;
}

/* Share button hover effects */
.btn-share:hover {
  background-color: #ffd60a;
  transform: scale(1.01);
}

/* View all button styling */
.btn-view-all {
  background-color: #012A4A;
  color: #A9D6E5;
  font-weight: 800;
  box-shadow: 0 4px 12px rgba(55, 44, 161, 0.2);
  transition: all 0.3s ease;
}

/* View all button hover effects */
.btn-view-all:hover {
  color: #012A4A;
  background-color: #89C2D9;
  transform: scale(1.01);
}

/* Custom horizontal rule styling */
.custom-hr {
  border: none;
  border-radius: 5px;
  height: 2px;
  background-color: #012a4aa7;
}

/* Spacer utility class */
.spacer {
  height: 20px;
}

/* Progress title styling */
.progress-title {
  background-color: #2A6F97;
  color: #A9D6E5;
  padding: 10px;
  border-radius: 5px;
  font-weight: 800;
  letter-spacing: 1px;
}

/* Donations title styling */
.donations-title {
  background-color: #2A6F97;
  color: #A9D6E5;
  padding: 10px;
  border-radius: 5px;
  font-weight: 800;
  letter-spacing: 1px;
}

/* Donations link color */
.donations-link {
  color: #A9D6E5;
}

/* About title styling */
.about-title {
  background-color: #2A6F97;
  color: #A9D6E5;
  padding: 10px;
  border-radius: 5px;
  font-weight: 800;
  letter-spacing: 1px;
}

/* Share update title styling */
.share-update {
  background-color: #2A6F97;
  color: #A9D6E5;
  padding: 10px;
  border-radius: 5px;
  font-weight: 800;
  letter-spacing: 1px;
}

/* Updates title styling */
.updates {
  background-color: #2A6F97;
  color: #A9D6E5;
  padding: 10px;
  border-radius: 5px;
  font-weight: 800;
  letter-spacing: 1px;
}

/* Update link color */
.update-link {
  color: #A9D6E5;
}

/* Post update button styling */
.btn-post-update {
  background-color: #012A4A;
  color: #A9D6E5;
  font-weight: 800;
  box-shadow: 0 4px 12px rgba(55, 44, 161, 0.2);
  transition: all 0.3s ease;
}

/* Post update button hover effects */
.btn-post-update:hover {
  color: #012A4A;
  background-color: #89C2D9;
  transform: scale(1.01);
}

/* View update button styling */
.btn-view-update {
  background-color: #012A4A;
  color: #A9D6E5;
  font-weight: 800;
  box-shadow: 0 4px 12px rgba(55, 44, 161, 0.2);
  transition: all 0.3s ease;
}

/* View update button hover effects */
.btn-view-update:hover {
  color: #012A4A;
  background-color: #89C2D9;
  transform: scale(1.01);
}

/* Edit button icon styling */
.edit-btn i {
  font-size: 2rem;
  color: #A9D6E5;
  transition: color 0.2s ease;
}

/* Edit button hover effects */
.edit-btn:hover i {
  color: #ffda1f;
}

/* Share update button icon styling */
.share-update-btn i {
  font-size: 1.2rem;
  color: #A9D6E5;
  transition: color 0.2s ease;
}

/* Share update button hover effects */
.share-update-btn:hover i {
  color: #ffd60a;
}

/* Primary button styling */
.btn-primary-custom {
  background-color: #2A6F97;
  color: white;
  border: none;
  transition: all 0.3s ease;
}

.btn-primary-custom:hover {
  background-color: #468FAF;
  color: white;
  transform: scale(1.02);
}

/* Navbar styling */
.navbar-custom {
  background-color: #012A4A;
}

.navbar-custom .navbar-brand,
.navbar-custom .nav-link {
  color: #A9D6E5 !important;
}

.donate-btn, .login-btn {
  background-color: #2A6F97;
  color: white;
  border: none;
}

.donate-btn:hover, .login-btn:hover {
  background-color: #468FAF;
  color: white;
}

/* Profile card styling */
.profile-card {
  border-radius: 10px;
  overflow: hidden;
}

.title-container {
  background-color: #2A6F97 !important;
}

.title-profile {
  color: #A9D6E5;
}
    </style>
</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-custom px-3">
  <div class="container-fluid">
    <!-- Brand/Logo linking to homepage -->
    <a class="navbar-brand ms-2" href="index.html">FundMyFuture</a>

    <!-- Mobile menu toggle button -->
    <button class="navbar-toggler text-white" type="button" data-bs-toggle="offcanvas" data-bs-target="#navbarOffcanvas">
      <span class="navbar-toggler-icon"></span>
    </button>

    <!-- Offcanvas navigation menu for mobile devices -->
    <div class="offcanvas offcanvas-end text-bg-dark" tabindex="-1" id="navbarOffcanvas">
      <div class="offcanvas-header">
        <!-- Close button for offcanvas menu -->
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
      </div>
      <div class="offcanvas-body">
        <ul class="navbar-nav ms-auto align-items-center">
          <!-- Donate button call-to-action -->
          <li class="nav-item me-3">
            <a class="btn donate-btn ms-2" href="donate.html">DONATE NOW</a>
          </li>
          <!-- Student section link -->
          <li class="nav-item">
            <a class="nav-link" href="sign-up-funderStudent.html">STUDENTS</a>
          </li>
          <!-- Funder section link -->
          <li class="nav-item">
            <a class="nav-link" href="sign-up-funderStudent.html">FUNDERS</a>
          </li>
          <!-- About us informational link -->
          <li class="nav-item">
            <a class="nav-link" href="about.html">ABOUT US</a>
          </li>
          <!-- Login/authentication button -->
          <li class="nav-item me-2" id="login-area">
            <button class="btn login-btn fw-bolder" id="logoutButton">LOGOUT</button>
          </li>
        </ul>
      </div>
    </div>
  </div>
</nav>


<!-- Dashboard Header -->
<div class="container-fluid dashboard-header">
    <div class="container">
        <div class="flex-grow-1 text-start">
          <!-- User role indicator -->
          <h4 class="fw-bold funder-heading mb-0">Student</h4>
          <!-- Main dashboard heading -->
          <h2 class="fw-bold dashboard-heading">Dashboard</h2>
        </div>
        <p class="">Welcome back, <span id="welcomeName">Student</span>!</p>
    </div>
</div>

<!-- Main Content -->
    <!-- Profile Section -->
    <div class="container-fluid profile-background py-4 px-4 mb-5">
      <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="card profile-card border-0 shadow mb-4">
                  <div class="card-header title-container">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="title-profile fw-bold mb-0 d-flex align-items-center">
                            <i class="bi bi-person-badge me-2 fs-3"></i> Profile Information
                        </h5>
                        <button class="btn btn-edit d-flex align-items-center" id="editProfileButton">
                            <i class="bi bi-pencil me-1 fs-3"></i>
                        </button>
                    </div>
                  </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 text-center mb-3">
                                <div class="profile-picture-container">
                                    <img id="profileImage" src="./assets/profile-user.png" 
                                        class="img-fluid rounded-circle border" 
                                        style="width: 150px; height: 150px; object-fit: cover;" 
                                        alt="Profile Picture">
                                    <div class="profile-picture-overlay" id="profilePictureOverlay">
                                        <i class="bi bi-camera text-white fs-1"></i>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-change-photo" id="changePhotoButton">
                                        <i class="bi bi-camera-fill me-2"></i>Change Photo
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-9">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold fs-5">Full Name</label>
                                            <p id="displayFullName" class="form-control-plaintext text-muted">Loading...</p>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold fs-5">Email</label>
                                            <p id="displayEmail" class="form-control-plaintext text-muted">Loading...</p>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold fs-5">Phone Number</label>
                                            <p id="displayPhone" class="form-control-plaintext text-muted">Loading...</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold fs-5">Date of Birth</label>
                                            <p id="displayDOB" class="form-control-plaintext text-muted">Loading...</p>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold fs-5">ID Number</label>
                                            <p id="displayID" class="form-control-plaintext text-muted">Loading...</p>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold fs-5">Location</label>
                                            <p id="displayLocation" class="form-control-plaintext text-muted">Loading...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Academic Information -->
    <div class="container">
      <div class="row">
        <div class="col-12">

          <div class="card profile-card border-0 shadow mb-4">
              <div class="card-header title-container">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="title-profile fw-bold mb-0 d-flex align-items-center">
                        <i class="bi bi-book me-2 fs-3"></i> Academic Information
                    </h5>
                    <button class="btn btn-edit d-flex align-items-center" id="editAcademicButton">
                        <i class="bi bi-pencil me-1 fs-3"></i>
                    </button>
                </div>
              </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label fw-bold">Institution</label>
                    <p id="displayInstitution" class="form-control-plaintext">Loading...</p>
                  </div>
                  <div class="mb-3">
                    <label class="form-label fw-bold">Course/Program</label>
                    <p id="displayCourse" class="form-control-plaintext">Loading...</p>
                  </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Year of Study</label>
                        <p id="displayYear" class="form-control-plaintext">Loading...</p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Expected Graduation</label>
                        <p id="displayGraduation" class="form-control-plaintext">Loading...</p>
                    </div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

    <!-- Campaign Management -->
    <div class="row p-5">
        <div class="col-12">
          <div class="card profile-card border-0 shadow mb-4">
            <div class="card-header title-container">
              <div class="d-flex justify-content-between align-items-center">
                  <h5 class="title-profile fw-bold mb-0 d-flex align-items-center">
                      <i class="bi bi-plus-circle me-2 fs-3"></i> Campaign Management
                  </h5>
                  <button class="btn btn-edit d-flex align-items-center" id="createCampaignButton">
                      <i class="bi bi-plus-lg me-1 fs-3"></i>
                  </button>
              </div>
            </div>
                <div class="card-body">
                    <div id="campaignsList">
                        <div class="text-center py-4">
                            <i class="bi bi-flag display-1 text-muted"></i>
                            <h5 class="mt-3">No campaigns yet</h5>
                            <p class="text-muted">Create your first campaign to start receiving support!</p>
                            <button class="btn btn-primary-custom" id="createFirstCampaignButton">
                                Create Your First Campaign
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- Edit Profile Modal -->
<div class="modal fade edit-modal" id="editProfileModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalTitle">Edit Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editProfileForm">
                    <div id="profileEditFields">
                        <!-- Dynamic fields will be loaded here -->
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary-custom" id="saveProfileChangesButton">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="d-none position-fixed top-50 start-50 translate-middle" style="z-index: 9999;">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Firebase Integration -->

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, collection, query, where, getDocs, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA6ocGvYKnwjc-xmW4j6he-CuTr4je3gko",
        authDomain: "fund-my-future-47844.firebaseapp.com",
        databaseURL: "https://fund-my-future-47844-default-rtdb.firebaseio.com",
        projectId: "fund-my-future-47844",
        storageBucket: "fund-my-future-47844.firebasestorage.app",
        messagingSenderId: "581912293895",
        appId: "1:581912293895:web:03468061fae2124ac770a2",
        measurementId: "G-LFC0R1GBE1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    let currentUser = null;
    let currentUserId = null;
    let editMode = null;

    // Initialize the dashboard
    document.addEventListener('DOMContentLoaded', function() {
        initializeDashboard();
    });

    async function initializeDashboard() {
        console.log('Initializing dashboard...');
        
        // Add event listeners with null checks
        const logoutButton = document.getElementById('logoutButton');
        if (logoutButton) {
            logoutButton.addEventListener('click', logout);
        }

        const editProfileButton = document.getElementById('editProfileButton');
        if (editProfileButton) {
            editProfileButton.addEventListener('click', () => openEditModal('profile'));
        }

        const editAcademicButton = document.getElementById('editAcademicButton');
        if (editAcademicButton) {
            editAcademicButton.addEventListener('click', () => openEditModal('academic'));
        }

        const changePhotoButton = document.getElementById('changePhotoButton');
        if (changePhotoButton) {
            changePhotoButton.addEventListener('click', changeProfilePicture);
        }

        const profilePictureOverlay = document.getElementById('profilePictureOverlay');
        if (profilePictureOverlay) {
            profilePictureOverlay.addEventListener('click', changeProfilePicture);
        }

        const createCampaignButton = document.getElementById('createCampaignButton');
        if (createCampaignButton) {
            createCampaignButton.addEventListener('click', createNewCampaign);
        }

        const createFirstCampaignButton = document.getElementById('createFirstCampaignButton');
        if (createFirstCampaignButton) {
            createFirstCampaignButton.addEventListener('click', createNewCampaign);
        }
        
        // Save button event listener - with null check and retry
        const saveButton = document.getElementById('saveProfileChangesButton');
        if (saveButton) {
            saveButton.addEventListener('click', saveProfileChanges);
            console.log('Save button event listener registered');
        } else {
            console.error('Save button not found!');
        }

        // Check authentication and load data
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                showLoading(true);
                await loadUserData(user.uid);
                showLoading(false);
            } else {
                window.location.href = 'login.html';
            }
        });
    }

    async function loadUserData(userId) {
        try {
            const userDoc = await getDoc(doc(db, "users", userId));
            if (userDoc.exists()) {
                currentUser = { id: userDoc.id, ...userDoc.data() };
                displayUserData(currentUser);
                await loadUserCampaigns(userId);
            } else {
                console.error("User document not found");
                showAlert('User data not found', 'danger');
            }
        } catch (error) {
            console.error("Error loading user data:", error);
            showAlert('Error loading user data', 'danger');
        }
    }

    function displayUserData(userData) {
        // Personal Information
        document.getElementById('welcomeName').textContent = `${userData.firstName || ''} ${userData.surname || ''}`;
        document.getElementById('displayFullName').textContent = `${userData.firstName || ''} ${userData.surname || ''}`;
        document.getElementById('displayEmail').textContent = userData.email || 'Not provided';
        document.getElementById('displayPhone').textContent = userData.phoneNumber || 'Not provided';
        
        // Date of Birth - Handle both Firestore Timestamp and Date objects
        if (userData.dateOfBirth) {
            let dobDate;
            if (userData.dateOfBirth.toDate) {
                dobDate = userData.dateOfBirth.toDate();
            } else if (userData.dateOfBirth instanceof Date) {
                dobDate = userData.dateOfBirth;
            } else {
                dobDate = new Date(userData.dateOfBirth);
            }
            document.getElementById('displayDOB').textContent = dobDate.toLocaleDateString();
        } else {
            document.getElementById('displayDOB').textContent = 'Not provided';
        }
        
        document.getElementById('displayID').textContent = userData.idNumber || 'Not provided';
        document.getElementById('displayLocation').textContent = userData.location || 'Not provided';

        // Academic Information
        document.getElementById('displayInstitution').textContent = userData.institution || 'Not provided';
        document.getElementById('displayCourse').textContent = userData.course || 'Not provided';
        document.getElementById('displayYear').textContent = userData.yearOfStudy || 'Not provided';
        document.getElementById('displayGraduation').textContent = userData.expectedGraduation || 'Not provided';

        // Profile Picture - Ensure profile picture is displayed
        if (userData.profilePicture) {
            document.getElementById('profileImage').src = userData.profilePicture;
        } else {
            document.getElementById('profileImage').src = './assets/profile-user.png';
        }
    }

    async function loadUserCampaigns(userId) {
        try {
            const campaignsQuery = query(
                collection(db, "campaigns"),
                where("studentId", "==", userId)
            );
            const querySnapshot = await getDocs(campaignsQuery);
            
            const campaignsList = document.getElementById('campaignsList');
            
            if (querySnapshot.empty) {
                campaignsList.innerHTML = `
                    <div class="text-center py-4">
                        <i class="bi bi-flag display-1 text-muted"></i>
                        <h5 class="mt-3">No campaigns yet</h5>
                        <p class="text-muted">Create your first campaign to start receiving support!</p>
                        <button class="btn btn-primary-custom" id="createFirstCampaignButton2">
                            Create Your First Campaign
                        </button>
                    </div>
                `;
                // Add event listener to the new button
                document.getElementById('createFirstCampaignButton2').addEventListener('click', createNewCampaign);
                return;
            }

            let campaignsHTML = '<div class="row">';
            querySnapshot.forEach((doc) => {
                const campaign = doc.data();
                const progressPercentage = campaign.goalAmount > 0 ? 
                    Math.min(100, Math.round((campaign.currentAmount / campaign.goalAmount) * 100)) : 0;
                    
                campaignsHTML += `
                    <div class="col-md-6 mb-4">
                        <div class="card h-100 campaign-card">
                            <div class="card-body">
                                <h5 class="card-title">${campaign.title || 'Untitled Campaign'}</h5>
                                <p class="card-text">${campaign.description || 'No description provided'}</p>
                                <div class="mb-2">
                                    <span class="badge bg-${campaign.status === 'active' ? 'success' : 'secondary'}">
                                        ${campaign.status || 'draft'}
                                    </span>
                                </div>
                                <div class="progress mb-2">
                                    <div class="progress-bar bg-success" role="progressbar" 
                                         style="width: ${progressPercentage}%"
                                         aria-valuenow="${progressPercentage}" 
                                         aria-valuemin="0" aria-valuemax="100">
                                    </div>
                                </div>
                                <p class="small text-muted">
                                    R${campaign.currentAmount || 0} raised of R${campaign.goalAmount || 0}
                                </p>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-primary flex-fill view-campaign-btn" data-campaign-id="${doc.id}">
                                        <i class="bi bi-eye me-1"></i>View
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary flex-fill edit-campaign-btn" data-campaign-id="${doc.id}">
                                        <i class="bi bi-pencil me-1"></i>Edit
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger flex-fill delete-campaign-btn" data-campaign-id="${doc.id}">
                                        <i class="bi bi-trash me-1"></i>Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            campaignsHTML += '</div>';
            campaignsList.innerHTML = campaignsHTML;

            // Add event listeners to campaign buttons
            document.querySelectorAll('.view-campaign-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const campaignId = e.target.closest('.view-campaign-btn').dataset.campaignId;
                    viewCampaign(campaignId);
                });
            });

            document.querySelectorAll('.edit-campaign-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const campaignId = e.target.closest('.edit-campaign-btn').dataset.campaignId;
                    editCampaign(campaignId);
                });
            });

            document.querySelectorAll('.delete-campaign-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const campaignId = e.target.closest('.delete-campaign-btn').dataset.campaignId;
                    deleteCampaign(campaignId);
                });
            });

        } catch (error) {
            console.error("Error loading campaigns:", error);
            showAlert('Error loading campaigns', 'danger');
        }
    }

    function openEditModal(mode) {
        editMode = mode;
        const modal = new bootstrap.Modal(document.getElementById('editProfileModal'));
        
        document.getElementById('editModalTitle').textContent = 
            mode === 'profile' ? 'Edit Personal Information' : 'Edit Academic Information';
        
        let formFields = '';
        
        if (mode === 'profile') {
            // Handle date format properly
            let dobValue = '';
            if (currentUser.dateOfBirth) {
                let dobDate;
                if (currentUser.dateOfBirth.toDate) {
                    dobDate = currentUser.dateOfBirth.toDate();
                } else if (currentUser.dateOfBirth instanceof Date) {
                    dobDate = currentUser.dateOfBirth;
                } else {
                    dobDate = new Date(currentUser.dateOfBirth);
                }
                dobValue = dobDate.toISOString().split('T')[0];
            }
            
            formFields = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">First Name *</label>
                            <input type="text" class="form-control" id="editFirstName" value="${currentUser.firstName || ''}" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Surname *</label>
                            <input type="text" class="form-control" id="editSurname" value="${currentUser.surname || ''}" required>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="editPhone" value="${currentUser.phoneNumber || ''}">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Date of Birth</label>
                            <input type="date" class="form-control" id="editDOB" value="${dobValue}">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">ID Number</label>
                            <input type="text" class="form-control" id="editID" value="${currentUser.idNumber || ''}">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Location</label>
                            <input type="text" class="form-control" id="editLocation" value="${currentUser.location || ''}">
                        </div>
                    </div>
                </div>
            `;
        } else {
            formFields = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Institution *</label>
                            <input type="text" class="form-control" id="editInstitution" value="${currentUser.institution || ''}" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Course/Program *</label>
                            <input type="text" class="form-control" id="editCourse" value="${currentUser.course || ''}" required>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Year of Study</label>
                            <input type="number" class="form-control" id="editYear" min="1" max="10" value="${currentUser.yearOfStudy || ''}">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Expected Graduation</label>
                            <input type="month" class="form-control" id="editGraduation" value="${currentUser.expectedGraduation || ''}">
                        </div>
                    </div>
                </div>
            `;
        }
        
        document.getElementById('profileEditFields').innerHTML = formFields;
        modal.show();
    }

    async function saveProfileChanges() {
        console.log('saveProfileChanges function called!');
        
        try {
            const form = document.getElementById('editProfileForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const updates = {};
            
            if (editMode === 'profile') {
                updates.firstName = document.getElementById('editFirstName').value.trim();
                updates.surname = document.getElementById('editSurname').value.trim();
                updates.phoneNumber = document.getElementById('editPhone').value.trim();
                
                const dobValue = document.getElementById('editDOB').value;
                if (dobValue) {
                    updates.dateOfBirth = new Date(dobValue);
                } else {
                    updates.dateOfBirth = null;
                }
                
                updates.idNumber = document.getElementById('editID').value.trim();
                updates.location = document.getElementById('editLocation').value.trim();
            } else {
                updates.institution = document.getElementById('editInstitution').value.trim();
                updates.course = document.getElementById('editCourse').value.trim();
                updates.yearOfStudy = document.getElementById('editYear').value;
                updates.expectedGraduation = document.getElementById('editGraduation').value;
            }
            
            updates.updatedAt = new Date();
            
            showLoading(true);
            await updateDoc(doc(db, "users", currentUserId), updates);
            
            // Update local data
            currentUser = { ...currentUser, ...updates };
            displayUserData(currentUser);
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editProfileModal'));
            modal.hide();
            showLoading(false);
            
            showAlert('Profile updated successfully!', 'success');
        } catch (error) {
            console.error("Error updating profile:", error);
            showLoading(false);
            showAlert('Error updating profile: ' + error.message, 'danger');
        }
    }

    async function changeProfilePicture() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        
        input.onchange = async (e) => {
            const file = e.target.files[0];
            if (file) {
                if (!file.type.startsWith('image/')) {
                    showAlert('Please select an image file', 'warning');
                    return;
                }
                
                if (file.size > 5 * 1024 * 1024) {
                    showAlert('Image size should be less than 5MB', 'warning');
                    return;
                }
                
                try {
                    showLoading(true);
                    
                    // Use simple path format that will work with basic storage rules
                    const timestamp = Date.now();
                    const fileExtension = file.name.split('.').pop();
                    
                    // Use this simple path format
                    const storageRef = ref(storage, `profile-pictures/${currentUserId}_${timestamp}.${fileExtension}`);
                    
                    console.log('Uploading to:', storageRef.fullPath);
                    
                    const snapshot = await uploadBytes(storageRef, file);
                    const downloadURL = await getDownloadURL(snapshot.ref);
                    
                    await updateDoc(doc(db, "users", currentUserId), {
                        profilePicture: downloadURL,
                        updatedAt: new Date()
                    });
                    
                    document.getElementById('profileImage').src = downloadURL;
                    currentUser.profilePicture = downloadURL;
                    showLoading(false);
                    
                    showAlert('Profile picture updated successfully!', 'success');
                } catch (error) {
                    console.error("Error uploading profile picture:", error);
                    showLoading(false);
                    showAlert('Error updating profile picture: ' + error.message, 'danger');
                }
            }
        };
        
        input.click();
    }

    function createNewCampaign() {
        window.location.href = 'campaign.html';
    }

    function viewCampaign(campaignId) {
        window.location.href = `view-campaign.html?id=${campaignId}`;
    }

    function editCampaign(campaignId) {
        window.location.href = `edit-campaign.html?id=${campaignId}`;
    }

    async function deleteCampaign(campaignId) {
        if (confirm('Are you sure you want to delete this campaign? This action cannot be undone.')) {
            try {
                showLoading(true);
                await deleteDoc(doc(db, "campaigns", campaignId));
                showLoading(false);
                showAlert('Campaign deleted successfully!', 'success');
                await loadUserCampaigns(currentUserId);
            } catch (error) {
                console.error("Error deleting campaign:", error);
                showLoading(false);
                showAlert('Error deleting campaign', 'danger');
            }
        }
    }

    async function logout() {
        try {
            await signOut(auth);
            sessionStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        } catch (error) {
            console.error("Error signing out:", error);
        }
    }

    function showAlert(message, type) {
        // Remove any existing alerts
        const existingAlerts = document.querySelectorAll('.alert-fixed');
        existingAlerts.forEach(alert => alert.remove());
        
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show alert-fixed`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);
        
        // Auto dismiss after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }

    function showLoading(show) {
        const spinner = document.getElementById('loadingSpinner');
        if (show) {
            spinner.classList.remove('d-none');
        } else {
            spinner.classList.add('d-none');
        }
    }

    // Make functions globally available
    window.saveProfileChanges = saveProfileChanges;
    window.logout = logout;
    window.openEditModal = openEditModal;
    window.changeProfilePicture = changeProfilePicture;
    window.createNewCampaign = createNewCampaign;
    window.viewCampaign = viewCampaign;
    window.editCampaign = editCampaign;
    window.deleteCampaign = deleteCampaign;
</script>
</body>
</html>