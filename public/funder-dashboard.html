<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Funder Dashboard - FundMyFuture</title>

<!-- External Scripts -->
<!-- Newsletter subscription functionality -->
<script src="./js/newsletter.js"></script>

<!-- External Libraries -->
<!-- Bootstrap CSS for responsive design and UI components -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Font Awesome for icons -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<!-- Bootstrap Icons for additional icon set -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

<!-- Custom global stylesheet -->
<link rel="stylesheet" href="./css/styles.css">

<style>
/* Custom styles for the Funder Dashboard */

/* Global body styling */
body { overflow-x: hidden; }

/* Dashboard header styling */
.dashboard-header { 
    background-color: #2A6F97; 
    padding: 30px 0; 
}

/* Profile card styling with brand colors */
.profile-card { 
    background-color: #A9D6E5; 
}

/* Custom primary button styling */
.btn-primary-custom { 
    background-color: #012A4A; 
    color: #A9D6E5; 
}
.btn-primary-custom:hover { 
    background-color: #2A6F97; 
    color: #012A4A; 
}

/* Profile information title container */
.title-container {
    background-color: #012A4A;
    color: #A9D6E5;
    padding: 5px;
    border-radius: 5px;
}

/* Edit modal styling */
.edit-modal .modal-content {
    background-color: #A9D6E5;
    border: 3px solid #012A4A;
}
.edit-modal .form-label {
    color: #012A4A;
    font-weight: bold;
}

/* Edit button styling for profile section */
.btn-edit {
    background: none;
    border: none;
    color: #A9D6E5;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-edit:hover {
    color: #ffd60a;
    transform: scale(1.02);
}

/* Change profile picture button styling */
.btn-change-photo {
    background-color: #012A4A;
    color: #A9D6E5;
    transition: all 0.3s ease;
}

.btn-change-photo:hover {
    background-color: #ffd60a;
    color: #012A4A;
    transform: scale(1.02);
}

/* Statistics card styling with accent border */
.stat-card {
    border-left: 4px solid #2A6F97;
}

/* Campaign card styling */
.campaign-card {
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    transition: transform 0.2s;
    margin-bottom: 20px;
    border: none;
}

/* Donation button styling */
.btn-donate {
    background-color: #ffda1f;
    color: #012A4A;
    font-weight: 700;
    border: none;
    transition: all 0.3s ease;
}
.btn-donate:hover {
    background-color: #e0b000;
    color: #012A4A;
    transform: translateY(-2px);
}

/* View all button styling */
.btn-view-all {
    background-color: #012A4A;
    color: #A9D6E5;
    font-weight: 700;
    border: none;
    transition: all 0.3s ease;
}
.btn-view-all:hover {
    background-color: #2A6F97;
    color: white;
}

/* Section title styling */
.section-title {
    background-color: #012A4A;
    color: #A9D6E5;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
}

/* Recent donation item styling */
.recent-donation-item {
    border-left: 4px solid #2A6F97;
    padding-left: 15px;
    margin-bottom: 15px;
}

/* Campaign image styling */
.campaign-image {
    height: 200px;
    object-fit: cover;
    border-radius: 10px 10px 0 0;
}

/* Progress bar styling */
.progress {
    height: 10px;
    background-color: #e9ecef;
}
.progress-bar {
    background-color: #2A6F97;
}

/* Fixed alert positioning */
.alert-fixed {
    position: fixed;
    top: 100px;
    right: 20px;
    z-index: 9999;
    min-width: 300px;
}

/* Loading spinner styling */
#loadingSpinner {
    z-index: 9999;
}

/* User profile section styling */
.dashboard-profile-title {
    background-color: #012A4A;
}

/* Success animation for updated fields */
.text-success {
    transition: color 0.5s ease;
}

/* Form validation styles */
.is-valid {
    border-color: #198754;
}

.is-invalid {
    border-color: #dc3545;
}

.invalid-feedback {
    display: none;
    width: 100%;
    margin-top: 0.25rem;
    font-size: 0.875em;
    color: #dc3545;
}

.was-validated .form-control:invalid ~ .invalid-feedback,
.form-control.is-invalid ~ .invalid-feedback {
    display: block;
}

/* Profile update success animation */
.profile-update-success {
    animation: highlightUpdate 2s ease;
}

@keyframes highlightUpdate {
    0% { background-color: #d4edda; }
    100% { background-color: transparent; }
}
</style>
</head>

<body>
<!-- Navigation Bar -->
<nav class="navbar navbar-expand-lg navbar-custom px-3">
    <div class="container-fluid">
        <a class="navbar-brand ms-2 text-white fw-bold" href="index.html">FundMyFuture</a>
        <div class="navbar-nav ms-auto">
            <!-- Logout button -->
            <button class="btn login-btn fw-bolder text-white" onclick="logout()">LOGOUT</button>
        </div>
    </div>
</nav>

<!-- Dashboard Header Section -->
<div class="container-fluid dashboard-header">
    <div class="container">
        <h1 class="text-white fw-bold">Funder Dashboard</h1>
        <p class="text-white-50">Welcome back, <span id="welcomeName">Funder</span>!</p>
    </div>
</div>

<!-- Loading Spinner: Displayed during data loading operations -->
<div id="loadingSpinner" class="d-none position-fixed top-50 start-50 translate-middle" style="z-index: 9999;">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<!-- Main Dashboard Content -->
<div class="container my-5">
    <!-- Profile Section -->
    <div class="row">
        <div class="col-12">
            <!-- Profile Card: Contains all user information -->
            <div class="card profile-card shadow border-0 rounded mb-4">
                <!-- Profile Card Header -->
                <div class="card-header title-container">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="title-profile fw-bold mb-0 d-flex align-items-center">
                            <i class="bi bi-person-badge me-2 fs-3"></i> Profile Information
                        </h5>
                        <!-- Edit Profile Button -->
                        <button class="btn btn-edit d-flex align-items-center" onclick="openEditModal('profile')">
                            <i class="bi bi-pencil me-1 fs-3"></i>
                        </button>
                    </div>
                </div>

                <!-- Profile Card Body -->
                <div class="card-body p-4">
                    <div class="row">
                        <!-- Profile Picture Section -->
                        <div class="col-md-3 text-center mb-4">
                            <div class="mb-3">
                                <img id="profileImage" src="./assets/profile-user.png" 
                                    class="rounded-circle img-thumbnail shadow" 
                                    style="width: 140px; height: 140px; object-fit: cover;" 
                                    alt="Profile">
                            </div>

                            <!-- Change Profile Photo Button -->
                            <button class="btn btn-change-photo" onclick="changeProfilePicture()">
                                <i class="bi bi-camera-fill me-2"></i>Change Photo
                            </button>
                        </div>

                        <!-- User Information Display -->
                        <div class="col-md-9">
                            <div class="row">
                                <div class="col-md-6">
                                    <dl class="row">
                                        <dt class="col-sm-4 text-muted fw-light mb-3">Full Name</dt>
                                        <dd class="col-sm-8 fw-bold mb-3 text-break" id="displayFullName">Loading...</dd>
                                        
                                        <dt class="col-sm-4 text-muted fw-light mb-3">Email</dt>
                                        <dd class="col-sm-8 fw-bold mb-3 text-break" id="displayEmail">Loading...</dd>
                                        
                                        <dt class="col-sm-4 text-muted fw-light mb-3">Phone</dt>
                                        <dd class="col-sm-8 fw-bold mb-3 text-break" id="displayPhone">Loading...</dd>
                                    </dl>
                                </div>
                                <div class="col-md-6">
                                    <dl class="row">
                                        <dt class="col-sm-4 text-muted fw-light mb-3">Organization</dt>
                                        <dd class="col-sm-8 fw-bold mb-3 text-break" id="displayOrganization">Loading...</dd>
                                        
                                        <dt class="col-sm-4 text-muted fw-light mb-3">Location</dt>
                                        <dd class="col-sm-8 fw-bold mb-3 text-break" id="displayLocation">Loading...</dd>
                                        
                                        <dt class="col-sm-4 text-muted fw-light mb-3">Member Since</dt>
                                        <dd class="col-sm-8 fw-bold mb-3 text-break" id="displayMemberSince">Loading...</dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard Layout -->
    <div class="row">
        <!-- Quick Stats Overview - Left Sidebar -->
        <div class="col-lg-2 mb-4">
            <div class="d-flex flex-column">
                <!-- Total Donated Stat Card -->
                <div class="stat-card shadow rounded p-4 mb-3">
                    <h6>Total Donated</h6>
                    <h4 id="totalDonated">R0</h4>
                </div>
                <!-- Campaigns Supported Stat Card -->
                <div class="stat-card shadow rounded p-4 mb-3">
                    <h6>Campaigns Supported</h6>
                    <h4 id="campaignsSupported">0</h4>
                </div>
                <!-- Students Helped Stat Card -->
                <div class="stat-card shadow rounded p-4 mb-3">
                    <h6>Students Helped</h6>
                    <h4 id="studentsHelped">0</h4>
                </div>
                <!-- Last Donation Stat Card -->
                <div class="stat-card shadow rounded p-4">
                    <h6>Last Donation</h6>
                    <h4 id="lastDonation">-</h4>
                </div>
            </div>
        </div>
        
        <!-- Main Content Area -->
        <div class="col-lg-10">
            <!-- Dashboard Tabs Navigation -->
            <div class="dashboard-tabs">
                <ul class="nav nav-tabs">
                    <li class="nav-item">
                        <a class="nav-link active" href="#overview" data-bs-toggle="tab">
                            <i class="bi bi-house"></i> Overview
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#donations" data-bs-toggle="tab">
                            <i class="bi bi-gift"></i> My Donations
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#saved" data-bs-toggle="tab">
                            <i class="bi bi-bookmark"></i> Saved Campaigns
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#profile" data-bs-toggle="tab">
                            <i class="bi bi-person"></i> Profile
                        </a>
                    </li>
                </ul>

                <!-- Tab Content Panels -->
                <div class="tab-content p-3">
                    <!-- Overview Tab: Main dashboard view -->
                    <div class="tab-pane fade show active" id="overview">
                        <div class="row">
                            <!-- Featured Campaigns Section -->
                            <div class="col-lg-8">
                                <div class="section-title">
                                    <h4 class="fw-bold mb-0"><i class="fas fa-star me-2"></i>Featured Campaigns</h4>
                                </div>

                                <div class="row" id="featuredCampaigns">
                                    <!-- Campaigns will be loaded dynamically -->
                                </div>

                                <div class="text-center mt-4">
                                    <button class="btn btn-view-all" onclick="browseAllCampaigns()">
                                        <i class="fas fa-search me-2"></i>Browse All Campaigns
                                    </button>
                                </div>

                                <!-- Recent Donations Section -->
                                <div class="mt-5">
                                    <div class="section-title">
                                        <h4 class="fw-bold mb-0"><i class="fas fa-history me-2"></i>Your Recent Donations</h4>
                                    </div>

                                    <div id="recentDonations">
                                        <!-- Recent donations will be loaded dynamically -->
                                    </div>
                                </div>
                            </div>

                            <!-- Right Column: Quick Actions & Updates -->
                            <div class="col-lg-4">
                                <!-- Quick Actions Section -->
                                <div class="section-title">
                                    <h4 class="fw-bold mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h4>
                                </div>

                                <div class="card campaign-card mb-4">
                                    <div class="card-body">
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-view-all mb-2" onclick="viewSavedCampaigns()">
                                                <i class="fas fa-bookmark me-2"></i>View Saved Campaigns
                                            </button>
                                            <button class="btn btn-view-all" onclick="updatePaymentMethod()">
                                                <i class="fas fa-credit-card me-2"></i>Update Payment Method
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Campaign Updates Section -->
                                <div class="section-title">
                                    <h4 class="fw-bold mb-0"><i class="fas fa-bell me-2"></i>Campaign Updates</h4>
                                </div>

                                <div id="campaignUpdates">
                                    <!-- Updates will be loaded dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Donations Tab: Donation history and statistics -->
                    <div class="tab-pane fade" id="donations">
                        <h4 class="mb-4">Your Donation History</h4>
                        
                        <!-- Donation Statistics Cards -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="text-center">
                                        <div class="stat-number" id="totalDonationsCount">0</div>
                                        <div class="stat-label">Total Donations</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="text-center">
                                        <div class="stat-number" id="largestDonation">R0</div>
                                        <div class="stat-label">Largest Donation</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="text-center">
                                        <div class="stat-number" id="avgDonation">R0</div>
                                        <div class="stat-label">Average Donation</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="text-center">
                                        <div class="stat-number" id="monthlyTotal">R0</div>
                                        <div class="stat-label">This Month</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Detailed Donations List -->
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title mb-4">Recent Donations</h5>
                                <div id="detailedDonationsList">
                                    <!-- Detailed donations will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Saved Campaigns Tab: Bookmarked campaigns -->
                    <div class="tab-pane fade" id="saved">
                        <h4 class="mb-4">Your Saved Campaigns</h4>
                        <div class="row" id="savedCampaignsList">
                            <!-- Saved campaigns will be loaded dynamically -->
                        </div>
                    </div>

                    <!-- Profile Tab: Detailed profile information and settings -->
                    <div class="tab-pane fade" id="profile">
                        <!-- Enhanced Profile Information -->
                        <div class="row">
                            <div class="col-md-8">
                                <div class="card profile-info mb-4">
                                    <div class="card-body">
                                        <h4 class="card-title fw-bold mb-4">Profile Details</h4>
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">First Name</label>
                                                    <p id="profileFirstName" class="form-control-plaintext">Loading...</p>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">Email</label>
                                                    <p id="profileEmail" class="form-control-plaintext">Loading...</p>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">ID Number</label>
                                                    <p id="profileID" class="form-control-plaintext">Loading...</p>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">Surname</label>
                                                    <p id="profileSurname" class="form-control-plaintext">Loading...</p>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">Phone</label>
                                                    <p id="profilePhone" class="form-control-plaintext">Loading...</p>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">Location</label>
                                                    <p id="profileLocation" class="form-control-plaintext">Loading...</p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-4">
                                            <button class="btn btn-primary-custom" onclick="openEditModal('profile')">
                                                <i class="bi bi-pencil-square me-2"></i>Edit Profile
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Profile Picture Section -->
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <img id="profileTabImage" src="./assets/profile-user.png" 
                                             class="img-fluid rounded-circle mb-3" 
                                             style="width: 120px; height: 120px; object-fit: cover;" 
                                             alt="Profile Picture">
                                        <h5 id="profileTabName" class="fw-bold">Loading...</h5>
                                        <p class="text-muted">Funder</p>
                                        <button class="btn btn-sm btn-outline-primary" onclick="changeProfilePicture()">
                                            Change Photo
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Methods Section -->
                        <div class="card mb-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0"><i class="bi bi-credit-card me-2"></i> Payment Methods</h5>
                            </div>
                            <div class="card-body">
                                <div id="paymentMethodsList">
                                    <!-- Payment methods will be loaded here -->
                                </div>
                                <button class="btn btn-donate mt-3" onclick="addPaymentMethod()">
                                    <i class="bi bi-plus-circle me-2"></i>Add Payment Method
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Profile Modal: For updating user profile information -->
<div class="modal fade edit-modal" id="editProfileModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalTitle">Edit Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editProfileForm">
                    <div id="profileEditFields">
                        <!-- Dynamic fields will be loaded here -->
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary-custom" onclick="saveProfileChanges()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Payment Method Modal: For adding new payment methods -->
<div class="modal fade" id="paymentMethodModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Payment Method</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="paymentMethodForm">
                    <div class="mb-3">
                        <label class="form-label">Card Number</label>
                        <input type="text" class="form-control" id="cardNumber" placeholder="1234 5678 9012 3456" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Expiry Date</label>
                                <input type="text" class="form-control" id="expiryDate" placeholder="MM/YY" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">CVV</label>
                                <input type="text" class="form-control" id="cvv" placeholder="123" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Cardholder Name</label>
                        <input type="text" class="form-control" id="cardholderName" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary-custom" onclick="savePaymentMethod()">Save Payment Method</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Firebase Integration -->
<script type="module">
    // Firebase SDK imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { 
        getFirestore, doc, getDoc, updateDoc, collection, query, where, getDocs, 
        addDoc, deleteDoc, orderBy, limit, serverTimestamp, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    // Firebase configuration object
    const firebaseConfig = {
        apiKey: "AIzaSyA6ocGvYKnwjc-xmW4j6he-CuTr4je3gko",
        authDomain: "fund-my-future-47844.firebaseapp.com",
        databaseURL: "https://fund-my-future-47844-default-rtdb.firebaseio.com",
        projectId: "fund-my-future-47844",
        storageBucket: "fund-my-future-47844.firebasestorage.app",
        messagingSenderId: "581912293895",
        appId: "1:581912293895:web:03468061fae2124ac770a2",
        measurementId: "G-LFC0R1GBE1"
    };

    // Initialize Firebase services
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Global variables for current user state
    let currentFunder = null;
    let currentFunderId = null;
    let editMode = null;

    /**
     * Authentication state observer - redirects to login if not authenticated
     * @param {Object} user - Firebase user object
     */
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentFunderId = user.uid;
            console.log("Funder logged in:", user.uid);
            showLoading(true);
            await loadFunderData(user.uid);
            setupProfileListener(user.uid); // Add real-time listener
            showLoading(false);
        } else {
            console.log("No user logged in - redirecting to login");
            window.location.href = "login.html";
        }
    });

    /**
     * Sets up real-time listener for profile updates
     * @param {string} userId - The user ID to listen for
     */
    function setupProfileListener(userId) {
        const userDocRef = doc(db, "users", userId);
        
        // Set up real-time listener for profile changes
        onSnapshot(userDocRef, (docSnapshot) => {
            if (docSnapshot.exists()) {
                const updatedData = docSnapshot.data();
                currentFunder = { id: docSnapshot.id, ...updatedData };
                refreshProfileDisplay();
                console.log("Profile data updated in real-time");
            }
        }, (error) => {
            console.error("Error in profile listener:", error);
        });
    }

    /**
     * Loads all funder data including profile, statistics, and dashboard content
     * @param {string} userId - The user ID to load data for
     */
    async function loadFunderData(userId) {
        try {
            const userDoc = await getDoc(doc(db, "users", userId));
            if (userDoc.exists()) {
                currentFunder = { id: userDoc.id, ...userDoc.data() };
                displayFunderData(currentFunder);
                await loadFunderStatistics(userId);
                await loadFeaturedCampaigns();
                await loadRecentDonations(userId);
                await loadCampaignUpdates(userId);
                await loadSavedCampaigns(userId);
                await loadPaymentMethods(userId);
            } else {
                console.error("Funder document not found");
                showAlert('Funder data not found', 'danger');
            }
        } catch (error) {
            console.error("Error loading funder data:", error);
            showAlert('Error loading funder data', 'danger');
        }
    }

    /**
     * Displays funder data in the UI
     * @param {Object} funderData - The funder data object
     */
    function displayFunderData(funderData) {
        // Personal Information
        document.getElementById('welcomeName').textContent = `${funderData.firstName} ${funderData.surname}`;
        document.getElementById('displayFullName').textContent = `${funderData.firstName} ${funderData.surname}`;
        document.getElementById('displayEmail').textContent = funderData.email || 'Not provided';
        document.getElementById('displayPhone').textContent = funderData.phoneNumber || 'Not provided';
        document.getElementById('displayOrganization').textContent = funderData.organization || 'Individual';
        document.getElementById('displayLocation').textContent = funderData.location || 'Not provided';
        
        // Member since date formatting
        if (funderData.createdAt) {
            const memberSince = funderData.createdAt.toDate ? 
                funderData.createdAt.toDate() : new Date(funderData.createdAt);
            document.getElementById('displayMemberSince').textContent = 
                memberSince.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
        }

        // Profile tab data
        document.getElementById('profileFirstName').textContent = funderData.firstName || 'Not provided';
        document.getElementById('profileSurname').textContent = funderData.surname || 'Not provided';
        document.getElementById('profileEmail').textContent = funderData.email || 'Not provided';
        document.getElementById('profilePhone').textContent = funderData.phoneNumber || 'Not provided';
        document.getElementById('profileID').textContent = funderData.idNumber || 'Not provided';
        document.getElementById('profileLocation').textContent = funderData.location || 'Not provided';
        document.getElementById('profileTabName').textContent = `${funderData.firstName} ${funderData.surname}`;

        // Profile Picture - FIXED: Ensure profile picture is displayed
        if (funderData.profilePicture) {
            document.getElementById('profileImage').src = funderData.profilePicture;
            document.getElementById('profileTabImage').src = funderData.profilePicture;
        } else {
            document.getElementById('profileImage').src = './assets/profile-user.png';
            document.getElementById('profileTabImage').src = './assets/profile-user.png';
        }
    }

    /**
     * Refreshes all profile displays with current data
     */
    function refreshProfileDisplay() {
        if (!currentFunder) return;
        
        // Update main profile card
        document.getElementById('welcomeName').textContent = `${currentFunder.firstName} ${currentFunder.surname}`;
        document.getElementById('displayFullName').textContent = `${currentFunder.firstName} ${currentFunder.surname}`;
        document.getElementById('displayEmail').textContent = currentFunder.email || 'Not provided';
        document.getElementById('displayPhone').textContent = currentFunder.phoneNumber || 'Not provided';
        document.getElementById('displayOrganization').textContent = currentFunder.organization || 'Individual';
        document.getElementById('displayLocation').textContent = currentFunder.location || 'Not provided';
        
        // Update profile tab
        document.getElementById('profileFirstName').textContent = currentFunder.firstName || 'Not provided';
        document.getElementById('profileSurname').textContent = currentFunder.surname || 'Not provided';
        document.getElementById('profileEmail').textContent = currentFunder.email || 'Not provided';
        document.getElementById('profilePhone').textContent = currentFunder.phoneNumber || 'Not provided';
        document.getElementById('profileID').textContent = currentFunder.idNumber || 'Not provided';
        document.getElementById('profileLocation').textContent = currentFunder.location || 'Not provided';
        document.getElementById('profileTabName').textContent = `${currentFunder.firstName} ${currentFunder.surname}`;
        
        // Update profile pictures if they exist
        if (currentFunder.profilePicture) {
            document.getElementById('profileImage').src = currentFunder.profilePicture;
            document.getElementById('profileTabImage').src = currentFunder.profilePicture;
        }
    }

    /**
     * Loads and calculates funder statistics from donations
     * @param {string} userId - The user ID to load statistics for
     */
    async function loadFunderStatistics(userId) {
        try {
            const donationsQuery = query(
                collection(db, "donations"),
                where("funderId", "==", userId),
                where("paymentStatus", "==", "completed")
            );
            
            const donationsSnapshot = await getDocs(donationsQuery);
            
            let totalDonated = 0;
            let campaignsSupported = new Set();
            let studentsHelped = new Set();
            let lastDonationDate = null;
            let donationCount = 0;
            let largestDonation = 0;
            let currentMonthTotal = 0;
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            // Process each donation
            for (const doc of donationsSnapshot.docs) {
                const donation = doc.data();
                const amount = donation.amount || 0;
                
                totalDonated += amount;
                donationCount++;
                campaignsSupported.add(donation.campaignId);
                
                if (amount > largestDonation) {
                    largestDonation = amount;
                }
                
                // Get student ID from campaign
                if (donation.campaignId) {
                    const studentId = await getStudentFromCampaign(donation.campaignId);
                    if (studentId) {
                        studentsHelped.add(studentId);
                    }
                }
                
                // Track last donation date
                if (donation.createdAt) {
                    const donationDate = donation.createdAt.toDate();
                    if (!lastDonationDate || donationDate > lastDonationDate) {
                        lastDonationDate = donationDate;
                    }
                    
                    // Check if donation was this month
                    if (donationDate.getMonth() === currentMonth && donationDate.getFullYear() === currentYear) {
                        currentMonthTotal += amount;
                    }
                }
            }

            const avgDonation = donationCount > 0 ? totalDonated / donationCount : 0;

            // Update statistics in UI
            document.getElementById('totalDonated').textContent = `R${totalDonated.toLocaleString()}`;
            document.getElementById('campaignsSupported').textContent = campaignsSupported.size;
            document.getElementById('studentsHelped').textContent = studentsHelped.size;
            
            if (lastDonationDate) {
                document.getElementById('lastDonation').textContent = lastDonationDate.toLocaleDateString();
            }

            // Update detailed donation stats
            document.getElementById('totalDonationsCount').textContent = donationCount;
            document.getElementById('largestDonation').textContent = `R${largestDonation.toLocaleString()}`;
            document.getElementById('avgDonation').textContent = `R${avgDonation.toFixed(0)}`;
            document.getElementById('monthlyTotal').textContent = `R${currentMonthTotal.toLocaleString()}`;
            
        } catch (error) {
            console.error("Error loading funder statistics:", errov);
        }
    }

    /**
     * Gets student ID from a campaign document
     * @param {string} campaignId - The campaign ID to look up
     * @returns {string|null} - Student ID or null if not found
     */
    async function getStudentFromCampaign(campaignId) {
        try {
            const campaignDoc = await getDoc(doc(db, "campaigns", campaignId));
            if (campaignDoc.exists()) {
                return campaignDoc.data().studentId;
            }
        } catch (error) {
            console.error("Error getting student from campaign:", error);
        }
        return null;
    }

    /**
     * Loads featured campaigns for display on dashboard
     */
    async function loadFeaturedCampaigns() {
        try {
            const campaignsQuery = query(
                collection(db, "campaigns"),
                where("status", "==", "active"),
                orderBy("createdAt", "desc"),
                limit(4)
            );
            
            const campaignsSnapshot = await getDocs(campaignsQuery);
            const campaignsContainer = document.getElementById('featuredCampaigns');
            
            if (!campaignsSnapshot.empty) {
                campaignsContainer.innerHTML = '';
                
                for (const doc of campaignsSnapshot.docs) {
                    const campaign = doc.data();
                    await createCampaignCard(campaign, doc.id, campaignsContainer, false);
                }
            } else {
                campaignsContainer.innerHTML = `
                    <div class="col-12 text-center py-4">
                        <p class="text-muted">No active campaigns found.</p>
                    </div>
                `;
            }
            
        } catch (error) {
            console.error("Error loading featured campaigns:", error);
        }
    }

    /**
     * Creates a campaign card element
     * @param {Object} campaign - Campaign data object
     * @param {string} campaignId - Campaign document ID
     * @param {HTMLElement} container - Container to append the card to
     * @param {boolean} showSaveButton - Whether to show save button
     */
    async function createCampaignCard(campaign, campaignId, container, showSaveButton = true) {
        // Get student name
        let studentName = 'Student';
        if (campaign.studentId) {
            const studentDoc = await getDoc(doc(db, "users", campaign.studentId));
            if (studentDoc.exists()) {
                const studentData = studentDoc.data();
                studentName = `${studentData.firstName} ${studentData.surname}`;
            }
        }

        const currentAmount = campaign.currentAmount || 0;
        const goalAmount = campaign.goalAmount || 1;
        const progressPercentage = Math.min(100, ((currentAmount / goalAmount) * 100)).toFixed(0);

        const campaignCard = document.createElement('div');
        campaignCard.className = 'col-md-6 mb-4';
        campaignCard.innerHTML = `
            <div class="card campaign-card">
                <img src="${campaign.coverImage || campaign.imageUrl || './assets/pexels-kaiariel-3563697.jpg'}" 
                     class="card-img-top campaign-image" 
                     style="height: 200px; object-fit: cover;"
                     alt="${campaign.title}">
                <div class="card-body">
                    <h5 class="card-title fw-bold">${campaign.title}</h5>
                    <p class="card-text text-muted">${campaign.description || 'Support this student\'s educational journey.'}</p>
                    <p class="small text-muted mb-2">By: ${studentName}</p>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small class="text-muted">Raised: R${currentAmount.toLocaleString()}</small>
                            <small class="text-muted">Goal: R${goalAmount.toLocaleString()}</small>
                        </div>
                        <div class="progress">
                            <div class="progress-bar" style="width: ${progressPercentage}%"></div>
                        </div>
                        <small class="text-muted">${progressPercentage}% funded</small>
                    </div>

                    <div class="d-flex justify-content-between align-items-center">
                        <span class="badge bg-success">Active</span>
                        <div>
                            ${showSaveButton ? `
                                <button class="btn btn-sm btn-outline-primary me-2" onclick="saveCampaign('${campaignId}')">
                                    <i class="bi bi-bookmark"></i>
                                </button>
                            ` : ''}
                            <button class="btn btn-donate" onclick="donateToCampaign('${campaignId}')">Donate Now</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        container.appendChild(campaignCard);
    }

    /**
     * Loads recent donations for the current funder
     * @param {string} userId - The user ID to load donations for
     */
    async function loadRecentDonations(userId) {
        try {
            const donationsQuery = query(
                collection(db, "donations"),
                where("funderId", "==", userId),
                orderBy("createdAt", "desc"),
                limit(5)
            );
            
            const donationsSnapshot = await getDocs(donationsQuery);
            const donationsContainer = document.getElementById('recentDonations');
            const detailedContainer = document.getElementById('detailedDonationsList');
            
            if (!donationsSnapshot.empty) {
                donationsContainer.innerHTML = '';
                detailedContainer.innerHTML = '';
                
                for (const doc of donationsSnapshot.docs) {
                    const donation = doc.data();
                    await createDonationItem(donation, donationsContainer);
                    await createDetailedDonationItem(donation, detailedContainer);
                }
            } else {
                donationsContainer.innerHTML = `
                    <div class="text-center py-4">
                        <p class="text-muted">No donations yet.</p>
                        <button class="btn btn-donate" onclick="browseAllCampaigns()">Make Your First Donation</button>
                    </div>
                `;
                detailedContainer.innerHTML = `
                    <div class="text-center py-4">
                        <p class="text-muted">No donation history available.</p>
                    </div>
                `;
            }
            
        } catch (error) {
            console.error("Error loading recent donations:", error);
        }
    }

    /**
     * Creates a donation item for the recent donations list
     * @param {Object} donation - Donation data object
     * @param {HTMLElement} container - Container to append the item to
     */
    async function createDonationItem(donation, container) {
        let campaignTitle = 'Campaign';
        if (donation.campaignId) {
            const campaignDoc = await getDoc(doc(db, "campaigns", donation.campaignId));
            if (campaignDoc.exists()) {
                campaignTitle = campaignDoc.data().title;
            }
        }

        const donationDate = donation.createdAt?.toDate().toLocaleDateString() || 'Unknown date';

        const donationItem = document.createElement('div');
        donationItem.className = 'recent-donation-item';
        donationItem.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h6 class="fw-bold mb-1">${campaignTitle}</h6>
                    <p class="text-muted mb-1">Donated: R${donation.amount?.toLocaleString() || '0'}</p>
                    <small class="text-muted">${donationDate}</small>
                </div>
                <span class="badge bg-success">Completed</span>
            </div>
        `;
        
        container.appendChild(donationItem);
    }

    /**
     * Creates a detailed donation item for the donations tab
     * @param {Object} donation - Donation data object
     * @param {HTMLElement} container - Container to append the item to
     */
    async function createDetailedDonationItem(donation, container) {
        let campaignTitle = 'Campaign';
        let studentName = 'Student';
        
        if (donation.campaignId) {
            const campaignDoc = await getDoc(doc(db, "campaigns", donation.campaignId));
            if (campaignDoc.exists()) {
                const campaignData = campaignDoc.data();
                campaignTitle = campaignData.title;
                
                // Get student name
                if (campaignData.studentId) {
                    const studentDoc = await getDoc(doc(db, "users", campaignData.studentId));
                    if (studentDoc.exists()) {
                        const studentData = studentDoc.data();
                        studentName = `${studentData.firstName} ${studentData.surname}`;
                    }
                }
            }
        }

        const donationDate = donation.createdAt?.toDate().toLocaleDateString() || 'Unknown date';

        const donationItem = document.createElement('div');
        donationItem.className = 'border-bottom pb-3 mb-3';
        donationItem.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6 class="fw-bold">${campaignTitle}</h6>
                    <p class="text-muted mb-1">Student: ${studentName}</p>
                </div>
                <div class="col-md-3">
                    <p class="fw-bold text-primary">R${donation.amount?.toLocaleString() || '0'}</p>
                </div>
                <div class="col-md-3">
                    <small class="text-muted">${donationDate}</small>
                    <span class="badge bg-success d-block mt-1">Completed</span>
                </div>
            </div>
        `;
        
        container.appendChild(donationItem);
    }

    /**
     * Loads campaign updates for campaigns the funder has donated to
     * @param {string} userId - The user ID to load updates for
     */
    async function loadCampaignUpdates(userId) {
        try {
            // Get campaigns that the funder has donated to
            const donationsQuery = query(
                collection(db, "donations"),
                where("funderId", "==", userId),
                where("paymentStatus", "==", "completed")
            );
            
            const donationsSnapshot = await getDocs(donationsQuery);
            const campaignIds = new Set();
            
            donationsSnapshot.forEach(doc => {
                campaignIds.add(doc.data().campaignId);
            });

            // Get updates from these campaigns
            const updatesContainer = document.getElementById('campaignUpdates');
            updatesContainer.innerHTML = '';
            
            let updatesLoaded = 0;
            for (const campaignId of campaignIds) {
                if (campaignId && updatesLoaded < 3) {
                    await loadCampaignUpdatesForCampaign(campaignId, updatesContainer);
                    updatesLoaded++;
                }
            }
            
            if (updatesLoaded === 0) {
                updatesContainer.innerHTML = `
                    <div class="text-center py-4">
                        <p class="text-muted">No updates yet. Make a donation to receive updates!</p>
                    </div>
                `;
            }
            
        } catch (error) {
            console.error("Error loading campaign updates:", error);
        }
    }

    /**
     * Loads updates for a specific campaign
     * @param {string} campaignId - The campaign ID to load updates for
     * @param {HTMLElement} container - Container to append updates to
     */
    async function loadCampaignUpdatesForCampaign(campaignId, container) {
        try {
            const updatesQuery = query(
                collection(db, "updates"),
                where("campaignId", "==", campaignId),
                orderBy("createdAt", "desc"),
                limit(1)
            );
            
            const updatesSnapshot = await getDocs(updatesQuery);
            
            for (const doc of updatesSnapshot.docs) {
                const update = doc.data();
                await createUpdateCard(update, campaignId, container);
            }
            
        } catch (error) {
            console.error("Error loading updates for campaign:", error);
        }
    }

    /**
     * Creates an update card for campaign updates
     * @param {Object} update - Update data object
     * @param {string} campaignId - Campaign ID for the update
     * @param {HTMLElement} container - Container to append the card to
     */
    async function createUpdateCard(update, campaignId, container) {
        let campaignTitle = 'Campaign';
        const campaignDoc = await getDoc(doc(db, "campaigns", campaignId));
        if (campaignDoc.exists()) {
            campaignTitle = campaignDoc.data().title;
        }

        const updateDate = update.createdAt?.toDate().toLocaleDateString() || 'Unknown date';

        const updateCard = document.createElement('div');
        updateCard.className = 'card campaign-card mb-3';
        updateCard.innerHTML = `
            <div class="card-body">
                <h6 class="card-title fw-bold">${campaignTitle}</h6>
                <p class="card-text small">"${update.content}"</p>
                <small class="text-muted">Posted: ${updateDate}</small>
            </div>
        `;
        
        container.appendChild(updateCard);
    }

    /**
     * Loads saved campaigns for the current funder
     * @param {string} userId - The user ID to load saved campaigns for
     */
    async function loadSavedCampaigns(userId) {
        try {
            const savedQuery = query(
                collection(db, "savedCampaigns"),
                where("funderId", "==", userId)
            );
            
            const savedSnapshot = await getDocs(savedQuery);
            const savedContainer = document.getElementById('savedCampaignsList');
            
            if (!savedSnapshot.empty) {
                savedContainer.innerHTML = '';
                
                for (const doc of savedSnapshot.docs) {
                    const saved = doc.data();
                    const campaignDoc = await getDoc(doc(db, "campaigns", saved.campaignId));
                    if (campaignDoc.exists()) {
                        const campaign = campaignDoc.data();
                        await createSavedCampaignCard(campaign, saved.campaignId, savedContainer, doc.id);
                    }
                }
            } else {
                savedContainer.innerHTML = `
                    <div class="col-12 text-center py-4">
                        <i class="bi bi-bookmark display-1 text-muted"></i>
                        <h5 class="mt-3">No saved campaigns</h5>
                        <p class="text-muted">Save campaigns you're interested in to find them easily later.</p>
                        <button class="btn btn-donate" onclick="browseAllCampaigns()">Browse Campaigns</button>
                    </div>
                `;
            }
            
        } catch (error) {
            console.error("Error loading saved campaigns:", error);
        }
    }

    /**
     * Creates a saved campaign card
     * @param {Object} campaign - Campaign data object
     * @param {string} campaignId - Campaign document ID
     * @param {HTMLElement} container - Container to append the card to
     * @param {string} savedId - Saved campaign document ID
     */
    async function createSavedCampaignCard(campaign, campaignId, container, savedId) {
        let studentName = 'Student';
        if (campaign.studentId) {
            const studentDoc = await getDoc(doc(db, "users", campaign.studentId));
            if (studentDoc.exists()) {
                const studentData = studentDoc.data();
                studentName = `${studentData.firstName} ${studentData.surname}`;
            }
        }

        const currentAmount = campaign.currentAmount || 0;
        const goalAmount = campaign.goalAmount || 1;
        const progressPercentage = Math.min(100, ((currentAmount / goalAmount) * 100)).toFixed(0);

        const campaignCard = document.createElement('div');
        campaignCard.className = 'col-md-6 mb-4';
        campaignCard.innerHTML = `
            <div class="card campaign-card">
                <img src="${campaign.coverImage || campaign.imageUrl || './assets/pexels-kaiariel-3563697.jpg'}" 
                     class="card-img-top campaign-image" 
                     style="height: 200px; object-fit: cover;"
                     alt="${campaign.title}">
                <div class="card-body">
                    <h5 class="card-title fw-bold">${campaign.title}</h5>
                    <p class="card-text text-muted">${campaign.description || 'Support this student\'s educational journey.'}</p>
                    <p class="small text-muted mb-2">By: ${studentName}</p>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small class="text-muted">Raised: R${currentAmount.toLocaleString()}</small>
                            <small class="text-muted">Goal: R${goalAmount.toLocaleString()}</small>
                        </div>
                        <div class="progress">
                            <div class="progress-bar" style="width: ${progressPercentage}%"></div>
                        </div>
                        <small class="text-muted">${progressPercentage}% funded</small>
                    </div>

                    <div class="d-flex justify-content-between align-items-center">
                        <span class="badge bg-success">Active</span>
                        <div>
                            <button class="btn btn-sm btn-outline-danger me-2" onclick="removeSavedCampaign('${savedId}')">
                                <i class="bi bi-bookmark-x"></i>
                            </button>
                            <button class="btn btn-donate" onclick="donateToCampaign('${campaignId}')">Donate Now</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        container.appendChild(campaignCard);
    }

    /**
     * Loads payment methods for the current funder
     * @param {string} userId - The user ID to load payment methods for
     */
    async function loadPaymentMethods(userId) {
        try {
            const paymentsQuery = query(
                collection(db, "paymentMethods"),
                where("funderId", "==", userId)
            );
            
            const paymentsSnapshot = await getDocs(paymentsQuery);
            const paymentsContainer = document.getElementById('paymentMethodsList');
            
            if (!paymentsSnapshot.empty) {
                paymentsContainer.innerHTML = '';
                
                paymentsSnapshot.forEach(doc => {
                    const payment = doc.data();
                    const paymentItem = document.createElement('div');
                    paymentItem.className = 'border-bottom pb-3 mb-3';
                    paymentItem.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="fw-bold">${payment.cardType || 'Credit Card'}  ${payment.lastFour || '0000'}</h6>
                                <p class="text-muted small mb-0">Expires: ${payment.expiryDate || 'MM/YY'}</p>
                            </div>
                            <div>
                                ${payment.isPrimary ? '<span class="badge bg-primary me-2">Primary</span>' : ''}
                                <button class="btn btn-sm btn-outline-danger" onclick="removePaymentMethod('${doc.id}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    paymentsContainer.appendChild(paymentItem);
                });
            } else {
                paymentsContainer.innerHTML = `
                    <p class="text-muted">No payment methods added yet.</p>
                `;
            }
            
        } catch (error) {
            console.error("Error loading payment methods:", error);
        }
    }

    // CRUD Operations

    /**
     * Opens the edit modal for profile information
     * @param {string} mode - The edit mode (currently only 'profile')
     */
    function openEditModal(mode) {
        editMode = mode;
        const modal = new bootstrap.Modal(document.getElementById('editProfileModal'));
        const form = document.getElementById('editProfileForm');
        
        document.getElementById('editModalTitle').textContent = 'Edit Personal Information';
        
        let formFields = `
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">First Name *</label>
                        <input type="text" class="form-control" id="editFirstName" 
                               value="${currentFunder.firstName || ''}" 
                               required minlength="2" maxlength="50">
                        <div class="invalid-feedback">Please enter a valid first name (2-50 characters).</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Surname *</label>
                        <input type="text" class="form-control" id="editSurname" 
                               value="${currentFunder.surname || ''}" 
                               required minlength="2" maxlength="50">
                        <div class="invalid-feedback">Please enter a valid surname (2-50 characters).</div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" id="editPhone" 
                               value="${currentFunder.phoneNumber || ''}" 
                               pattern="[0-9+\-\s()]{10,}" 
                               placeholder="e.g., +27 12 345 6789">
                        <div class="invalid-feedback">Please enter a valid phone number.</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Organization</label>
                        <input type="text" class="form-control" id="editOrganization" 
                               value="${currentFunder.organization || ''}" 
                               maxlength="100">
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">ID Number</label>
                        <input type="text" class="form-control" id="editID" 
                               value="${currentFunder.idNumber || ''}" 
                               pattern="[0-9]{13}" 
                               placeholder="13-digit ID number">
                        <div class="invalid-feedback">Please enter a valid 13-digit ID number.</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Location</label>
                        <input type="text" class="form-control" id="editLocation" 
                               value="${currentFunder.location || ''}" 
                               maxlength="100">
                    </div>
                </div>
            </div>
            <div class="alert alert-info">
                <small><i class="bi bi-info-circle"></i> Fields marked with * are required.</small>
            </div>
        `;
        
        document.getElementById('profileEditFields').innerHTML = formFields;
        
        // Add real-time validation
        const inputs = document.querySelectorAll('#editProfileForm input');
        inputs.forEach(input => {
            input.addEventListener('input', function() {
                if (this.checkValidity()) {
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                } else {
                    this.classList.remove('is-valid');
                    this.classList.add('is-invalid');
                }
            });
        });
        
        modal.show();
    }

    /**
     * Saves profile changes from the edit modal
     */
    async function saveProfileChanges() {
        try {
            const form = document.getElementById('editProfileForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const updates = {};
            
            // Collect all form data
            updates.firstName = document.getElementById('editFirstName').value.trim();
            updates.surname = document.getElementById('editSurname').value.trim();
            updates.phoneNumber = document.getElementById('editPhone').value.trim();
            updates.organization = document.getElementById('editOrganization').value.trim();
            updates.idNumber = document.getElementById('editID').value.trim();
            updates.location = document.getElementById('editLocation').value.trim();
            
            // Add timestamp
            updates.updatedAt = serverTimestamp();
            
            showLoading(true);
            
            // Update Firestore document
            await updateDoc(doc(db, "users", currentFunderId), updates);
            
            // Update local data immediately
            currentFunder = { ...currentFunder, ...updates };
            
            // Refresh all profile displays
            refreshProfileDisplay();
            
            // Show success animation on updated fields
            showProfileUpdateSuccess();
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editProfileModal'));
            modal.hide();
            showLoading(false);
            
            showAlert('Profile updated successfully!', 'success');
            
        } catch (error) {
            console.error("Error updating profile:", error);
            showLoading(false);
            handleProfileError(error, 'profile update');
        }
    }

    /**
     * Handles profile picture change
     */
    async function changeProfilePicture() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        
        input.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Validate file type and size
            if (!file.type.startsWith('image/')) {
                showAlert('Please select an image file (JPEG, PNG, etc.)', 'warning');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                showAlert('Image size should be less than 5MB', 'warning');
                return;
            }
            
            try {
                showLoading(true);
                
                // Delete old profile picture if it exists and is not the default
                if (currentFunder.profilePicture && !currentFunder.profilePicture.includes('profile-user.png')) {
                    try {
                        const oldPictureRef = ref(storage, currentFunder.profilePicture);
                        await deleteObject(oldPictureRef);
                    } catch (error) {
                        console.log("No old profile picture to delete or error deleting:", error);
                    }
                }
                
                // Upload new profile picture to Firebase Storage
                const fileExtension = file.name.split('.').pop();
                const storageRef = ref(storage, `profile-pictures/${currentFunderId}/profile.${fileExtension}`);
                const uploadResult = await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(uploadResult.ref);
                
                // Update user document in Firestore
                await updateDoc(doc(db, "users", currentFunderId), {
                    profilePicture: downloadURL,
                    updatedAt: serverTimestamp()
                });
                
                // Update local data and UI immediately
                currentFunder.profilePicture = downloadURL;
                refreshProfileDisplay();
                
                showLoading(false);
                showAlert('Profile picture updated successfully!', 'success');
                
            } catch (error) {
                console.error("Error uploading profile picture:", error);
                showLoading(false);
                handleProfileError(error, 'profile picture update');
            }
        };
        
        input.click();
    }

    /**
     * Enhanced error handler for profile operations
     * @param {Error} error - The error object
     * @param {string} operation - The operation that failed
     */
    function handleProfileError(error, operation) {
        console.error(`Error during ${operation}:`, error);
        
        let userMessage = 'An error occurred';
        
        if (error.code === 'permission-denied') {
            userMessage = 'You do not have permission to update this profile.';
        } else if (error.code === 'unavailable') {
            userMessage = 'Network error. Please check your connection and try again.';
        } else if (error.code === 'storage/object-not-found') {
            userMessage = 'Profile picture not found. Please upload again.';
        } else {
            userMessage = `Error: ${error.message}`;
        }
        
        showAlert(userMessage, 'danger');
        showLoading(false);
    }

    /**
     * Shows success animation on updated profile fields
     */
    function showProfileUpdateSuccess() {
        // Add animation class to profile card
        const profileCard = document.querySelector('.profile-card');
        if (profileCard) {
            profileCard.classList.add('profile-update-success');
            setTimeout(() => {
                profileCard.classList.remove('profile-update-success');
            }, 2000);
        }
        
        // Highlight updated fields
        const updatedElements = [
            'displayFullName', 'displayPhone', 'displayOrganization', 'displayLocation',
            'profileFirstName', 'profileSurname', 'profilePhone', 'profileLocation'
        ];
        
        updatedElements.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.classList.add('text-success');
                setTimeout(() => {
                    element.classList.remove('text-success');
                }, 2000);
            }
        });
    }

    /**
     * Saves a campaign to the funder's saved list
     * @param {string} campaignId - The campaign ID to save
     */
    async function saveCampaign(campaignId) {
        try {
            // Check if already saved
            const existingQuery = query(
                collection(db, "savedCampaigns"),
                where("funderId", "==", currentFunderId),
                where("campaignId", "==", campaignId)
            );
            
            const existingSnapshot = await getDocs(existingQuery);
            
            if (!existingSnapshot.empty) {
                showAlert('Campaign is already saved!', 'warning');
                return;
            }
            
            await addDoc(collection(db, "savedCampaigns"), {
                funderId: currentFunderId,
                campaignId: campaignId,
                savedAt: new Date()
            });
            
            showAlert('Campaign saved successfully!', 'success');
            await loadSavedCampaigns(currentFunderId);
        } catch (error) {
            console.error("Error saving campaign:", error);
            showAlert('Error saving campaign', 'danger');
        }
    }

    /**
     * Removes a campaign from the saved list
     * @param {string} savedId - The saved campaign document ID
     */
    async function removeSavedCampaign(savedId) {
        if (confirm('Are you sure you want to remove this campaign from your saved list?')) {
            try {
                await deleteDoc(doc(db, "savedCampaigns", savedId));
                showAlert('Campaign removed from saved list!', 'success');
                await loadSavedCampaigns(currentFunderId);
            } catch (error) {
                console.error("Error removing saved campaign:", error);
                showAlert('Error removing campaign', 'danger');
            }
        }
    }

    /**
     * Opens the add payment method modal
     */
    function addPaymentMethod() {
        const modal = new bootstrap.Modal(document.getElementById('paymentMethodModal'));
        document.getElementById('paymentMethodForm').reset();
        modal.show();
    }

    /**
     * Saves a new payment method
     */
    async function savePaymentMethod() {
        try {
            const cardNumber = document.getElementById('cardNumber').value;
            const expiryDate = document.getElementById('expiryDate').value;
            const cvv = document.getElementById('cvv').value;
            const cardholderName = document.getElementById('cardholderName').value;
            
            // Simple validation
            if (!cardNumber || !expiryDate || !cvv || !cardholderName) {
                showAlert('Please fill in all fields', 'danger');
                return;
            }
            
            // Check if this is the first payment method (make it primary)
            const paymentsQuery = query(
                collection(db, "paymentMethods"),
                where("funderId", "==", currentFunderId)
            );
            const paymentsSnapshot = await getDocs(paymentsQuery);
            const isPrimary = paymentsSnapshot.empty;
            
            await addDoc(collection(db, "paymentMethods"), {
                funderId: currentFunderId,
                cardNumber: cardNumber, // In production, you should never store full card numbers
                lastFour: cardNumber.slice(-4),
                expiryDate: expiryDate,
                cardholderName: cardholderName,
                cardType: 'Credit Card', // You can determine this from the card number
                isPrimary: isPrimary,
                addedAt: new Date()
            });
            
            bootstrap.Modal.getInstance(document.getElementById('paymentMethodModal')).hide();
            showAlert('Payment method added successfully!', 'success');
            await loadPaymentMethods(currentFunderId);
            
        } catch (error) {
            console.error("Error adding payment method:", error);
            showAlert('Error adding payment method', 'danger');
        }
    }

    /**
     * Removes a payment method
     * @param {string} paymentId - The payment method document ID
     */
    async function removePaymentMethod(paymentId) {
        if (confirm('Are you sure you want to remove this payment method?')) {
            try {
                await deleteDoc(doc(db, "paymentMethods", paymentId));
                showAlert('Payment method removed successfully!', 'success');
                await loadPaymentMethods(currentFunderId);
            } catch (error) {
                console.error("Error removing payment method:", error);
                showAlert('Error removing payment method', 'danger');
            }
        }
    }

    /**
     * Redirects to donation page for a specific campaign
     * @param {string} campaignId - The campaign ID to donate to
     */
    function donateToCampaign(campaignId) {
        window.location.href = `donate.html?campaignId=${campaignId}`;
    }

    // Navigation functions

    /**
     * Redirects to browse all campaigns page
     */
    function browseAllCampaigns() {
        window.location.href = 'donate.html';
    }

    /**
     * Shows the saved campaigns tab
     */
    function viewSavedCampaigns() {
        const savedTab = new bootstrap.Tab(document.querySelector('a[href="#saved"]'));
        savedTab.show();
    }

    /**
     * Opens the add payment method modal
     */
    function updatePaymentMethod() {
        addPaymentMethod();
    }

    /**
     * Logs out the current user
     */
    async function logout() {
        try {
            await signOut(auth);
            window.location.href = 'login.html';
        } catch (error) {
            console.error("Error signing out:", error);
        }
    }

    /**
     * Shows an alert message to the user
     * @param {string} message - The message to display
     * @param {string} type - The alert type (success, danger, warning, info)
     */
    function showAlert(message, type) {
        // Remove any existing alerts
        const existingAlerts = document.querySelectorAll('.alert-fixed');
        existingAlerts.forEach(alert => alert.remove());
        
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show alert-fixed`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);
        
        // Auto dismiss after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }

    /**
     * Shows or hides the loading spinner
     * @param {boolean} show - Whether to show the spinner
     */
    function showLoading(show) {
        const spinner = document.getElementById('loadingSpinner');
        if (show) {
            spinner.classList.remove('d-none');
        } else {
            spinner.classList.add('d-none');
        }
    }

    // Make functions globally available for HTML onclick handlers
    window.openEditModal = openEditModal;
    window.changeProfilePicture = changeProfilePicture;
    window.saveProfileChanges = saveProfileChanges;
    window.saveCampaign = saveCampaign;
    window.removeSavedCampaign = removeSavedCampaign;
    window.addPaymentMethod = addPaymentMethod;
    window.removePaymentMethod = removePaymentMethod;
    window.donateToCampaign = donateToCampaign;
    window.browseAllCampaigns = browseAllCampaigns;
    window.viewSavedCampaigns = viewSavedCampaigns;
    window.updatePaymentMethod = updatePaymentMethod;
    window.logout = logout;
</script>
</body>
<!-- Dynamic navbar authentication script -->
<script src="./js/navbar-auth.js"></script>
</html>