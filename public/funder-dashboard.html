<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Funder Dashboard - FundMyFuture</title>

 <!-- Newsletter Script  -->
  <script src="./js/newsletter.js"></script>

<!-- BOOTSTRAP -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

<!-- Custom global stylesheet -->
<link rel="stylesheet" href="./css/styles.css">

<style>
/* Your existing CSS styles */
body { overflow-x: hidden; }
.dashboard-header { background-color: #2A6F97; padding: 30px 0; }

/* Profile Card Styling */
.profile-card { 
  background-color: #A9D6E5; 
}

.btn-primary-custom { background-color: #012A4A; color: #A9D6E5; }
.btn-primary-custom:hover { background-color: #2A6F97; color: #012A4A; }

/* Profile Information Styling */
.title-container {
  background-color: #012A4A;
  color: #A9D6E5;
  padding: 5px;
  border-radius: 5px;
}

/* Edit Modal Styles */
.edit-modal .modal-content {
  background-color: #A9D6E5;
  border: 3px solid #012A4A;
}
.edit-modal .form-label {
  color: #012A4A;
  font-weight: bold;
}

/* Edit button styling - Profile */
.btn-edit {
  background: none;
  border: none;
  color: #A9D6E5;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-edit:hover {
  color: #ffd60a;
  transform: scale(1.02);
}

/* Change Profile Picture Button */
.btn-change-photo {
  background-color: #012A4A;
  color: #A9D6E5;
  transition: all 0.3s ease;
}

.btn-change-photo:hover {
  background-color: #ffd60a;
  color: #012A4A;
  transform: scale(1.02);
}

.stat-card {
  border-left: 4px solid #2A6F97;
}

.campaign-card {
  background: white;
  border-radius: 10px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  transition: transform 0.2s;
  margin-bottom: 20px;
  border: none;
}
.btn-donate {
  background-color: #ffda1f;
  color: #012A4A;
  font-weight: 700;
  border: none;
  transition: all 0.3s ease;
}
.btn-donate:hover {
  background-color: #e0b000;
  color: #012A4A;
  transform: translateY(-2px);
}
.btn-view-all {
  background-color: #012A4A;
  color: #A9D6E5;
  font-weight: 700;
  border: none;
  transition: all 0.3s ease;
}
.btn-view-all:hover {
  background-color: #2A6F97;
  color: white;
}
.section-title {
  background-color: #012A4A;
  color: #A9D6E5;
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 20px;
}
.recent-donation-item {
  border-left: 4px solid #2A6F97;
  padding-left: 15px;
  margin-bottom: 15px;
}
.campaign-image {
  height: 200px;
  object-fit: cover;
  border-radius: 10px 10px 0 0;
}
.progress {
  height: 10px;
  background-color: #e9ecef;
}
.progress-bar {
  background-color: #2A6F97;
}

/* Alert positioning */
.alert-fixed {
  position: fixed;
  top: 100px;
  right: 20px;
  z-index: 9999;
  min-width: 300px;
}

/* Loading spinner */
#loadingSpinner {
  z-index: 9999;
}

/* User Profile Section Styling */
.dashboard-profile-title {
  background-color: #012A4A;
}
  </style>
</head>

<body>
<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-custom px-3">
    <div class="container-fluid">
        <a class="navbar-brand ms-2 text-white fw-bold" href="index.html">FundMyFuture</a>
        <div class="navbar-nav ms-auto">
            <button class="btn login-btn fw-bolder text-white" onclick="logout()">LOGOUT</button>
        </div>
    </div>
</nav>

<!-- Dashboard Header -->
<div class="container-fluid dashboard-header">
    <div class="container">
        <h1 class="text-white fw-bold">Funder Dashboard</h1>
        <p class="text-white-50">Welcome back, <span id="welcomeName">Funder</span>!</p>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="d-none position-fixed top-50 start-50 translate-middle" style="z-index: 9999;">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<!-- Main Content -->
<div class="container my-5">
    <!-- Profile Section -->
    <div class="row">
        <div class="col-12">
            <!-- Profile Card - Contains all user information -->
            <div class="card profile-card shadow border-0 rounded mb-4">
                <!-- Title of card -->
                <div class="card-header title-container">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="title-profile fw-bold mb-0 d-flex align-items-center">
                            <i class="bi bi-person-badge me-2 fs-3"></i> Profile Information
                        </h5>
                        <button class="btn btn-edit d-flex align-items-center" onclick="openEditModal('profile')">
                            <i class="bi bi-pencil me-1 fs-3"></i>
                        </button>
                    </div>
                </div>

                <!-- Profile Picture Editing -->
                <div class="card-body p-4">
                    <div class="row">
                        <div class="col-md-3 text-center mb-4">
                            <div class="mb-3">
                                <img id="profileImage" src="./assets/profile-user.png" 
                                    class="rounded-circle img-thumbnail shadow" 
                                    style="width: 140px; height: 140px; object-fit: cover;" 
                                    alt="Profile">
                            </div>

                            <!-- Change Profile Photo Button -->
                            <button class="btn btn-change-photo" onclick="changeProfilePicture()">
                                <i class="bi bi-camera-fill me-2"></i>Change Photo
                            </button>
                        </div>

                        <!-- User Information Display -->
                        <div class="col-md-9">
                            <div class="row">
                                <div class="col-md-6">
                                    <dl class="row">
                                        <dt class="col-sm-4 text-muted fw-light mb-3">Full Name</dt>
                                        <dd class="col-sm-8 fw-bold mb-3 text-break" id="displayFullName">Loading...</dd>
                                        
                                        <dt class="col-sm-4 text-muted fw-light mb-3">Email</dt>
                                        <dd class="col-sm-8 fw-bold mb-3 text-break" id="displayEmail">Loading...</dd>
                                        
                                        <dt class="col-sm-4 text-muted fw-light mb-3">Phone</dt>
                                        <dd class="col-sm-8 fw-bold mb-3 text-break" id="displayPhone">Loading...</dd>
                                    </dl>
                                </div>
                                <div class="col-md-6">
                                    <dl class="row">
                                        <dt class="col-sm-4 text-muted fw-light mb-3">Organization</dt>
                                        <dd class="col-sm-8 fw-bold mb-3 text-break" id="displayOrganization">Loading...</dd>
                                        
                                        <dt class="col-sm-4 text-muted fw-light mb-3">Location</dt>
                                        <dd class="col-sm-8 fw-bold mb-3 text-break" id="displayLocation">Loading...</dd>
                                        
                                        <dt class="col-sm-4 text-muted fw-light mb-3">Member Since</dt>
                                        <dd class="col-sm-8 fw-bold mb-3 text-break" id="displayMemberSince">Loading...</dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard Layout -->
    <div class="row">
        <!-- Quick Stats Overview - Left Sidebar -->
        <div class="col-lg-2 mb-4">
            <div class="d-flex flex-column">
                <div class="stat-card shadow rounded p-4 mb-3">
                    <h6>Total Donated</h6>
                    <h4 id="totalDonated">R0</h4>
                </div>
                <div class="stat-card shadow rounded p-4 mb-3">
                    <h6>Campaigns Supported</h6>
                    <h4 id="campaignsSupported">0</h4>
                </div>
                <div class="stat-card shadow rounded p-4 mb-3">
                    <h6>Students Helped</h6>
                    <h4 id="studentsHelped">0</h4>
                </div>
                <div class="stat-card shadow rounded p-4">
                    <h6>Last Donation</h6>
                    <h4 id="lastDonation">-</h4>
                </div>
            </div>
        </div>
        
        <!-- Main Content Area -->
        <div class="col-lg-10">
            <!-- Dashboard Tabs -->
            <div class="dashboard-tabs">
                <ul class="nav nav-tabs">
                    <li class="nav-item">
                        <a class="nav-link active" href="#overview" data-bs-toggle="tab">
                            <i class="bi bi-house"></i> Overview
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#campaigns" data-bs-toggle="tab">
                            <i class="bi bi-search"></i> Find Campaigns
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#donations" data-bs-toggle="tab">
                            <i class="bi bi-gift"></i> My Donations
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#saved" data-bs-toggle="tab">
                            <i class="bi bi-bookmark"></i> Saved Campaigns
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#profile" data-bs-toggle="tab">
                            <i class="bi bi-person"></i> Profile
                        </a>
                    </li>
                </ul>

                <div class="tab-content p-3">
                    <!-- Overview Tab -->
                    <div class="tab-pane fade show active" id="overview">
                        <div class="row">
                            <!-- Featured Campaigns -->
                            <div class="col-lg-8">
                                <div class="section-title">
                                    <h4 class="fw-bold mb-0"><i class="fas fa-star me-2"></i>Featured Campaigns</h4>
                                </div>

                                <div class="row" id="featuredCampaigns">
                                    <!-- Campaigns will be loaded dynamically -->
                                </div>

                                <div class="text-center mt-4">
                                    <button class="btn btn-view-all" onclick="viewAllCampaigns()">
                                        <i class="fas fa-search me-2"></i>Browse All Campaigns
                                    </button>
                                </div>

                                <!-- Recent Donations Section -->
                                <div class="mt-5">
                                    <div class="section-title">
                                        <h4 class="fw-bold mb-0"><i class="fas fa-history me-2"></i>Your Recent Donations</h4>
                                    </div>

                                    <div id="recentDonations">
                                        <!-- Recent donations will be loaded dynamically -->
                                    </div>
                                </div>
                            </div>

                            <!-- Right Column: Quick Actions & Updates -->
                            <div class="col-lg-4">
                                <!-- Quick Actions -->
                                <div class="section-title">
                                    <h4 class="fw-bold mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h4>
                                </div>

                                <div class="card campaign-card mb-4">
                                    <div class="card-body">
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-donate mb-2" onclick="findCampaigns()">
                                                <i class="fas fa-search me-2"></i>Find Campaigns to Support
                                            </button>
                                            <button class="btn btn-view-all mb-2" onclick="viewSavedCampaigns()">
                                                <i class="fas fa-bookmark me-2"></i>View Saved Campaigns
                                            </button>
                                            <button class="btn btn-view-all" onclick="updatePaymentMethod()">
                                                <i class="fas fa-credit-card me-2"></i>Update Payment Method
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Campaign Updates -->
                                <div class="section-title">
                                    <h4 class="fw-bold mb-0"><i class="fas fa-bell me-2"></i>Campaign Updates</h4>
                                </div>

                                <div id="campaignUpdates">
                                    <!-- Updates will be loaded dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Campaigns Tab -->
                    <div class="tab-pane fade" id="campaigns">
                        <h4 class="mb-4">Discover Campaigns to Support</h4>
                        
                        <!-- Search and Filter Section -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <input type="text" class="form-control" placeholder="Search campaigns..." id="campaignSearch">
                                            <button class="btn btn-donate" type="button" onclick="searchCampaigns()">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="categoryFilter">
                                            <option value="">All Categories</option>
                                            <option value="medicine">Medicine</option>
                                            <option value="engineering">Engineering</option>
                                            <option value="business">Business</option>
                                            <option value="arts">Arts</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="sortFilter">
                                            <option value="newest">Newest First</option>
                                            <option value="popular">Most Popular</option>
                                            <option value="ending">Ending Soon</option>
                                            <option value="most-funded">Most Funded</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Campaigns Grid -->
                        <div class="row" id="allCampaigns">
                            <!-- Campaigns will be loaded dynamically -->
                        </div>

                        <div class="text-center mt-4">
                            <button class="btn btn-view-all" onclick="loadMoreCampaigns()">
                                <i class="fas fa-plus me-2"></i>Load More Campaigns
                            </button>
                        </div>
                    </div>

                    <!-- Donations Tab -->
                    <div class="tab-pane fade" id="donations">
                        <h4 class="mb-4">Your Donation History</h4>
                        
                        <!-- Donation Statistics -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="text-center">
                                        <div class="stat-number" id="totalDonationsCount">0</div>
                                        <div class="stat-label">Total Donations</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="text-center">
                                        <div class="stat-number" id="largestDonation">R0</div>
                                        <div class="stat-label">Largest Donation</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="text-center">
                                        <div class="stat-number" id="avgDonation">R0</div>
                                        <div class="stat-label">Average Donation</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="text-center">
                                        <div class="stat-number" id="monthlyTotal">R0</div>
                                        <div class="stat-label">This Month</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Donations List -->
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title mb-4">Recent Donations</h5>
                                <div id="detailedDonationsList">
                                    <!-- Detailed donations will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Saved Campaigns Tab -->
                    <div class="tab-pane fade" id="saved">
                        <h4 class="mb-4">Your Saved Campaigns</h4>
                        <div class="row" id="savedCampaignsList">
                            <!-- Saved campaigns will be loaded dynamically -->
                        </div>
                    </div>

                    <!-- Profile Tab -->
                    <div class="tab-pane fade" id="profile">
                        <!-- Enhanced Profile Information -->
                        <div class="row">
                            <div class="col-md-8">
                                <div class="card profile-info mb-4">
                                    <div class="card-body">
                                        <h4 class="card-title fw-bold mb-4">Profile Details</h4>
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">First Name</label>
                                                    <p id="profileFirstName" class="form-control-plaintext">Loading...</p>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">Email</label>
                                                    <p id="profileEmail" class="form-control-plaintext">Loading...</p>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">ID Number</label>
                                                    <p id="profileID" class="form-control-plaintext">Loading...</p>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">Surname</label>
                                                    <p id="profileSurname" class="form-control-plaintext">Loading...</p>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">Phone</label>
                                                    <p id="profilePhone" class="form-control-plaintext">Loading...</p>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">Location</label>
                                                    <p id="profileLocation" class="form-control-plaintext">Loading...</p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-4">
                                            <button class="btn btn-primary-custom" onclick="openEditModal('profile')">
                                                <i class="bi bi-pencil-square me-2"></i>Edit Profile
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <img id="profileTabImage" src="./assets/profile-user.png" 
                                             class="img-fluid rounded-circle mb-3" 
                                             style="width: 120px; height: 120px; object-fit: cover;" 
                                             alt="Profile Picture">
                                        <h5 id="profileTabName" class="fw-bold">Loading...</h5>
                                        <p class="text-muted">Funder</p>
                                        <button class="btn btn-sm btn-outline-primary" onclick="changeProfilePicture()">
                                            Change Photo
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Methods Section -->
                        <div class="card mb-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0"><i class="bi bi-credit-card me-2"></i> Payment Methods</h5>
                            </div>
                            <div class="card-body">
                                <div id="paymentMethodsList">
                                    <!-- Payment methods will be loaded here -->
                                </div>
                                <button class="btn btn-donate mt-3" onclick="addPaymentMethod()">
                                    <i class="bi bi-plus-circle me-2"></i>Add Payment Method
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
                <!-- Donation Statistics -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="text-center">
                                <div class="stat-number" id="totalDonationsCount">0</div>
                                <div class="stat-label">Total Donations</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="text-center">
                                <div class="stat-number" id="largestDonation">R0</div>
                                <div class="stat-label">Largest Donation</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="text-center">
                                <div class="stat-number" id="avgDonation">R0</div>
                                <div class="stat-label">Average Donation</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="text-center">
                                <div class="stat-number" id="monthlyTotal">R0</div>
                                <div class="stat-label">This Month</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Donations List -->
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-4">Recent Donations</h5>
                        <div id="detailedDonationsList">
                            <!-- Detailed donations will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Saved Campaigns Tab -->
            <div class="tab-pane fade" id="saved">
                <h4 class="mb-4">Your Saved Campaigns</h4>
                <div class="row" id="savedCampaignsList">
                    <!-- Saved campaigns will be loaded dynamically -->
                </div>
            </div>

            <!-- Profile Tab -->
            <div class="tab-pane fade" id="profile">
                <!-- Enhanced Profile Information -->
                <div class="row">
                    <div class="col-md-8">
                        <div class="card profile-info mb-4">
                            <div class="card-body">
                                <h4 class="card-title fw-bold mb-4">Profile Details</h4>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">First Name</label>
                                            <p id="profileFirstName" class="form-control-plaintext">Loading...</p>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Email</label>
                                            <p id="profileEmail" class="form-control-plaintext">Loading...</p>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">ID Number</label>
                                            <p id="profileID" class="form-control-plaintext">Loading...</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Surname</label>
                                            <p id="profileSurname" class="form-control-plaintext">Loading...</p>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Phone</label>
                                            <p id="profilePhone" class="form-control-plaintext">Loading...</p>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Location</label>
                                            <p id="profileLocation" class="form-control-plaintext">Loading...</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-4">
                                    <button class="btn btn-primary-custom" onclick="openEditModal('profile')">
                                        <i class="bi bi-pencil-square me-2"></i>Edit Profile
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <img id="profileTabImage" src="./assets/profile-user.png" 
                                     class="img-fluid rounded-circle mb-3" 
                                     style="width: 120px; height: 120px; object-fit: cover;" 
                                     alt="Profile Picture">
                                <h5 id="profileTabName" class="fw-bold">Loading...</h5>
                                <p class="text-muted">Funder</p>
                                <button class="btn btn-sm btn-outline-primary" onclick="changeProfilePicture()">
                                    Change Photo
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Methods Section -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-credit-card me-2"></i> Payment Methods</h5>
                    </div>
                    <div class="card-body">
                        <div id="paymentMethodsList">
                            <!-- Payment methods will be loaded here -->
                        </div>
                        <button class="btn btn-donate mt-3" onclick="addPaymentMethod()">
                            <i class="bi bi-plus-circle me-2"></i>Add Payment Method
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
        
    </div>
</div>
</div>

<!-- Edit Profile Modal -->
<div class="modal fade edit-modal" id="editProfileModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalTitle">Edit Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editProfileForm">
                    <div id="profileEditFields">
                        <!-- Dynamic fields will be loaded here -->
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary-custom" onclick="saveProfileChanges()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Payment Method Modal -->
<div class="modal fade" id="paymentMethodModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Payment Method</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="paymentMethodForm">
                    <div class="mb-3">
                        <label class="form-label">Card Number</label>
                        <input type="text" class="form-control" id="cardNumber" placeholder="1234 5678 9012 3456" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Expiry Date</label>
                                <input type="text" class="form-control" id="expiryDate" placeholder="MM/YY" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">CVV</label>
                                <input type="text" class="form-control" id="cvv" placeholder="123" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Cardholder Name</label>
                        <input type="text" class="form-control" id="cardholderName" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary-custom" onclick="savePaymentMethod()">Save Payment Method</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Firebase Integration -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { 
        getFirestore, doc, getDoc, updateDoc, collection, query, where, getDocs, 
        addDoc, deleteDoc, orderBy, limit, serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyA6ocGvYKnwjc-xmW4j6he-CuTr4je3gko",
        authDomain: "fund-my-future-47844.firebaseapp.com",
        databaseURL: "https://fund-my-future-47844-default-rtdb.firebaseio.com",
        projectId: "fund-my-future-47844",
        storageBucket: "fund-my-future-47844.firebasestorage.app",
        messagingSenderId: "581912293895",
        appId: "1:581912293895:web:03468061fae2124ac770a2",
        measurementId: "G-LFC0R1GBE1"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    let currentFunder = null;
    let currentFunderId = null;
    let editMode = null;

    // Check authentication and load data
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentFunderId = user.uid;
            console.log("Funder logged in:", user.uid);
            showLoading(true);
            await loadFunderData(user.uid);
            showLoading(false);
        } else {
            console.log("No user logged in - redirecting to login");
            window.location.href = "login.html";
        }
    });

    async function loadFunderData(userId) {
        try {
            const userDoc = await getDoc(doc(db, "users", userId));
            if (userDoc.exists()) {
                currentFunder = { id: userDoc.id, ...userDoc.data() };
                displayFunderData(currentFunder);
                await loadFunderStatistics(userId);
                await loadFeaturedCampaigns();
                await loadRecentDonations(userId);
                await loadCampaignUpdates(userId);
                await loadSavedCampaigns(userId);
                await loadPaymentMethods(userId);
            } else {
                console.error("Funder document not found");
                showAlert('Funder data not found', 'danger');
            }
        } catch (error) {
            console.error("Error loading funder data:", error);
            showAlert('Error loading funder data', 'danger');
        }
    }

    function displayFunderData(funderData) {
        // Personal Information
        document.getElementById('welcomeName').textContent = `${funderData.firstName} ${funderData.surname}`;
        document.getElementById('displayFullName').textContent = `${funderData.firstName} ${funderData.surname}`;
        document.getElementById('displayEmail').textContent = funderData.email || 'Not provided';
        document.getElementById('displayPhone').textContent = funderData.phoneNumber || 'Not provided';
        document.getElementById('displayOrganization').textContent = funderData.organization || 'Individual';
        document.getElementById('displayLocation').textContent = funderData.location || 'Not provided';
        
        // Member since
        if (funderData.createdAt) {
            const memberSince = funderData.createdAt.toDate ? 
                funderData.createdAt.toDate() : new Date(funderData.createdAt);
            document.getElementById('displayMemberSince').textContent = 
                memberSince.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
        }

        // Profile tab data
        document.getElementById('profileFirstName').textContent = funderData.firstName || 'Not provided';
        document.getElementById('profileSurname').textContent = funderData.surname || 'Not provided';
        document.getElementById('profileEmail').textContent = funderData.email || 'Not provided';
        document.getElementById('profilePhone').textContent = funderData.phoneNumber || 'Not provided';
        document.getElementById('profileID').textContent = funderData.idNumber || 'Not provided';
        document.getElementById('profileLocation').textContent = funderData.location || 'Not provided';
        document.getElementById('profileTabName').textContent = `${funderData.firstName} ${funderData.surname}`;

        // Profile Picture - FIXED: Ensure profile picture is displayed
        if (funderData.profilePicture) {
            document.getElementById('profileImage').src = funderData.profilePicture;
            document.getElementById('profileTabImage').src = funderData.profilePicture;
        } else {
            document.getElementById('profileImage').src = './assets/profile-user.png';
            document.getElementById('profileTabImage').src = './assets/profile-user.png';
        }
    }

    async function loadFunderStatistics(userId) {
        try {
            const donationsQuery = query(
                collection(db, "donations"),
                where("funderId", "==", userId),
                where("paymentStatus", "==", "completed")
            );
            
            const donationsSnapshot = await getDocs(donationsQuery);
            
            let totalDonated = 0;
            let campaignsSupported = new Set();
            let studentsHelped = new Set();
            let lastDonationDate = null;
            let donationCount = 0;
            let largestDonation = 0;
            let currentMonthTotal = 0;
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            for (const doc of donationsSnapshot.docs) {
                const donation = doc.data();
                const amount = donation.amount || 0;
                
                totalDonated += amount;
                donationCount++;
                campaignsSupported.add(donation.campaignId);
                
                if (amount > largestDonation) {
                    largestDonation = amount;
                }
                
                // Get student ID from campaign
                if (donation.campaignId) {
                    const studentId = await getStudentFromCampaign(donation.campaignId);
                    if (studentId) {
                        studentsHelped.add(studentId);
                    }
                }
                
                // Track last donation date
                if (donation.createdAt) {
                    const donationDate = donation.createdAt.toDate();
                    if (!lastDonationDate || donationDate > lastDonationDate) {
                        lastDonationDate = donationDate;
                    }
                    
                    // Check if donation was this month
                    if (donationDate.getMonth() === currentMonth && donationDate.getFullYear() === currentYear) {
                        currentMonthTotal += amount;
                    }
                }
            }

            const avgDonation = donationCount > 0 ? totalDonated / donationCount : 0;

            // Update statistics
            document.getElementById('totalDonated').textContent = `R${totalDonated.toLocaleString()}`;
            document.getElementById('campaignsSupported').textContent = campaignsSupported.size;
            document.getElementById('studentsHelped').textContent = studentsHelped.size;
            
            if (lastDonationDate) {
                document.getElementById('lastDonation').textContent = lastDonationDate.toLocaleDateString();
            }

            // Update detailed donation stats
            document.getElementById('totalDonationsCount').textContent = donationCount;
            document.getElementById('largestDonation').textContent = `R${largestDonation.toLocaleString()}`;
            document.getElementById('avgDonation').textContent = `R${avgDonation.toFixed(0)}`;
            document.getElementById('monthlyTotal').textContent = `R${currentMonthTotal.toLocaleString()}`;
            
        } catch (error) {
            console.error("Error loading funder statistics:", error);
        }
    }

    async function getStudentFromCampaign(campaignId) {
        try {
            const campaignDoc = await getDoc(doc(db, "campaigns", campaignId));
            if (campaignDoc.exists()) {
                return campaignDoc.data().studentId;
            }
        } catch (error) {
            console.error("Error getting student from campaign:", error);
        }
        return null;
    }

    async function loadFeaturedCampaigns() {
        try {
            const campaignsQuery = query(
                collection(db, "campaigns"),
                where("status", "==", "active"),
                orderBy("createdAt", "desc"),
                limit(4)
            );
            
            const campaignsSnapshot = await getDocs(campaignsQuery);
            const campaignsContainer = document.getElementById('featuredCampaigns');
            
            if (!campaignsSnapshot.empty) {
                campaignsContainer.innerHTML = '';
                
                for (const doc of campaignsSnapshot.docs) {
                    const campaign = doc.data();
                    await createCampaignCard(campaign, doc.id, campaignsContainer, false);
                }
            } else {
                campaignsContainer.innerHTML = `
                    <div class="col-12 text-center py-4">
                        <p class="text-muted">No active campaigns found.</p>
                    </div>
                `;
            }
            
        } catch (error) {
            console.error("Error loading featured campaigns:", error);
        }
    }

    async function createCampaignCard(campaign, campaignId, container, showSaveButton = true) {
        // Get student name
        let studentName = 'Student';
        if (campaign.studentId) {
            const studentDoc = await getDoc(doc(db, "users", campaign.studentId));
            if (studentDoc.exists()) {
                const studentData = studentDoc.data();
                studentName = `${studentData.firstName} ${studentData.surname}`;
            }
        }

        const currentAmount = campaign.currentAmount || 0;
        const goalAmount = campaign.goalAmount || 1;
        const progressPercentage = Math.min(100, ((currentAmount / goalAmount) * 100)).toFixed(0);

        const campaignCard = document.createElement('div');
        campaignCard.className = 'col-md-6 mb-4';
        campaignCard.innerHTML = `
            <div class="card campaign-card">
                <img src="${campaign.coverImage || campaign.imageUrl || './assets/pexels-kaiariel-3563697.jpg'}" 
                     class="card-img-top campaign-image" 
                     style="height: 200px; object-fit: cover;"
                     alt="${campaign.title}">
                <div class="card-body">
                    <h5 class="card-title fw-bold">${campaign.title}</h5>
                    <p class="card-text text-muted">${campaign.description || 'Support this student\'s educational journey.'}</p>
                    <p class="small text-muted mb-2">By: ${studentName}</p>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small class="text-muted">Raised: R${currentAmount.toLocaleString()}</small>
                            <small class="text-muted">Goal: R${goalAmount.toLocaleString()}</small>
                        </div>
                        <div class="progress">
                            <div class="progress-bar" style="width: ${progressPercentage}%"></div>
                        </div>
                        <small class="text-muted">${progressPercentage}% funded</small>
                    </div>

                    <div class="d-flex justify-content-between align-items-center">
                        <span class="badge bg-success">Active</span>
                        <div>
                            ${showSaveButton ? `
                                <button class="btn btn-sm btn-outline-primary me-2" onclick="saveCampaign('${campaignId}')">
                                    <i class="bi bi-bookmark"></i>
                                </button>
                            ` : ''}
                            <button class="btn btn-donate" onclick="donateToCampaign('${campaignId}')">Donate Now</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        container.appendChild(campaignCard);
    }

    async function loadRecentDonations(userId) {
        try {
            const donationsQuery = query(
                collection(db, "donations"),
                where("funderId", "==", userId),
                orderBy("createdAt", "desc"),
                limit(5)
            );
            
            const donationsSnapshot = await getDocs(donationsQuery);
            const donationsContainer = document.getElementById('recentDonations');
            const detailedContainer = document.getElementById('detailedDonationsList');
            
            if (!donationsSnapshot.empty) {
                donationsContainer.innerHTML = '';
                detailedContainer.innerHTML = '';
                
                for (const doc of donationsSnapshot.docs) {
                    const donation = doc.data();
                    await createDonationItem(donation, donationsContainer);
                    await createDetailedDonationItem(donation, detailedContainer);
                }
            } else {
                donationsContainer.innerHTML = `
                    <div class="text-center py-4">
                        <p class="text-muted">No donations yet.</p>
                        <button class="btn btn-donate" onclick="findCampaigns()">Make Your First Donation</button>
                    </div>
                `;
                detailedContainer.innerHTML = `
                    <div class="text-center py-4">
                        <p class="text-muted">No donation history available.</p>
                    </div>
                `;
            }
            
        } catch (error) {
            console.error("Error loading recent donations:", error);
        }
    }

    async function createDonationItem(donation, container) {
        let campaignTitle = 'Campaign';
        if (donation.campaignId) {
            const campaignDoc = await getDoc(doc(db, "campaigns", donation.campaignId));
            if (campaignDoc.exists()) {
                campaignTitle = campaignDoc.data().title;
            }
        }

        const donationDate = donation.createdAt?.toDate().toLocaleDateString() || 'Unknown date';

        const donationItem = document.createElement('div');
        donationItem.className = 'recent-donation-item';
        donationItem.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h6 class="fw-bold mb-1">${campaignTitle}</h6>
                    <p class="text-muted mb-1">Donated: R${donation.amount?.toLocaleString() || '0'}</p>
                    <small class="text-muted">${donationDate}</small>
                </div>
                <span class="badge bg-success">Completed</span>
            </div>
        `;
        
        container.appendChild(donationItem);
    }

    async function createDetailedDonationItem(donation, container) {
        let campaignTitle = 'Campaign';
        let studentName = 'Student';
        
        if (donation.campaignId) {
            const campaignDoc = await getDoc(doc(db, "campaigns", donation.campaignId));
            if (campaignDoc.exists()) {
                const campaignData = campaignDoc.data();
                campaignTitle = campaignData.title;
                
                // Get student name
                if (campaignData.studentId) {
                    const studentDoc = await getDoc(doc(db, "users", campaignData.studentId));
                    if (studentDoc.exists()) {
                        const studentData = studentDoc.data();
                        studentName = `${studentData.firstName} ${studentData.surname}`;
                    }
                }
            }
        }

        const donationDate = donation.createdAt?.toDate().toLocaleDateString() || 'Unknown date';

        const donationItem = document.createElement('div');
        donationItem.className = 'border-bottom pb-3 mb-3';
        donationItem.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6 class="fw-bold">${campaignTitle}</h6>
                    <p class="text-muted mb-1">Student: ${studentName}</p>
                </div>
                <div class="col-md-3">
                    <p class="fw-bold text-primary">R${donation.amount?.toLocaleString() || '0'}</p>
                </div>
                <div class="col-md-3">
                    <small class="text-muted">${donationDate}</small>
                    <span class="badge bg-success d-block mt-1">Completed</span>
                </div>
            </div>
        `;
        
        container.appendChild(donationItem);
    }

    async function loadCampaignUpdates(userId) {
        try {
            // Get campaigns that the funder has donated to
            const donationsQuery = query(
                collection(db, "donations"),
                where("funderId", "==", userId),
                where("paymentStatus", "==", "completed")
            );
            
            const donationsSnapshot = await getDocs(donationsQuery);
            const campaignIds = new Set();
            
            donationsSnapshot.forEach(doc => {
                campaignIds.add(doc.data().campaignId);
            });

            // Get updates from these campaigns
            const updatesContainer = document.getElementById('campaignUpdates');
            updatesContainer.innerHTML = '';
            
            let updatesLoaded = 0;
            for (const campaignId of campaignIds) {
                if (campaignId && updatesLoaded < 3) {
                    await loadCampaignUpdatesForCampaign(campaignId, updatesContainer);
                    updatesLoaded++;
                }
            }
            
            if (updatesLoaded === 0) {
                updatesContainer.innerHTML = `
                    <div class="text-center py-4">
                        <p class="text-muted">No updates yet. Make a donation to receive updates!</p>
                    </div>
                `;
            }
            
        } catch (error) {
            console.error("Error loading campaign updates:", error);
        }
    }

    async function loadCampaignUpdatesForCampaign(campaignId, container) {
        try {
            const updatesQuery = query(
                collection(db, "updates"),
                where("campaignId", "==", campaignId),
                orderBy("createdAt", "desc"),
                limit(1)
            );
            
            const updatesSnapshot = await getDocs(updatesQuery);
            
            for (const doc of updatesSnapshot.docs) {
                const update = doc.data();
                await createUpdateCard(update, campaignId, container);
            }
            
        } catch (error) {
            console.error("Error loading updates for campaign:", error);
        }
    }

    async function createUpdateCard(update, campaignId, container) {
        let campaignTitle = 'Campaign';
        const campaignDoc = await getDoc(doc(db, "campaigns", campaignId));
        if (campaignDoc.exists()) {
            campaignTitle = campaignDoc.data().title;
        }

        const updateDate = update.createdAt?.toDate().toLocaleDateString() || 'Unknown date';

        const updateCard = document.createElement('div');
        updateCard.className = 'card campaign-card mb-3';
        updateCard.innerHTML = `
            <div class="card-body">
                <h6 class="card-title fw-bold">${campaignTitle}</h6>
                <p class="card-text small">"${update.content}"</p>
                <small class="text-muted">Posted: ${updateDate}</small>
            </div>
        `;
        
        container.appendChild(updateCard);
    }

    async function loadSavedCampaigns(userId) {
        try {
            const savedQuery = query(
                collection(db, "savedCampaigns"),
                where("funderId", "==", userId)
            );
            
            const savedSnapshot = await getDocs(savedQuery);
            const savedContainer = document.getElementById('savedCampaignsList');
            
            if (!savedSnapshot.empty) {
                savedContainer.innerHTML = '';
                
                for (const doc of savedSnapshot.docs) {
                    const saved = doc.data();
                    const campaignDoc = await getDoc(doc(db, "campaigns", saved.campaignId));
                    if (campaignDoc.exists()) {
                        const campaign = campaignDoc.data();
                        await createSavedCampaignCard(campaign, saved.campaignId, savedContainer, doc.id);
                    }
                }
            } else {
                savedContainer.innerHTML = `
                    <div class="col-12 text-center py-4">
                        <i class="bi bi-bookmark display-1 text-muted"></i>
                        <h5 class="mt-3">No saved campaigns</h5>
                        <p class="text-muted">Save campaigns you're interested in to find them easily later.</p>
                        <button class="btn btn-donate" onclick="findCampaigns()">Browse Campaigns</button>
                    </div>
                `;
            }
            
        } catch (error) {
            console.error("Error loading saved campaigns:", error);
        }
    }

    async function createSavedCampaignCard(campaign, campaignId, container, savedId) {
        let studentName = 'Student';
        if (campaign.studentId) {
            const studentDoc = await getDoc(doc(db, "users", campaign.studentId));
            if (studentDoc.exists()) {
                const studentData = studentDoc.data();
                studentName = `${studentData.firstName} ${studentData.surname}`;
            }
        }

        const currentAmount = campaign.currentAmount || 0;
        const goalAmount = campaign.goalAmount || 1;
        const progressPercentage = Math.min(100, ((currentAmount / goalAmount) * 100)).toFixed(0);

        const campaignCard = document.createElement('div');
        campaignCard.className = 'col-md-6 mb-4';
        campaignCard.innerHTML = `
            <div class="card campaign-card">
                <img src="${campaign.coverImage || campaign.imageUrl || './assets/pexels-kaiariel-3563697.jpg'}" 
                     class="card-img-top campaign-image" 
                     style="height: 200px; object-fit: cover;"
                     alt="${campaign.title}">
                <div class="card-body">
                    <h5 class="card-title fw-bold">${campaign.title}</h5>
                    <p class="card-text text-muted">${campaign.description || 'Support this student\'s educational journey.'}</p>
                    <p class="small text-muted mb-2">By: ${studentName}</p>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small class="text-muted">Raised: R${currentAmount.toLocaleString()}</small>
                            <small class="text-muted">Goal: R${goalAmount.toLocaleString()}</small>
                        </div>
                        <div class="progress">
                            <div class="progress-bar" style="width: ${progressPercentage}%"></div>
                        </div>
                        <small class="text-muted">${progressPercentage}% funded</small>
                    </div>

                    <div class="d-flex justify-content-between align-items-center">
                        <span class="badge bg-success">Active</span>
                        <div>
                            <button class="btn btn-sm btn-outline-danger me-2" onclick="removeSavedCampaign('${savedId}')">
                                <i class="bi bi-bookmark-x"></i>
                            </button>
                            <button class="btn btn-donate" onclick="donateToCampaign('${campaignId}')">Donate Now</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        container.appendChild(campaignCard);
    }

    async function loadPaymentMethods(userId) {
        try {
            const paymentsQuery = query(
                collection(db, "paymentMethods"),
                where("funderId", "==", userId)
            );
            
            const paymentsSnapshot = await getDocs(paymentsQuery);
            const paymentsContainer = document.getElementById('paymentMethodsList');
            
            if (!paymentsSnapshot.empty) {
                paymentsContainer.innerHTML = '';
                
                paymentsSnapshot.forEach(doc => {
                    const payment = doc.data();
                    const paymentItem = document.createElement('div');
                    paymentItem.className = 'border-bottom pb-3 mb-3';
                    paymentItem.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="fw-bold">${payment.cardType || 'Credit Card'}  ${payment.lastFour || '0000'}</h6>
                                <p class="text-muted small mb-0">Expires: ${payment.expiryDate || 'MM/YY'}</p>
                            </div>
                            <div>
                                ${payment.isPrimary ? '<span class="badge bg-primary me-2">Primary</span>' : ''}
                                <button class="btn btn-sm btn-outline-danger" onclick="removePaymentMethod('${doc.id}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    paymentsContainer.appendChild(paymentItem);
                });
            } else {
                paymentsContainer.innerHTML = `
                    <p class="text-muted">No payment methods added yet.</p>
                `;
            }
            
        } catch (error) {
            console.error("Error loading payment methods:", error);
        }
    }

    // CRUD Operations
    function openEditModal(mode) {
        editMode = mode;
        const modal = new bootstrap.Modal(document.getElementById('editProfileModal'));
        const form = document.getElementById('editProfileForm');
        
        document.getElementById('editModalTitle').textContent = 'Edit Personal Information';
        
        let formFields = `
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">First Name *</label>
                        <input type="text" class="form-control" id="editFirstName" value="${currentFunder.firstName || ''}" required>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Surname *</label>
                        <input type="text" class="form-control" id="editSurname" value="${currentFunder.surname || ''}" required>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" id="editPhone" value="${currentFunder.phoneNumber || ''}">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Organization</label>
                        <input type="text" class="form-control" id="editOrganization" value="${currentFunder.organization || ''}">
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">ID Number</label>
                        <input type="text" class="form-control" id="editID" value="${currentFunder.idNumber || ''}">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Location</label>
                        <input type="text" class="form-control" id="editLocation" value="${currentFunder.location || ''}">
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('profileEditFields').innerHTML = formFields;
        modal.show();
    }

    async function saveProfileChanges() {
        try {
            const form = document.getElementById('editProfileForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const updates = {};
            
            updates.firstName = document.getElementById('editFirstName').value.trim();
            updates.surname = document.getElementById('editSurname').value.trim();
            updates.phoneNumber = document.getElementById('editPhone').value.trim();
            updates.organization = document.getElementById('editOrganization').value.trim();
            updates.idNumber = document.getElementById('editID').value.trim();
            updates.location = document.getElementById('editLocation').value.trim();
            
            updates.updatedAt = new Date();
            
            showLoading(true);
            // FIXED: Ensure update actually happens
            await updateDoc(doc(db, "users", currentFunderId), updates);
            
            // Update local data
            currentFunder = { ...currentFunder, ...updates };
            displayFunderData(currentFunder);
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editProfileModal'));
            modal.hide();
            showLoading(false);
            
            showAlert('Profile updated successfully!', 'success');
        } catch (error) {
            console.error("Error updating profile:", error);
            showLoading(false);
            showAlert('Error updating profile: ' + error.message, 'danger');
        }
    }

    async function changeProfilePicture() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        
        input.onchange = async (e) => {
            const file = e.target.files[0];
            if (file) {
                // Validate file type and size
                if (!file.type.startsWith('image/')) {
                    showAlert('Please select an image file', 'warning');
                    return;
                }
                
                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    showAlert('Image size should be less than 5MB', 'warning');
                    return;
                }
                
                try {
                    showLoading(true);
                    // Delete old profile picture if exists
                    if (currentFunder.profilePicture) {
                        try {
                            const oldPictureRef = ref(storage, currentFunder.profilePicture);
                            await deleteObject(oldPictureRef);
                        } catch (error) {
                            console.log("No old profile picture to delete");
                        }
                    }
                    
                    // Upload to Firebase Storage
                    const storageRef = ref(storage, `profile-pictures/${currentFunderId}`);
                    await uploadBytes(storageRef, file);
                    const downloadURL = await getDownloadURL(storageRef);
                    
                    // Update user document
                    await updateDoc(doc(db, "users", currentFunderId), {
                        profilePicture: downloadURL,
                        updatedAt: new Date()
                    });
                    
                    // Update UI and local data
                    document.getElementById('profileImage').src = downloadURL;
                    document.getElementById('profileTabImage').src = downloadURL;
                    currentFunder.profilePicture = downloadURL;
                    showLoading(false);
                    
                    showAlert('Profile picture updated successfully!', 'success');
                } catch (error) {
                    console.error("Error uploading profile picture:", error);
                    showLoading(false);
                    showAlert('Error updating profile picture: ' + error.message, 'danger');
                }
            }
        };
        
        input.click();
    }

    async function saveCampaign(campaignId) {
        try {
            // Check if already saved
            const existingQuery = query(
                collection(db, "savedCampaigns"),
                where("funderId", "==", currentFunderId),
                where("campaignId", "==", campaignId)
            );
            
            const existingSnapshot = await getDocs(existingQuery);
            
            if (!existingSnapshot.empty) {
                showAlert('Campaign is already saved!', 'warning');
                return;
            }
            
            await addDoc(collection(db, "savedCampaigns"), {
                funderId: currentFunderId,
                campaignId: campaignId,
                savedAt: new Date()
            });
            
            showAlert('Campaign saved successfully!', 'success');
            await loadSavedCampaigns(currentFunderId);
        } catch (error) {
            console.error("Error saving campaign:", error);
            showAlert('Error saving campaign', 'danger');
        }
    }

    async function removeSavedCampaign(savedId) {
        if (confirm('Are you sure you want to remove this campaign from your saved list?')) {
            try {
                await deleteDoc(doc(db, "savedCampaigns", savedId));
                showAlert('Campaign removed from saved list!', 'success');
                await loadSavedCampaigns(currentFunderId);
            } catch (error) {
                console.error("Error removing saved campaign:", error);
                showAlert('Error removing campaign', 'danger');
            }
        }
    }

    function addPaymentMethod() {
        const modal = new bootstrap.Modal(document.getElementById('paymentMethodModal'));
        document.getElementById('paymentMethodForm').reset();
        modal.show();
    }

    async function savePaymentMethod() {
        try {
            const cardNumber = document.getElementById('cardNumber').value;
            const expiryDate = document.getElementById('expiryDate').value;
            const cvv = document.getElementById('cvv').value;
            const cardholderName = document.getElementById('cardholderName').value;
            
            // Simple validation
            if (!cardNumber || !expiryDate || !cvv || !cardholderName) {
                showAlert('Please fill in all fields', 'danger');
                return;
            }
            
            // Check if this is the first payment method (make it primary)
            const paymentsQuery = query(
                collection(db, "paymentMethods"),
                where("funderId", "==", currentFunderId)
            );
            const paymentsSnapshot = await getDocs(paymentsQuery);
            const isPrimary = paymentsSnapshot.empty;
            
            await addDoc(collection(db, "paymentMethods"), {
                funderId: currentFunderId,
                cardNumber: cardNumber, // In production, you should never store full card numbers
                lastFour: cardNumber.slice(-4),
                expiryDate: expiryDate,
                cardholderName: cardholderName,
                cardType: 'Credit Card', // You can determine this from the card number
                isPrimary: isPrimary,
                addedAt: new Date()
            });
            
            bootstrap.Modal.getInstance(document.getElementById('paymentMethodModal')).hide();
            showAlert('Payment method added successfully!', 'success');
            await loadPaymentMethods(currentFunderId);
            
        } catch (error) {
            console.error("Error adding payment method:", error);
            showAlert('Error adding payment method', 'danger');
        }
    }

    async function removePaymentMethod(paymentId) {
        if (confirm('Are you sure you want to remove this payment method?')) {
            try {
                await deleteDoc(doc(db, "paymentMethods", paymentId));
                showAlert('Payment method removed successfully!', 'success');
                await loadPaymentMethods(currentFunderId);
            } catch (error) {
                console.error("Error removing payment method:", error);
                showAlert('Error removing payment method', 'danger');
            }
        }
    }

    function donateToCampaign(campaignId) {
        window.location.href = `donate.html?campaignId=${campaignId}`;
    }

    function searchCampaigns() {
        const searchTerm = document.getElementById('campaignSearch').value;
        const category = document.getElementById('categoryFilter').value;
        const sort = document.getElementById('sortFilter').value;
        
        // Implement search functionality
        console.log('Searching campaigns:', { searchTerm, category, sort });
        // This would filter and reload the campaigns grid
    }

    function loadMoreCampaigns() {
        // Implement pagination for campaigns
        console.log('Loading more campaigns...');
    }

    // Navigation functions
    function viewAllCampaigns() {
        const campaignsTab = new bootstrap.Tab(document.querySelector('a[href="#campaigns"]'));
        campaignsTab.show();
    }

    function viewSavedCampaigns() {
        const savedTab = new bootstrap.Tab(document.querySelector('a[href="#saved"]'));
        savedTab.show();
    }

    function findCampaigns() {
        window.location.href = 'campaign.html';
    }

    function updatePaymentMethod() {
        addPaymentMethod();
    }

    async function logout() {
        try {
            await signOut(auth);
            window.location.href = 'login.html';
        } catch (error) {
            console.error("Error signing out:", error);
        }
    }

    function showAlert(message, type) {
        // Remove any existing alerts
        const existingAlerts = document.querySelectorAll('.alert-fixed');
        existingAlerts.forEach(alert => alert.remove());
        
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show alert-fixed`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);
        
        // Auto dismiss after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }

    function showLoading(show) {
        const spinner = document.getElementById('loadingSpinner');
        if (show) {
            spinner.classList.remove('d-none');
        } else {
            spinner.classList.add('d-none');
        }
    }

    // Make functions globally available
    window.openEditModal = openEditModal;
    window.changeProfilePicture = changeProfilePicture;
    window.saveCampaign = saveCampaign;
    window.removeSavedCampaign = removeSavedCampaign;
    window.addPaymentMethod = addPaymentMethod;
    window.removePaymentMethod = removePaymentMethod;
    window.donateToCampaign = donateToCampaign;
    window.searchCampaigns = searchCampaigns;
    window.loadMoreCampaigns = loadMoreCampaigns;
    window.viewAllCampaigns = viewAllCampaigns;
    window.viewSavedCampaigns = viewSavedCampaigns;
    window.findCampaigns = findCampaigns;
    window.updatePaymentMethod = updatePaymentMethod;
    window.logout = logout;
</script>
</body>
</html>