<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Start a Campaign - FundMyFuture</title>

    <!-- BOOTSTRAP & ICONS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <!-- Custom global stylesheet -->
    <link rel="stylesheet" href="./css/styles.css">

    <style>
        .profile-card { 
            background: #A9D6E5; 
            text-align: center; 
            color: #012A4A; 
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .profile-card img { 
            width: 120px; 
            height: 120px; 
            border-radius: 50%; 
            object-fit: cover; 
            margin-bottom: 20px; 
            border: 3px solid #012A4A;
        }

        /* Action button styling for profile actions */
        .action-btn {
            background-color: #012A4A;
            border: none;
            border-radius: 5px;
            padding: 10px;
            color: #A9D6E5;
            font-weight: 800;
            font-size: small;
            transition: all 0.3s ease;
            margin-bottom: 10px;
            width: 100%;
        }

        .action-btn:hover {
            color: #012A4A;
            background-color: #ffd60a;
            transform: scale(1.02);
        }

        .campaign-card { 
            background: #468FAF; 
            color: #012A4A; 
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .campaign-card label { 
            font-weight: 600; 
            color: #012A4A; 
            display: block; 
            margin-bottom: 5px; 
        }

        .campaign-card .form-control, .campaign-card .form-select { 
            border-radius: 8px; 
            margin-bottom: 15px; 
            border: 1px solid #012A4A; 
            padding: 10px;
        }

        .campaign-card .form-control:focus, .campaign-card .form-select:focus {
            border-color: #012A4A;
            box-shadow: 0 0 0 0.2rem rgba(1, 42, 74, 0.25);
        }

        /* Launch campaign button styling */
        .launch-btn {
            background-color: #012A4A;
            border: none;
            border-radius: 5px;
            padding: 12px;
            color: #A9D6E5;
            font-weight: 800;
            font-size: medium;
            transition: all 0.3s ease;
            width: 100%;
        }

        .launch-btn:hover {
            color: #012A4A;
            background-color: #ffd60a;
            transform: scale(1.02);
        }

        .launch-btn:disabled { 
            opacity: 0.6; 
            cursor: not-allowed; 
            transform: none;
        }

        #imagePreview { 
            border: 2px dashed #012A4A; 
            padding: 20px; 
            text-align: center; 
            border-radius: 8px; 
            background-color: rgba(255,255,255,0.5);
        }

        .section-title {
            color: #012A4A;
            border-bottom: 2px solid #012A4A;
            padding-bottom: 10px;
        }

        .dashboard-container {
            min-height: calc(100vh - 200px);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 15px !important;
            }
            
            .profile-card, .campaign-card {
                margin-bottom: 20px;
            }
        }

        .permission-help {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
            font-size: 0.9em;
        }
        
        .firebase-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            color: #721c24;
        }
    </style>
</head>

<body>

<!-- Navigation Bar -->
<nav class="navbar navbar-expand-lg navbar-custom px-3">
    <div class="container-fluid">
        <!-- Brand/Logo linking to homepage -->
        <a class="navbar-brand ms-2" href="index.html">FundMyFuture</a>

        <!-- Mobile menu toggle button -->
        <button class="navbar-toggler text-white" type="button" data-bs-toggle="offcanvas" data-bs-target="#navbarOffcanvas" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <!-- Offcanvas navigation menu for mobile devices -->
        <div class="offcanvas offcanvas-end text-bg-dark" tabindex="-1" id="navbarOffcanvas">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title">Menu</h5>
                <!-- Close button for offcanvas menu -->
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
                <ul class="navbar-nav ms-auto align-items-center">
                    <!-- Donate button call-to-action -->
                    <li class="nav-item me-3">
                        <a class="btn donate-btn ms-2" href="donate.html">DONATE NOW</a>
                    </li>
                    <!-- Student section link -->
                    <li class="nav-item">
                        <a class="nav-link" href="sign-up-funderStudent.html">STUDENTS</a>
                    </li>
                    <!-- Funder section link -->
                    <li class="nav-item">
                        <a class="nav-link" href="sign-up-funderStudent.html">FUNDERS</a>
                    </li>
                    <!-- About us informational link -->
                    <li class="nav-item">
                        <a class="nav-link" href="about.html">ABOUT US</a>
                    </li>
                    <!-- Login/authentication button -->
                    <li class="nav-item me-2" id="login-area">
                        <a class="btn login-btn fw-bolder" href="login.html">LOGIN</a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</nav>

<!-- Main Content -->

<!-- Main Dashboard Container: Provides overall layout container with responsive padding -->
<div class="dashboard-container container-fluid p-4">
    <!-- Responsive Grid Row: Uses Bootstrap grid with consistent gutter spacing between columns -->
    <div class="row g-4">
        
        <!-- PROFILE SIDEBAR SECTION -->
        <!-- Left-aligned on desktop, full width on mobile. Order ensures proper responsive layout -->
        <div class="col-md-4 order-md-1 order-1">
            <!-- Profile Card: Container for user profile information and navigation actions -->
            <div class="profile-card p-4 rounded">
                <!-- User Profile Image: Default placeholder image until user uploads their own -->
                <img src="assets/profile-user.png" class="rounded-circle" alt="Profile Picture">
                
                <!-- User Name Display: Dynamically populated with user's actual name -->
                <h4 class="fw-bold">Loading...</h4>
                
                <!-- User Information Container: Flex container for additional user details -->
                <div class="user-info d-flex flex-column align-items-center text-center mb-4">
                    <!-- Loading State: Placeholder text while user data is being fetched -->
                    <div class="text-muted">Loading user data...</div>
                </div>
                
                <!-- Navigation Action Buttons: Quick links to different sections of the application -->
                <button class="action-btn" onclick="window.location.href='student-dashboard.html'">My Dashboard</button>
                <button class="action-btn" onclick="window.location.href='student-dashboard.html'">My Campaigns</button>
                <button class="action-btn" onclick="window.location.href='donate.html'">Browse Campaigns</button>
            </div>
        </div>

        <!-- CAMPAIGN FORM SECTION -->
        <!-- Right-aligned on desktop, full width on mobile. Takes majority of screen space -->
        <div class="col-md-8 order-md-2 order-2">
            <!-- Campaign Form Card: Container for the campaign creation form with consistent padding -->
            <div class="campaign-card p-4 rounded">
                <!-- Form Header: Clear title indicating the purpose of this section -->
                <h3 class="section-title text-center fw-bold mb-4 fs-2">Create New Campaign</h3>
                
                <!-- Firebase Error Display -->
                <div class="firebase-error d-none" id="firebaseError">
                    <strong>Firebase Error:</strong> 
                    <span id="errorMessage"></span>
                    <div class="mt-2">
                        <small>Please check your Firebase security rules and try again.</small>
                    </div>
                </div>
                
                <!-- Permission Help Box -->
                <div class="permission-help d-none" id="permissionHelp">
                    <strong>Permission Issue Detected:</strong> 
                    <p class="mb-1">To create campaigns, you need to update Firebase security rules.</p>
                    <ol class="mb-1">
                        <li>Go to <a href="https://console.firebase.google.com/" target="_blank">Firebase Console</a></li>
                        <li>Select your project → Firestore Database → Rules</li>
                        <li>Update rules to allow authenticated users to write</li>
                    </ol>
                    <small class="text-muted">This message will disappear once permissions are fixed.</small>
                </div>
                
                <!-- Campaign Creation Form: Main form for submitting new campaign details -->
                <form id="campaignForm">
                    
                    <!-- Campaign Title Field: Required field for campaign name with length validation -->
                    <label for="campaignTitle" class="mb-2 fw-bold">Campaign Title *</label>
                    <input type="text" id="campaignTitle" class="form-control mb-0 border-0" placeholder="Enter a catchy title for your campaign" required minlength="5">
                    <small class="text-muted">Minimum 5 characters</small>

                    <!-- Campaign Description Field: Brief summary with character length requirement -->
                    <label for="campaignDescription" class="mb-2 mt-3 fw-bold">Short Description *</label>
                    <input type="text" id="campaignDescription" class="form-control mb-0 border-0" placeholder="Brief summary of your campaign" required minlength="10">
                    <small class="text-muted">Minimum 10 characters</small>

                    <!-- Funding Goal Field: Monetary target in South African Rand with minimum amount -->
                    <label for="fundingGoal" class="mb-2 mt-3 fw-bold">Funding Goal (ZAR) *</label>
                    <input type="number" id="fundingGoal" class="form-control mb-0 border-0" placeholder="e.g. 5000" min="100" step="100" required>
                    <small class="text-muted">Minimum R100</small>

                    <!-- Campaign End Date: Date picker restricted to future dates only -->
                    <label for="endDate" class="mb-2 mt-3 fw-bold">Campaign End Date *</label>
                    <input type="date" id="endDate" class="form-control mb-0 border-0" min="" required>
                    <small class="text-muted">Select a future date</small>

                    <!-- Category Selection: Dropdown for campaign categorization -->
                    <label for="category" class="mb-2 mt-3 fw-bold">Category *</label>
                    <select id="category" class="form-select mb-0 border-0" required>
                        <option value="">Select a category</option>
                        <option value="tuition">Tuition Fees</option>
                        <option value="books">Books & Supplies</option>
                        <option value="living">Living Expenses</option>
                      
                    </select>

                    <!-- Story Field: Detailed description area for campaign narrative -->
                    <label for="story" class="mb-2 mt-3 fw-bold">Your Story *</label>
                    <textarea id="story" class="form-control mb-0 border-0" rows="6" placeholder="Share your educational journey, challenges, and how this funding will help you achieve your goals..." required minlength="50"></textarea>
                    <small class="text-muted">Minimum 50 characters. Be authentic and compelling!</small>

                    <!-- Cover Image Upload: Optional file upload for campaign visual representation -->
                    <label for="coverImage" class="mb-2 mt-3 fw-bold">Upload Cover Image</label>
                    <input type="file" id="coverImage" class="form-control mb-0 border-0" accept="image/*">
                    <small class="text-muted">Optional. JPG, PNG up to 5MB</small>

                    <!-- Image Preview Area: Hidden container that displays when an image is selected -->
                    <div id="imagePreview" class="d-none mt-3"></div>

                    <!-- Form Submission: Primary action button to create and launch the campaign -->
                    <button type="submit" class="launch-btn mt-4">Launch Campaign</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Footer Section -->
<footer class="footer pt-5">

    <!-- Main container for footer content -->
    <div class="container pb-4">
        
        <div class="row">
            
            <!-- Newsletter Signup Column -->
            <div class="col-md-6 mb-4">
                <h5 class="fw-bold">Stay Connected</h5>
                <p class="mb-3">Sign up for our newsletter to stay informed.</p>
                <!-- Newsletter Form -->
                <form id="newsletterForm" class="d-flex icon-input-group">
                    <!-- Envelope icon inside input field for visual context -->
                    <i class="fa-regular fa-envelope"></i>
                    <!-- Email input field for newsletter subscription -->
                    <input type="email" id="newsletterEmail" class="form-control me-2 rounded-3" placeholder="Enter email . . ." required>
                    <!-- Submit button for newsletter signup -->
                    <button type="submit" class="btn btn-outline-primary px-3 sign-up-btn" id="subscribeBtn">
                        SIGN UP
                    </button>
                </form>

                <!-- Message display area -->
                <div id="newsletterMessage" class="mt-2"></div>

            </div>

            <!-- Social Media Column -->
            <div class="col-md-6 mb-4 text-md-end">
                <h5 class="fw-bold follow-us">Follow us</h5>
                <div class="social-icons mt-2">
                    <!-- Instagram social media link -->
                    <a href="https://www.instagram.com/thisisrichfield/?hl=en" target="_blank" rel="noopener noreferrer" class="text-decoration-none" aria-label="Instagram">
                        <i class="fab fa-instagram" aria-hidden="true"></i>
                    </a>
                    <!-- Facebook social media link -->
                    <a href="https://www.facebook.com/thisisrichfield/" target="_blank" rel="noopener noreferrer" class="text-decoration-none" aria-label="Facebook">
                        <i class="fab fa-facebook" aria-hidden="true"></i>
                    </a>
                    <!-- LinkedIn social media link -->
                    <a href="https://www.linkedin.com/school/richfieldeducation/posts/?feedView=all" target="_blank" rel="noopener noreferrer" class="text-decoration-none" aria-label="LinkedIn">
                        <i class="fab fa-linkedin" aria-hidden="true"></i>
                    </a>
                </div>
            </div>

        </div>

        <hr> <!-- Horizontal separator line between sections -->

        <div class="row text-start text-md-start">

            <!-- Navigate Links Column -->
            <div class="col-6 col-md-3 mb-4">
                <h6 class="fw-bold">Navigate</h6>
                <ul class="list-unstyled">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="donate.html">Donate</a></li>
                    <li><a href="story.html">Stories</a></li>
                    <li><a href="about.html">About</a></li>
                </ul>
            </div>

            <!-- Company Links Column -->
            <div class="col-6 col-md-3 mb-4">
                <h6 class="fw-bold">Company</h6>
                <ul class="list-unstyled">
                    <li><a href="contact.html">Contact us</a></li>
                    <li><a href="faq.html">FAQ's</a></li>
                </ul>
            </div>

            <!-- Contact Info Column -->
            <div class="col-md-6 mb-4">
                <h6 class="fw-bold">Contact</h6>
                <!-- Address with clickable Google Maps link for easy directions -->
                <p class="mb-1">
                    <a href="https://www.google.com/maps/place/Richfield+Cape+Town+Campus/@-33.9229995,18.4134391,17z/data=!3m1!4b1!4m6!3m5!1s0x1dcc6763f48a57fd:0x167125f9a04d06ff!8m2!3d-33.923004!4d18.41831!16s%2Fg%2F1hhh2yjf_?entry=ttu&g_ep=EgoyMDI1MTAyMi4wIKXMDSoASAFQAw%3D%3D" target="_blank" rel="noopener noreferrer">
                        5th floor 112 Long St <br> 
                        Cape Town <br> 
                        8000 <br> 
                        Western Cape
                    </a>
                </p>
                <!-- Phone number link for direct calling capability -->
                <p class="mb-1"><a href="tel:+27218310700">+27 21 831 0700</a></p>
                <!-- Email link for direct communication -->
                <p class="mb-0"><a href="mailto:fundmyfuture7@gmail.com">fundmyfuture7@gmail.com</a></p>
            </div>

        </div>
    </div> <!-- End container -->

    <!-- Footer Bottom Bar -->
    <div class="footer-bottom py-3">
        <div class="container d-flex flex-column flex-md-row justify-content-between align-items-center">
            
            <!-- Legal & policy links for compliance and user information -->
            <div class="mb-2 mb-md-0">
                <a href="terms.html" class="me-3 text-white">Terms & Conditions</a>
                <a href="privacy.html" class="me-3 text-white">Privacy Policy</a>
                <a href="cookies.html" class="me-3 text-white">Cookies Policy</a>
                <a href="cookies_settings.html" class="text-white">Cookies Settings</a>
            </div>

            <!-- Copyright notice -->
            <div class="text-white">&copy;2025 FundMyFuture</div>
        </div>
    </div>

</footer>

<!-- JavaScript Files -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="./js/navbar-auth.js"></script>

<!-- Firebase Campaign Creation Script -->
<script>
// ===== FIREBASE CONFIGURATION =====
const firebaseConfig = {
    apiKey: "AIzaSyA6ocGvYKnwjc-xmW4j6he-CuTr4je3gko",
    authDomain: "fund-my-future-47844.firebaseapp.com",
    databaseURL: "https://fund-my-future-47844-default-rtdb.firebaseio.com",
    projectId: "fund-my-future-47844",
    storageBucket: "fund-my-future-47844.firebasestorage.app",
    messagingSenderId: "581912293895",
    appId: "1:581912293895:web:03468061fae2124ac770a2",
    measurementId: "G-LFC0R1GBE1"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);

// Initialize Firebase services
const db = firebase.firestore();
const auth = firebase.auth();
const storage = firebase.storage();

// ===== UTILITY FUNCTIONS =====
function showAlert(message, type = 'info') {
    const existingAlerts = document.querySelectorAll('.custom-alert');
    existingAlerts.forEach(alert => alert.remove());
    
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} custom-alert position-fixed`;
    alertDiv.style.cssText = 'top: 100px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Show permission help
function showPermissionHelp() {
    const helpDiv = document.getElementById('permissionHelp');
    if (helpDiv) {
        helpDiv.classList.remove('d-none');
    }
}

// Hide permission help
function hidePermissionHelp() {
    const helpDiv = document.getElementById('permissionHelp');
    if (helpDiv) {
        helpDiv.classList.add('d-none');
    }
}

// Show Firebase error
function showFirebaseError(message) {
    const errorDiv = document.getElementById('firebaseError');
    const errorMessage = document.getElementById('errorMessage');
    if (errorDiv && errorMessage) {
        errorMessage.textContent = message;
        errorDiv.classList.remove('d-none');
    }
}

// Hide Firebase error
function hideFirebaseError() {
    const errorDiv = document.getElementById('firebaseError');
    if (errorDiv) {
        errorDiv.classList.add('d-none');
    }
}

// ===== CAMPAIGN CREATION FUNCTIONALITY =====
document.addEventListener('DOMContentLoaded', function() {
    // Set minimum date for end date field
    const today = new Date();
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    const minDate = tomorrow.toISOString().split('T')[0];
    document.getElementById('endDate').min = minDate;
    
    // Check authentication and initialize page
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            await loadUserData(user.uid);
            
            // Add form submission handler
            document.getElementById('campaignForm').addEventListener('submit', handleCampaignSubmit);
            
            // Add image preview
            document.getElementById('coverImage').addEventListener('change', handleImagePreview);

            // Test Firestore permissions - using a safer approach
            await testFirestorePermissions(user.uid);
        } else {
            window.location.href = 'login.html';
        }
    });
});

// Test Firestore permissions - safer approach using existing collections
async function testFirestorePermissions(userId) {
    try {
        // Instead of creating a test collection, try to read the user's own document
        // This should work with your existing security rules
        const userDoc = await db.collection("users").doc(userId).get();
        
        if (userDoc.exists) {
            console.log("Firestore permissions test passed - can read user data");
            hidePermissionHelp();
            hideFirebaseError();
            return true;
        } else {
            console.log("User document doesn't exist but permissions are OK");
            hidePermissionHelp();
            hideFirebaseError();
            return true;
        }
    } catch (error) {
        console.error("Firestore permission test failed:", error);
        if (error.code === 'permission-denied') {
            showPermissionHelp();
            showFirebaseError('Firestore permission denied. Please update security rules to allow read access to user documents.');
            return false;
        } else {
            showFirebaseError('Firestore error: ' + error.message);
            return false;
        }
    }
}

// Load user data from Firestore
async function loadUserData(userId) {
    try {
        const userDoc = await db.collection("users").doc(userId).get();
        console.log("User document:", userDoc);
        
        if (userDoc.exists) {
            const userData = userDoc.data();
            console.log("User data loaded:", userData);
            
            // Check if user is a student
            if (userData.userType !== 'student') {
                showFirebaseError('Only students can create campaigns. Your account type is: ' + (userData.userType || 'unknown'));
                document.querySelector('.launch-btn').disabled = true;
                return;
            }
            
            displayUserData(userData);
        } else {
            console.error("User document not found");
            showFirebaseError('User profile not found. Please complete your profile first.');
            document.querySelector('.launch-btn').disabled = true;
        }
    } catch (error) {
        console.error("Error loading user data:", error);
        if (error.code === 'permission-denied') {
            showPermissionHelp();
            showFirebaseError('Permission denied when loading user data.');
            document.querySelector('.launch-btn').disabled = true;
        } else {
            showFirebaseError('Error loading user data: ' + error.message);
            document.querySelector('.launch-btn').disabled = true;
        }
    }
}

// Display user data in the profile card
function displayUserData(userData) {
    const profileImage = document.querySelector('.profile-card img');
    if (userData.profilePicture) {
        profileImage.src = userData.profilePicture;
    }
    
    // Handle different name field possibilities
    let displayName = 'User';
    if (userData.firstName && userData.surname) {
        displayName = `${userData.firstName} ${userData.surname}`;
    } else if (userData.fullName) {
        displayName = userData.fullName;
    } else if (userData.name) {
        displayName = userData.name;
    }
    
    document.querySelector('.profile-card h4').textContent = displayName;
    
    const userInfoDiv = document.querySelector('.user-info');
    userInfoDiv.innerHTML = `
        <div class="text-muted"><i class="bi bi-building"></i> ${userData.institution || 'Not specified'}</div>
        <div class="text-muted"><i class="bi bi-book"></i> ${userData.course || userData.fieldOfStudy || 'Not specified'}</div>
        <div class="text-muted"><i class="bi bi-envelope"></i> ${userData.email || 'Not specified'}</div>
    `;
}

// Handle image preview when a file is selected
function handleImagePreview(event) {
    const file = event.target.files[0];
    const preview = document.getElementById('imagePreview');
    
    if (file) {
        // Validate file type
        if (!file.type.startsWith('image/')) {
            showAlert('Please select a valid image file (JPG, PNG, etc.)', 'warning');
            event.target.value = '';
            return;
        }
        
        // Validate file size (5MB max)
        if (file.size > 5 * 1024 * 1024) {
            showAlert('Image size should be less than 5MB', 'warning');
            event.target.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.innerHTML = `
                <img src="${e.target.result}" class="img-fluid rounded" style="max-height: 200px; width: auto;">
                <button type="button" class="btn btn-sm btn-danger mt-2" onclick="removeImage()">Remove Image</button>
            `;
            preview.classList.remove('d-none');
        };
        reader.readAsDataURL(file);
    }
}

// Remove image from preview
function removeImage() {
    document.getElementById('coverImage').value = '';
    document.getElementById('imagePreview').classList.add('d-none');
    document.getElementById('imagePreview').innerHTML = '';
}

// Handle campaign form submission
async function handleCampaignSubmit(e) {
    e.preventDefault();
    
    // Get form values
    const title = document.getElementById('campaignTitle').value.trim();
    const description = document.getElementById('campaignDescription').value.trim();
    const goal = parseFloat(document.getElementById('fundingGoal').value);
    const endDate = document.getElementById('endDate').value;
    const category = document.getElementById('category').value;
    const story = document.getElementById('story').value.trim();
    const coverImage = document.getElementById('coverImage').files[0];
    
    // Validation
    if (!title || title.length < 5) {
        showAlert('Campaign title must be at least 5 characters', 'warning');
        document.getElementById('campaignTitle').focus();
        return;
    }
    
    if (!description || description.length < 10) {
        showAlert('Description must be at least 10 characters', 'warning');
        document.getElementById('campaignDescription').focus();
        return;
    }
    
    if (!goal || goal < 100) {
        showAlert('Funding goal must be at least R100', 'warning');
        document.getElementById('fundingGoal').focus();
        return;
    }
    
    if (!endDate) {
        showAlert('Please select an end date for your campaign', 'warning');
        document.getElementById('endDate').focus();
        return;
    }
    
    const today = new Date().toISOString().split('T')[0];
    if (endDate <= today) {
        showAlert('Please select a future date for campaign end', 'warning');
        document.getElementById('endDate').focus();
        return;
    }
    
    if (!category) {
        showAlert('Please select a category for your campaign', 'warning');
        document.getElementById('category').focus();
        return;
    }
    
    if (!story || story.length < 50) {
        showAlert('Your story should be at least 50 characters to be compelling', 'warning');
        document.getElementById('story').focus();
        return;
    }
    
    try {
        const submitBtn = document.querySelector('.launch-btn');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Creating Campaign...';
        
        let imageUrl = '';
        
        // Upload cover image if provided
        if (coverImage) {
            if (!coverImage.type.startsWith('image/')) {
                throw new Error('Please select a valid image file');
            }
            if (coverImage.size > 5 * 1024 * 1024) {
                throw new Error('Image size should be less than 5MB');
            }
            
            const storageRef = storage.ref();
            const imageRef = storageRef.child(`campaign-images/${auth.currentUser.uid}/${Date.now()}_${coverImage.name}`);
            const uploadTask = imageRef.put(coverImage);
            
            // Wait for upload to complete
            await new Promise((resolve, reject) => {
                uploadTask.on('state_changed',
                    (snapshot) => {
                        // Progress tracking (optional)
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        console.log('Upload is ' + progress + '% done');
                    },
                    (error) => {
                        reject(error);
                    },
                    async () => {
                        // Upload completed successfully
                        imageUrl = await uploadTask.snapshot.ref.getDownloadURL();
                        resolve();
                    }
                );
            });
        }
        
        // Get user data for the campaign
        const userDoc = await db.collection("users").doc(auth.currentUser.uid).get();
        
        const userData = userDoc.exists ? userDoc.data() : {};
        
        // Calculate days remaining
        const endDateTime = new Date(endDate).getTime();
        const todayTime = new Date().getTime();
        const daysRemaining = Math.ceil((endDateTime - todayTime) / (1000 * 60 * 60 * 24));
        
        // Handle different name field possibilities
        let studentName = 'Anonymous Student';
        if (userData.firstName && userData.surname) {
            studentName = `${userData.firstName} ${userData.surname}`;
        } else if (userData.fullName) {
            studentName = userData.fullName;
        } else if (userData.name) {
            studentName = userData.name;
        }
        
        // Create campaign document - USING BOTH student_id AND studentId FOR COMPATIBILITY
        const campaignData = {
            title: title,
            description: description,
            goal_amount: goal,
            raised_amount: 0,
            end_date: endDate,
            category: category,
            story: story,
            image_url: imageUrl,
            student_id: auth.currentUser.uid,  // For your code
            studentId: auth.currentUser.uid,   // For security rules compatibility
            student_name: studentName,
            institution: userData.institution || '',
            field_of_study: userData.course || userData.fieldOfStudy || '',
            status: 'active',
            created_at: firebase.firestore.FieldValue.serverTimestamp(),
            updated_at: firebase.firestore.FieldValue.serverTimestamp(),
            donor_count: 0,
            days_remaining: daysRemaining,
            verified: true
        };
        
        const docRef = await db.collection("campaigns").add(campaignData);
        
        showAlert('Campaign created successfully! Redirecting to your dashboard...', 'success');
        
        // ✅ FIXED: Redirect back to student dashboard instead of donate page
        setTimeout(() => {
            window.location.href = 'student-dashboard.html';
        }, 2000);
        
    } catch (error) {
        console.error("Error creating campaign:", error);
        
        let errorMessage = 'Error creating campaign: ' + error.message;
        
        // Handle specific Firebase errors
        if (error.code === 'permission-denied') {
            errorMessage = 'Permission denied. Please update Firebase security rules to allow campaign creation.';
            showPermissionHelp();
            showFirebaseError(errorMessage);
        } else if (error.code === 'unavailable') {
            errorMessage = 'Network error. Please check your internet connection and try again.';
        }
        
        showAlert(errorMessage, 'danger');
        
        const submitBtn = document.querySelector('.launch-btn');
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Launch Campaign';
    }
}

// Make functions globally available
window.removeImage = removeImage;
</script>

</body>
</html>