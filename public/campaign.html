<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Start a Campaign - FundMyFuture</title>
    
<!-- Firebase modules -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA6ocGvYKnwjc-xmW4j6he-CuTr4je3gko",
    authDomain: "fund-my-future-47844.firebaseapp.com",
    databaseURL: "https://fund-my-future-47844-default-rtdb.firebaseio.com",
    projectId: "fund-my-future-47844",
    storageBucket: "fund-my-future-47844.firebasestorage.app",
    messagingSenderId: "581912293895",
    appId: "1:581912293895:web:03468061fae2124ac770a2",
    measurementId: "G-LFC0R1GBE1"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  let currentUser = null;
  let currentUserId = null;

  document.addEventListener('DOMContentLoaded', function() {
    initializeCampaignPage();
  });

  async function initializeCampaignPage() {
    // Check authentication
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUserId = user.uid;
        await loadUserData(user.uid);
        
        // Add form submission handler
        document.getElementById('campaignForm').addEventListener('submit', handleCampaignSubmit);
        
        // Add image preview
        document.getElementById('coverImage').addEventListener('change', handleImagePreview);
      } else {
        window.location.href = 'login.html';
      }
    });
  }

  async function loadUserData(userId) {
    try {
      const userDoc = await getDoc(doc(db, "users", userId));
      if (userDoc.exists()) {
        currentUser = { id: userDoc.id, ...userDoc.data() };
        displayUserData(currentUser);
      }
    } catch (error) {
      console.error("Error loading user data:", error);
      showAlert('Error loading user data', 'danger');
    }
  }

  function displayUserData(userData) {
    const profileImage = document.querySelector('.profile-card img');
    if (userData.profilePicture) {
      profileImage.src = userData.profilePicture;
    }
    
    document.querySelector('.profile-card h4').textContent = `${userData.firstName || ''} ${userData.surname || ''}`;
    
    const userInfoDiv = document.querySelector('.user-info');
    userInfoDiv.innerHTML = `
      <div class="text-muted"><i class="bi bi-building"></i> ${userData.institution || 'Not specified'}</div>
      <div class="text-muted"><i class="bi bi-book"></i> ${userData.course || 'Not specified'}</div>
      <div class="text-muted"><i class="bi bi-envelope"></i> ${userData.email || 'Not specified'}</div>
    `;
  }

  function handleImagePreview(event) {
    const file = event.target.files[0];
    const preview = document.getElementById('imagePreview');
    
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        preview.innerHTML = `
          <img src="${e.target.result}" class="img-fluid rounded" style="max-height: 200px; width: auto;">
          <button type="button" class="btn btn-sm btn-danger mt-2" onclick="removeImage()">Remove Image</button>
        `;
        preview.classList.remove('d-none');
      };
      reader.readAsDataURL(file);
    }
  }

  function removeImage() {
    document.getElementById('coverImage').value = '';
    document.getElementById('imagePreview').classList.add('d-none');
    document.getElementById('imagePreview').innerHTML = '';
  }

  async function handleCampaignSubmit(e) {
    e.preventDefault();
    
    // Get form values
    const title = document.getElementById('campaignTitle').value.trim();
    const description = document.getElementById('campaignDescription').value.trim();
    const goal = parseFloat(document.getElementById('fundingGoal').value);
    const endDate = document.getElementById('endDate').value;
    const category = document.getElementById('category').value;
    const story = document.getElementById('story').value.trim();
    const coverImage = document.getElementById('coverImage').files[0];
    
    // Validation
    if (!title || title.length < 5) {
      showAlert('Campaign title must be at least 5 characters', 'warning');
      return;
    }
    
    if (!description || description.length < 10) {
      showAlert('Description must be at least 10 characters', 'warning');
      return;
    }
    
    if (!goal || goal < 100) {
      showAlert('Funding goal must be at least R100', 'warning');
      return;
    }
    
    const today = new Date().toISOString().split('T')[0];
    if (endDate <= today) {
      showAlert('Please select a future date for campaign end', 'warning');
      return;
    }
    
    if (!story || story.length < 50) {
      showAlert('Your story should be at least 50 characters to be compelling', 'warning');
      return;
    }
    
    try {
      const submitBtn = document.querySelector('.launch-btn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Creating Campaign...';
      
      let imageUrl = '';
      
      // Upload cover image if provided
      if (coverImage) {
        if (!coverImage.type.startsWith('image/')) {
          throw new Error('Please select a valid image file');
        }
        if (coverImage.size > 5 * 1024 * 1024) {
          throw new Error('Image size should be less than 5MB');
        }
        
        const storageRef = ref(storage, `campaign-images/${currentUserId}/${Date.now()}_${coverImage.name}`);
        await uploadBytes(storageRef, coverImage);
        imageUrl = await getDownloadURL(storageRef);
      }
      
      // Create campaign document
      const campaignData = {
        title: title,
        description: description,
        goalAmount: goal,
        currentAmount: 0,
        endDate: new Date(endDate),
        category: category,
        story: story,
        coverImage: imageUrl,
        studentId: currentUserId,
        status: 'active',
        createdAt: new Date(),
        updatedAt: new Date(),
        donorCount: 0,
        // Additional fields for better display
        daysRemaining: Math.ceil((new Date(endDate) - new Date()) / (1000 * 60 * 60 * 24))
      };
      
      const docRef = await addDoc(collection(db, "campaigns"), campaignData);
      
      showAlert('Campaign created successfully! Redirecting...', 'success');
      
      // Redirect to view the newly created campaign
      setTimeout(() => {
        window.location.href = `view-campaign.html?id=${docRef.id}`;
      }, 2000);
      
    } catch (error) {
      console.error("Error creating campaign:", error);
      showAlert('Error creating campaign: ' + error.message, 'danger');
      
      const submitBtn = document.querySelector('.launch-btn');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Launch Campaign';
    }
  }

  function showAlert(message, type) {
    const existingAlerts = document.querySelectorAll('.custom-alert');
    existingAlerts.forEach(alert => alert.remove());
    
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} custom-alert position-fixed`;
    alertDiv.style.cssText = 'top: 100px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
      if (alertDiv.parentNode) {
        alertDiv.remove();
      }
    }, 5000);
  }

  // Make functions globally available
  window.removeImage = removeImage;
</script>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<!-- Bootstrap Icons for additional icon set -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

<!-- Custom global stylesheet -->
<link rel="stylesheet" href="./css/styles.css">

<style>
.navbar-custom { background-color: #012A4A; height: 90px; }
.navbar-brand { font-weight: bold; color: #A9D6E5; }
.navbar-brand:hover { color: #0077b6; }
.nav-link { color: #CAF0F8 !important; font-weight: 600; margin-right: 15px; }
.nav-link:hover { color: #0077b6 !important; }
.navbar-toggler { border-color: #A9D6E5; background-color: #A9D6E5; }
.navbar-toggler:hover { border-color: #ffd60a; background-color: #ffd60a; transform: scale(1.02); }
.donate-btn { background-color: #00b4d8; color: white; font-weight: bold; }
.donate-btn:hover { background-color: #0077b6; color: #FEFAE0; }
.login-btn { color: #ffd60a; }

.dashboard-container{ max-width:1100px; margin:60px auto; background:#ffffff; border-radius:10px; padding:40px; box-shadow:0 4px 15px rgba(0,0,0,0.1); }
.section-title{ font-weight:700; color:#012A4A; margin-bottom:30px; border-bottom:2px solid #A9D6E5; padding-bottom:10px; }

.profile-card{ background:#A9D6E5; border-radius:10px; padding:30px; text-align:center; color:#012A4A; }
.profile-card img { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; margin-bottom: 20px; }

/* Action button styling for profile actions */
.action-btn {
  background-color: #012A4A;
  border: none;
  border-radius: 5px;
  padding: 10px;
  color: #A9D6E5;
  font-weight: 800;
  font-size: small;
  transition: all 0.3s ease;
  margin-bottom: 10px;
  width: 100%;
}
.action-btn:hover {
  color: #012A4A;
  background-color: #ffd60a;
  transform: scale(1.02); /* Slight scale effect on hover */
}

.campaign-card{ background:#468FAF; border-radius:10px; padding:30px; color:#012A4A; }
.campaign-card label{ font-weight:600; color:#012A4A; display: block; margin-bottom: 5px; }
.campaign-card .form-control, .campaign-card .form-select{ border-radius:8px; margin-bottom:15px; border: 1px solid #012A4A; }

/* Launch campaign button styling */
.launch-btn{
  background-color: #012A4A;
  border: none;
  border-radius: 5px;
  padding: 12px;
  color: #A9D6E5;
  font-weight: 800;
  font-size: medium;
  transition: all 0.3s ease;
  width: 100%;
}
.launch-btn:hover{
  color: #012A4A;
  background-color: #ffd60a;
  transform: scale(1.02);
}
.launch-btn:disabled { opacity: 0.6; cursor: not-allowed; }

.footer { margin-top: 100px; background-color: #468FAF; color: #012A4A; }
.footer a { text-decoration: none; color: inherit; }
.footer a:hover { text-decoration: underline; }
.footer-bottom { background-color: #34637a; color: white; font-size: 0.9rem; }

#imagePreview { border: 2px dashed #012A4A; padding: 20px; text-align: center; border-radius: 8px; }

@media (max-width: 768px) {
  .dashboard-container { margin: 30px 15px; padding: 20px; }
}
</style>
</head>
<body>

<!-- Navigation Bar -->
<nav class="navbar navbar-expand-lg navbar-custom px-3">
  <div class="container-fluid">
    <!-- Brand/Logo -->
    <a class="navbar-brand ms-2" href="index.html">FundMyFuture</a>
    <button class="navbar-toggler text-white" type="button" data-bs-toggle="offcanvas" data-bs-target="#navbarOffcanvas">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="offcanvas offcanvas-end text-bg-dark" tabindex="-1" id="navbarOffcanvas">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title">FundMyFuture</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
      </div>
      <div class="offcanvas-body">
        <ul class="navbar-nav ms-auto align-items-center">
          <!-- Donate button -->
          <li class="nav-item me-3">
            <a class="btn donate-btn ms-2" href="donate.html">DONATE NOW</a>
          </li>
          <!-- Student section link -->
          <li class="nav-item">
            <a class="nav-link" href="sign-up-funderStudent.html">STUDENTS</a>
          </li>
          <!-- Funder section link -->
          <li class="nav-item">
            <a class="nav-link" href="sign-up-funderStudent.html">FUNDERS</a>
          </li>
          <!-- About us link -->
          <li class="nav-item">
            <a class="nav-link" href="about.html">ABOUT US</a>
          </li>
          <!-- Login button -->
          <li class="nav-item me-2" id="login-area">
            <a class="btn login-btn fw-bolder" href="login.html">LOGIN</a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</nav>

<!-- Main Content -->
<div class="dashboard-container">
  <div class="row g-4">
    <!-- Left Profile -->
    <div class="col-md-4">
      <div class="profile-card">
        <img src="assets/profile-user.png" class="rounded-circle" alt="Profile Picture">
        <h4 class="fw-bold">Loading...</h4>
        <div class="user-info d-flex flex-column align-items-center text-center mb-4">
          <div class="text-muted">Loading user data...</div>
        </div>
        <button class="action-btn" onclick="window.location.href='student-dashboard.html'">My Dashboard</button>
        <button class="action-btn" onclick="window.location.href='student-dashboard.html'">My Campaigns</button>
        <button class="action-btn" onclick="window.location.href='donate.html'">Browse Campaigns</button>
      </div>
    </div>

    <!-- Right Campaign Form -->
    <div class="col-md-8">
      <div class="campaign-card">
        <!-- Form Title -->
        <h3 class="section-title text-center fw-bold">Create New Campaign</h3>
        <form id="campaignForm">
          <label for="campaignTitle" class="mb-2">Campaign Title *</label>
          <input type="text" id="campaignTitle" class="form-control" placeholder="Enter a catchy title for your campaign" required minlength="5">
          <small class="text-muted">Minimum 5 characters</small>

          <label for="campaignDescription" class="mb-2 mt-3">Short Description *</label>
          <input type="text" id="campaignDescription" class="form-control" placeholder="Brief summary of your campaign" required minlength="10">
          <small class="text-muted">Minimum 10 characters</small>

          <label for="fundingGoal" class="mb-2 mt-3">Funding Goal (ZAR) *</label>
          <input type="number" id="fundingGoal" class="form-control" placeholder="e.g. 5000" min="100" step="100" required>
          <small class="text-muted">Minimum R100</small>

          <label for="endDate" class="mb-2 mt-3">Campaign End Date *</label>
          <input type="date" id="endDate" class="form-control" min="" required>
          <small class="text-muted">Select a future date</small>

          <label for="category" class="mb-2 mt-3">Category *</label>
          <select id="category" class="form-select" required>
            <option value="">Select a category</option>
            <option value="Tuition">Tuition Fees</option>
            <option value="Books & Supplies">Books & Supplies</option>
            <option value="Living Expenses">Living Expenses</option>
            <option value="Technology">Technology & Equipment</option>
            <option value="Other">Other Educational Needs</option>
          </select>

          <label for="story" class="mb-2 mt-3">Your Story *</label>
          <textarea id="story" class="form-control" rows="6" placeholder="Share your educational journey, challenges, and how this funding will help you achieve your goals..." required minlength="50"></textarea>
          <small class="text-muted">Minimum 50 characters. Be authentic and compelling!</small>

          <label for="coverImage" class="mb-2 mt-3">Upload Cover Image</label>
          <input type="file" id="coverImage" class="form-control" accept="image/*">
          <small class="text-muted">Optional. JPG, PNG up to 5MB</small>

          <div id="imagePreview" class="d-none mt-3"></div>

          <button type="submit" class="launch-btn mt-4">Launch Campaign</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Footer Section -->
<footer class="footer pt-5">

  <!-- Main container for footer content -->
  <div class="container pb-4">
    
    <div class="row">
      <div class="col-md-6 mb-4">
        <h5 class="fw-bold">Stay Connected</h5>
        <p class="mb-3">Sign up for our newsletter to stay informed.</p>
        <form class="d-flex">
          <input type="email" class="form-control me-2 rounded-3" placeholder="Enter email . . .">
          <button type="submit" class="btn sign-up-btn">SIGN UP</button>
        </form>
      </div>
      <div class="col-md-6 mb-4 text-md-end">
        <h5 class="fw-bold follow-us">Follow us</h5>
        <div class="social-icons mt-2">
          <!-- Instagram social media link -->
          <a href="https://www.instagram.com/thisisrichfield/?hl=en" target="_blank" rel="noopener noreferrer" class="text-decoration-none">
            <i class="fab fa-instagram"></i>
          </a>
          <!-- Facebook social media link -->
          <a href="https://www.facebook.com/thisisrichfield/" target="_blank" rel="noopener noreferrer" class="text-decoration-none">
            <i class="fab fa-facebook"></i>
          </a>
          <!-- LinkedIn social media link -->
          <a href="https://www.linkedin.com/school/richfieldeducation/posts/?feedView=all" target="_blank" rel="noopener noreferrer" class="text-decoration-none">
            <i class="fab fa-linkedin"></i>
          </a>
        </div>
      </div>

    </div>
    <hr>
    <div class="row text-start text-md-start">
      <div class="col-6 col-md-3 mb-4">
        <h6 class="fw-bold">Navigate</h6>
        <ul class="list-unstyled">
          <li><a href="index.html">Home</a></li>
          <li><a href="donate.html">Donate</a></li>
          <li><a href="campaign.html">Campaigns</a></li>
          <li><a href="about.html">About</a></li>
        </ul>
      </div>
      <div class="col-6 col-md-3 mb-4">
        <h6 class="fw-bold">Company</h6>
        <ul class="list-unstyled">
          <li><a href="contact.html">Contact us</a></li>
          <li><a href="faq.html">FAQ's</a></li>
        </ul>
      </div>
      <div class="col-md-6 mb-4">
        <h6 class="fw-bold">Contact</h6>
        <p class="mb-1">5th floor 112 Long St, Cape Town, 8000</p>
        <p class="mb-1">Western Cape</p>
        <p class="mb-1">+27 21 831 0700</p>
        <p class="mb-0">fundmyfuture@gmail.com</p>
      </div>

    </div>
  </div>
  <div class="footer-bottom py-3">
    <div class="container d-flex flex-column flex-md-row justify-content-between align-items-center">
      
      <!-- Legal & policy links -->
      <div class="mb-2 mb-md-0">
        <a href="terms.html" class="me-3 text-white">Terms & Conditions</a>
        <a href="privacy.html" class="me-3 text-white">Privacy Policy</a>
      </div>

      <!-- Copyright notice -->
      <div class="text-white">&copy;2025 FundMyFuture</div>
    </div>
  </div>

</footer>

<!-- Bootstrap JavaScript for interactive components -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Set minimum date for end date field
  document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('endDate').min = today;
  });
</script>
</body>
</html>