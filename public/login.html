<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - FundMyFuture</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <!-- Firebase configuration -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA6ocGvYKnwjc-xmW4j6he-CuTr4je3gko",
      authDomain: "fund-my-future-47844.firebaseapp.com",
      databaseURL: "https://fund-my-future-47844-default-rtdb.firebaseio.com",
      projectId: "fund-my-future-47844",
      storageBucket: "fund-my-future-47844.firebasestorage.app",
      messagingSenderId: "581912293895",
      appId: "1:581912293895:web:03468061fae2124ac770a2",
      measurementId: "G-LFC0R1GBE1"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);

    // Set session persistence and clear any existing auth state
    firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION)
      .then(() => {
        console.log("Session persistence enabled");
        // Clear any existing authentication on page load for security
        return firebase.auth().signOut();
      })
      .then(() => {
        console.log("Authentication cleared on page load");
        // Clear all localStorage items
        const itemsToRemove = [
          'userType', 'userName', 'userUID', 'userEmail', 
          'verificationStatus', 'hasAllDocuments',
          'studentDocuments', 'studentProfile', 
          'funderDocuments', 'funderProfile'
        ];
        itemsToRemove.forEach(item => localStorage.removeItem(item));
      })
      .catch(error => {
        console.log("Error setting persistence or signing out:", error);
      });
  </script>

  <!-- BOOTSTRAP -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  
  <!-- Custom global stylesheet -->
  <link rel="stylesheet" href="./css/styles.css">

<style>
@keyframes move {
    100% {
        transform: translate3d(0, 0, 1px) rotate(360deg);
    }
}

/* Background container for animated elements */
.background {
  position: fixed;
  width: 100vw;
  height: 100vh;
  top: 0;
  left: 0;
  background: #89C2D9;
  overflow: hidden;
  z-index: -1;
}

/* Individual animated background elements */
.background span {
  width: 22vmin;
  height: 22vmin;
  border-radius: 22vmin;
  backface-visibility: hidden;
  position: absolute;
  animation: move;
  animation-duration: 27;
  animation-timing-function: linear;
  animation-iteration-count: infinite;
}

/* Individual background element configurations with unique colors, positions, and animations */
.background span:nth-child(0) {
  color: #ffda1f;
  top: 20%;
  left: 68%;
  animation-duration: 101s;
  animation-delay: -91s;
  transform-origin: 0vw 25vh;
  box-shadow: -44vmin 0 6.3375600978849445vmin currentColor;
}

.background span:nth-child(1) {
  color: #01497C;
  top: 61%;
  left: 85%;
  animation-duration: 185s;
  animation-delay: -215s;
  transform-origin: 9vw 24vh;
  box-shadow: 44vmin 0 6.103280164210709vmin currentColor;
}

.background span:nth-child(2) {
  color: #012A4A;
  top: 9%;
  left: 22%;
  animation-duration: 50s;
  animation-delay: -63s;
  transform-origin: 16vw 5vh;
  box-shadow: -44vmin 0 5.618068011611789vmin currentColor;
}

.background span:nth-child(3) {
  color: #012A4A;
  top: 88%;
  left: 57%;
  animation-duration: 217s;
  animation-delay: -64s;
  transform-origin: 3vw 17vh;
  box-shadow: 44vmin 0 5.680647903030968vmin currentColor;
}

.background span:nth-child(4) {
  color: #012A4A;
  top: 77%;
  left: 86%;
  animation-duration: 24s;
  animation-delay: -67s;
  transform-origin: 8vw -12vh;
  box-shadow: 44vmin 0 5.755161839497089vmin currentColor;
}

.background span:nth-child(5) {
  color: #2C7DA0;
  top: 17%;
  left: 89%;
  animation-duration: 146s;
  animation-delay: -100s;
  transform-origin: 9vw 8vh;
  box-shadow: 44vmin 0 6.100686382029543vmin currentColor;
}

.background span:nth-child(6) {
  color: #ffda1f;
  top: 50%;
  left: 21%;
  animation-duration: 28s;
  animation-delay: -222s;
  transform-origin: -23vw 14vh;
  box-shadow: 44vmin 0 6.388179272770869vmin currentColor;
}

.background span:nth-child(7) {
  color: #ffda1f;
  top: 49%;
  left: 3%;
  animation-duration: 175s;
  animation-delay: -58s;
  transform-origin: -1vw -22vh;
  box-shadow: -44vmin 0 5.779971151878453vmin currentColor;
}

.background span:nth-child(8) {
  color: #ffda1f;
  top: 69%;
  left: 74%;
  animation-duration: 109s;
  animation-delay: -90s;
  transform-origin: 2vw 9vh;
  box-shadow: 44vmin 0 5.976923744252923vmin currentColor;
}

.background span:nth-child(9) {
  color: #2C7DA0;
  top: 79%;
  left: 55%;
  animation-duration: 151s;
  animation-delay: -127s;
  transform-origin: -18vw 6vh;
  box-shadow: 44vmin 0 6.489381584800661vmin currentColor;
}

.background span:nth-child(10) {
  color: #2C7DA0;
  top: 26%;
  left: 98%;
  animation-duration: 106s;
  animation-delay: -10s;
  transform-origin: 14vw 3vh;
  box-shadow: -44vmin 0 6.296005667875951vmin currentColor;
}

.background span:nth-child(11) {
  color: #2C7DA0;
  top: 33%;
  left: 43%;
  animation-duration: 75s;
  animation-delay: -87s;
  transform-origin: -18vw -13vh;
  box-shadow: -44vmin 0 6.2616309952643565vmin currentColor;
}

/* ===== LOGIN CARD STYLING ===== */
/* Main login card with brand colors and prominent shadow */
.login-card {
  background-color: #A9D6E5;
  color: #012A4A;
  box-shadow: rgba(0, 0, 0, 0.3) 0px 19px 38px, rgba(0, 0, 0, 0.22) 0px 15px 12px;
  border: 12px solid #012A4A;
}

/* ===== BUTTON STYLING ===== */
/* Primary login button styling */
.btn-login {
  background-color: #012A4A;
  color: #A9D6E5;
  font-weight: bold;
  transition: all 0.3s ease;
}

/* Login button hover effects */
.btn-login:hover {
  background-color: #ffda1f;
  color: #012A4A;
  transform: translateY(-2px);
}

/* Forgot password link styling */
.forgot {
  color: #012A4A;
  text-decoration: none;
}

.forgot:hover {
  text-decoration: underline;
  color: #01497C;
}

/* Social login button styling */
.btn-facebook {
  background-color: #012A4A;
  color: #A9D6E5;
  transition: all 0.3s ease;
}

.btn-facebook:hover {
  background-color: #1877F2;
  color: white;
  transform: translateY(-2px);
}

.btn-google {
  background-color: #012A4A;
  color: #A9D6E5;
  transition: all 0.3s ease;
}

.btn-google:hover {
  background-color: #DB4437;
  color: white;
  transform: translateY(-2px);
}

.btn-apple {
  background-color: #012A4A;
  color: #A9D6E5;
  transition: all 0.3s ease;
}

.btn-apple:hover {
  background-color: #000000;
  color: white;
  transform: translateY(-2px);
}

.alert-container {
  position: fixed;
  top: 100px;
  right: 20px;
  z-index: 1050;
  max-width: 400px;
}

.form-alert {
  animation: slideIn 0.5s ease-out;
}

@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.loading-spinner {
  display: none;
}

.is-invalid {
  border-color: #dc3545;
}

.is-valid {
  border-color: #198754;
}

.invalid-feedback {
  display: none;
  width: 100%;
  margin-top: 0.25rem;
  font-size: 0.875em;
  color: #dc3545;
}

.was-validated .form-control:invalid ~ .invalid-feedback,
.form-control.is-invalid ~ .invalid-feedback {
  display: block;
}

/* Enhanced error styling for credentials */
.credentials-error {
  color: #dc3545;
  font-size: 0.875em;
  margin-top: 0.25rem;
  display: none;
}

.credentials-error.show {
  display: block;
}

.form-feedback {
  margin-top: 1rem;
  padding: 0.75rem;
  border-radius: 0.375rem;
  display: none;
}

.form-feedback.show {
  display: block;
}

.form-feedback.error {
  background-color: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}

.form-feedback.success {
  background-color: #d1edff;
  color: #0c5460;
  border: 1px solid #bee5eb;
}

/* Firebase permission warning */
.firebase-permission-warning {
  background: #fff3cd;
  border: 1px solid #ffeaa7;
  border-radius: 5px;
  padding: 15px;
  margin: 15px 0;
  font-size: 0.9em;
}

/* Security notice styling */
.security-notice {
  background: #d1edff;
  border: 1px solid #bee5eb;
  border-radius: 5px;
  padding: 10px;
  margin: 10px 0;
  font-size: 0.85em;
  text-align: center;
}

/* Social login button styling */
.social-login-btn {
  width: 50px;
  height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  border: 2px solid #012A4A;
  transition: all 0.3s ease;
  cursor: pointer;
}

.social-login-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

/* Social login loading state */
.social-login-loading {
  position: relative;
  pointer-events: none;
}

.social-login-loading::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 20px;
  height: 20px;
  margin: -10px 0 0 -10px;
  border: 2px solid transparent;
  border-top: 2px solid currentColor;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
</head>
<body class="bg-light">

<!-- Alert Container for Messages -->
<div class="alert-container" id="alertContainer"></div>

<div class="background">
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
</div>

<div class="background">
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
</div>

<!-- Navigation Bar -->
<nav class="navbar navbar-expand-lg navbar-custom px-3">
  <div class="container-fluid">
    <!-- Brand/Logo linking to homepage -->
    <a class="navbar-brand ms-2" href="index.html">FundMyFuture</a>

    <!-- Mobile menu toggle button -->
    <button class="navbar-toggler text-white" type="button" data-bs-toggle="offcanvas" data-bs-target="#navbarOffcanvas">
      <span class="navbar-toggler-icon"></span>
    </button>

    <!-- Offcanvas navigation menu for mobile devices -->
    <div class="offcanvas offcanvas-end text-bg-dark" tabindex="-1" id="navbarOffcanvas">
      <div class="offcanvas-header">
        <!-- Close button for offcanvas menu -->
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
      </div>
      <div class="offcanvas-body">
        <ul class="navbar-nav ms-auto align-items-center" id="navList">
          <!-- Default navigation items will be populated by JavaScript -->
        </ul>
      </div>
    </div>
  </div>
</nav>

<!-- Login -->
<div class="container d-flex justify-content-center align-items-center vh-100">
  <div class="login-card rounded p-4" style="width: 100%; max-width: 400px;">
      <!-- Login Title -->
      <h1 class="text-center mb-4 fw-bold">Login</h1>
      
      <!-- Firebase Permission Warning -->
      <div class="firebase-permission-warning d-none" id="firebasePermissionWarning">
        <strong>Firebase Permission Issue:</strong> 
        <p class="mb-1">There might be a configuration issue. You can still log in, but some features may not work properly.</p>
        <small>Please contact support if this persists.</small>
      </div>
      
      <!-- Login Form -->
    <form id="loginForm" novalidate>
      <!-- Form feedback message -->
      <div id="formFeedback" class="form-feedback"></div>
      
      <div class="mb-3">
        <label for="email" class="form-label">Email address</label>
        <input type="email" class="form-control" id="email" placeholder="you@example.com" required>
        <div class="invalid-feedback">Please provide a valid email address.</div>
        <div id="emailCredentialsError" class="credentials-error">No account found with this email address.</div>
      </div>
      <!-- Password Input Field -->
      <div class="mb-3">
        <label for="password" class="form-label">Password</label>
        <input type="password" class="form-control" id="password" placeholder="••••••••" required minlength="6">
        <div class="invalid-feedback">Password must be at least 6 characters long.</div>
        <div id="passwordCredentialsError" class="credentials-error">Incorrect password. Please try again.</div>
      </div>

      <!-- Forgot Password Link -->
      <!-- Right-aligned and smaller text for password recovery -->
      <div class="d-flex justify-content-end mb-3">
        <a class="forgot small" href="forgot-password.html">Forgot password?</a>
      </div>

      <!-- Login Button -->
      <div class="d-grid mb-3">
        <button type="submit" class="btn btn-login fw-bold" id="loginButton">
          <span class="loading-spinner" id="loginSpinner">
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            Signing in...
          </span>
          <span id="loginText">Login</span>
        </button>
      </div>

      <!-- Divider for Social Login Options -->
      <div class="d-flex align-items-center my-3">
        <hr class="flex-grow-1">
        <span class="mx-2 small text-muted">or</span>
        <hr class="flex-grow-1">
      </div>

      <!-- Social Login Buttons -->
      <div class="d-flex justify-content-center gap-3 mb-4">
        <!-- Google Login -->
        <button type="button" class="social-login-btn btn-google" id="googleLoginBtn" title="Sign in with Google">
          <i class="fab fa-google"></i>
        </button>
        <!-- Facebook Login -->
        <button type="button" class="social-login-btn btn-facebook" id="facebookLoginBtn" title="Sign in with Facebook">
          <i class="fab fa-facebook-f"></i>
        </button>
        <!-- Apple Login -->
        <button type="button" class="social-login-btn btn-apple" id="appleLoginBtn" title="Sign in with Apple">
          <i class="fab fa-apple"></i>
        </button>
      </div>

      <!-- Registration Prompt -->
      <!-- Link to sign-up page for new users -->
      <div class="text-center mt-4">
        <p class="small">Don't have an account? <a href="sign-up-funderStudent.html" class="fw-bold">Sign Up</a></p>
      </div>
    </form>
  </div>
</div>

<!-- Footer -->
<footer class="footer pt-5">

  <!-- Main container for footer content -->
  <div class="container pb-4">
    
    <div class="row">
      
      <!-- Newsletter Signup Column -->
      <div class="col-md-6 mb-4">
        <h5 class="fw-bold">Stay Connected</h5>
        <p class="mb-3">Sign up for our newsletter to stay informed.</p>
        <!-- Newsletter Form -->
        <form id="newsletterForm" class="d-flex icon-input-group">
          <!-- Envelope icon inside input field for visual context -->
          <i class="fa-regular fa-envelope"></i>
          <!-- Email input field for newsletter subscription -->
          <input type="email" id="newsletterEmail" class="form-control me-2 rounded-3" placeholder="Enter email . . ." required>
          <!-- Submit button for newsletter signup -->
          <button type="submit" class="btn btn-outline-primary px-3 sign-up-btn" id="subscribeBtn">
            SIGN UP
          </button>
        </form>

        <!-- Message display area -->
        <div id="newsletterMessage" class="mt-2"></div>

      </div>

      <!-- Social Media Column -->
      <div class="col-md-6 mb-4 text-md-end">
        <h5 class="fw-bold follow-us">Follow us</h5>
        <div class="social-icons mt-2">
          <!-- Instagram social media link -->
          <a href="https://www.instagram.com/thisisrichfield/?hl=en" target="_blank" rel="noopener noreferrer" class="text-decoration-none">
            <i class="fab fa-instagram"></i>
          </a>
          <!-- Facebook social media link -->
          <a href="https://www.facebook.com/thisisrichfield/" target="_blank" rel="noopener noreferrer" class="text-decoration-none">
            <i class="fab fa-facebook"></i>
          </a>
          <!-- LinkedIn social media link -->
          <a href="https://www.linkedin.com/school/richfieldeducation/posts/?feedView=all" target="_blank" rel="noopener noreferrer" class="text-decoration-none">
            <i class="fab fa-linkedin"></i>
          </a>
        </div>
      </div>

    </div>

    <hr> <!-- Horizontal separator line between sections -->

    <div class="row text-start text-md-start">

      <!-- Navigate Links Column -->
      <div class="col-6 col-md-3 mb-4">
        <h6 class="fw-bold">Navigate</h6>
        <ul class="list-unstyled">
          <li><a href="index.html">Home</a></li>
          <li><a href="donate.html">Donate</a></li>
          <li><a href="story.html">Stories</a></li>
          <li><a href="about.html">About</a></li>
        </ul>
      </div>

      <!-- Company Links Column -->
      <div class="col-6 col-md-3 mb-4">
        <h6 class="fw-bold">Company</h6>
        <ul class="list-unstyled">
          <li><a href="contact.html">Contact us</a></li>
          <li><a href="faq.html">FAQ's</a></li>
        </ul>
      </div>

      <!-- Contact Info Column -->
      <div class="col-md-6 mb-4">
        <h6 class="fw-bold">Contact</h6>
        <!-- Address with clickable Google Maps link for easy directions -->
        <p class="mb-1">
          <a href="https://www.google.com/maps/place/Richfield+Cape+Town+Campus/@-33.9229995,18.4134391,17z/data=!3m1!4b1!4m6!3m5!1s0x1dcc6763f48a57fd:0x167125f9a04d06ff!8m2!3d-33.923004!4d18.41831!16s%2Fg%2F1hhh2yjf_?entry=ttu&g_ep=EgoyMDI1MTAyMi.4wIKXMDSoASAFQAw%3D%3D" target="_blank">
            5th floor 112 Long St <br> 
            Cape Town <br> 
            8000 <br> 
            Western Cape
          </a>
        </p>
        <!-- Phone number link for direct calling capability -->
        <p class="mb-1"><a href="tel:+27218310700">+27 21 831 0700</a></p>
        <!-- Email link for direct communication -->
        <p class="mb-0"><a href="mailto:fundmyfuture7@gmail.com">fundmyfuture7@gmail.com</a></p>
      </div>

    </div>
  </div> <!-- End container -->

  <!-- Footer Bottom Bar -->
  <div class="footer-bottom py-3">
    <div class="container d-flex flex-column flex-md-row justify-content-between align-items-center">
      
      <!-- Legal & policy links for compliance and user information -->
      <div class="mb-2 mb-md-0">
        <a href="terms.html" class="me-3 text-white">Terms & Conditions</a>
        <a href="privacy.html" class="me-3 text-white">Privacy Policy</a>
        <a href="cookies.html" class="me-3 text-white">Cookies Policy</a>
        <a href="cookies_settings.html" class="text-white">Cookies Settings</a>
      </div>

      <!-- Copyright notice -->
      <div class="text-white">&copy;2025 FundMyFuture</div>
    </div>
  </div>

</footer>

<!-- Bootstrap + Font Awesome JavaScript for interactive components -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Newsletter Script -->
<script src="./js/newsletter.js"></script>
<!-- Firebase Login Authentication -->
<script>
// Firebase Login Authentication
document.addEventListener('DOMContentLoaded', function() {
    // Get Firebase services
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Clear all localStorage items on page load for security
    function clearLocalStorage() {
        const itemsToRemove = [
            'userType', 'userName', 'userUID', 'userEmail', 
            'verificationStatus', 'hasAllDocuments',
            'studentDocuments', 'studentProfile', 
            'funderDocuments', 'funderProfile'
        ];
        itemsToRemove.forEach(item => localStorage.removeItem(item));
        console.log("Local storage cleared for security");
    }

    // Clear storage immediately on page load
    clearLocalStorage();

    // Check if user is already logged in (only for current session)
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            console.log("User found in current session, checking user type...");
            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    const userType = userData.userType || 'student';
                    
                    // Store user data for current session only
                    await storeUserData(user, userData);
                    
                    // Update navbar for current session
                    updateNavbar(userData.firstName || 'User', userType);
                    
                    // Redirect to appropriate page based on user type
                    redirectAfterLogin(userType);
                }
            } catch (error) {
                console.error("Error checking user data:", error);
                // If error, clear everything and show login
                await auth.signOut();
                clearLocalStorage();
                showDefaultNavbar();
            }
        } else {
            // No user in current session, ensure clean state
            clearLocalStorage();
            showDefaultNavbar();
        }
    });

    // Form elements
    const loginForm = document.getElementById("loginForm");
    const loginButton = document.getElementById("loginButton");
    const loginSpinner = document.getElementById("loginSpinner");
    const loginText = document.getElementById("loginText");

    // Social login buttons
    const googleLoginBtn = document.getElementById("googleLoginBtn");
    const facebookLoginBtn = document.getElementById("facebookLoginBtn");
    const appleLoginBtn = document.getElementById("appleLoginBtn");

    // Store user data function (session only)
    async function storeUserData(user, userData) {
        const firstName = userData.firstName || userData.name || userData.fullName || 'User';
        const userType = userData.userType || userData.role || 'student';
        
        localStorage.setItem('userType', userType);
        localStorage.setItem('userName', firstName);
        localStorage.setItem('userUID', user.uid);
        localStorage.setItem('userEmail', user.email);
        
        // Store additional data based on user type
        if (userType === 'student') {
            localStorage.setItem('verificationStatus', userData.verificationStatus || 'pending');
            localStorage.setItem('hasAllDocuments', hasAllRequiredDocuments(userData).toString());
            
            if (userData.documents) {
                localStorage.setItem('studentDocuments', JSON.stringify(userData.documents));
            }
            if (userData.profile) {
                localStorage.setItem('studentProfile', JSON.stringify(userData.profile));
            }
        }
        
        if (userType === 'funder') {
            if (userData.documents) {
                localStorage.setItem('funderDocuments', JSON.stringify(userData.documents));
            }
            if (userData.profile) {
                localStorage.setItem('funderProfile', JSON.stringify(userData.profile));
            }
        }
    }

    // Show/hide permission warning
    function showPermissionWarning() {
        const warning = document.getElementById('firebasePermissionWarning');
        if (warning) warning.classList.remove('d-none');
    }
    
    function hidePermissionWarning() {
        const warning = document.getElementById('firebasePermissionWarning');
        if (warning) warning.classList.add('d-none');
    }

    // Validate email
    function validateEmail(email){
        const regex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        return regex.test(email);
    }

    // Form validation
    function validateForm(){
        let valid = true;
        const email = document.getElementById("email");
        const password = document.getElementById("password");
        
        // Clear previous validation states
        email.classList.remove('is-valid','is-invalid');
        password.classList.remove('is-valid','is-invalid');
        clearCredentialErrors();
        hideFormFeedback();
        hidePermissionWarning();

        if(!email.value || !validateEmail(email.value)){
            email.classList.add('is-invalid'); 
            valid = false;
        } else { 
            email.classList.add('is-valid'); 
        }

        if(!password.value || password.value.length<6){
            password.classList.add('is-invalid'); 
            valid = false;
        } else { 
            password.classList.add('is-valid'); 
        }

        return valid;
    }

    // Reset login button
    function resetLoginButton(){
        loginButton.disabled=false;
        loginSpinner.style.display='none';
        loginText.style.display='inline';
    }

    // Clear credential errors
    function clearCredentialErrors() {
        const emailError = document.getElementById('emailCredentialsError');
        const passwordError = document.getElementById('passwordCredentialsError');
        if (emailError) emailError.classList.remove('show');
        if (passwordError) passwordError.classList.remove('show');
    }

    // Hide form feedback
    function hideFormFeedback() {
        const feedback = document.getElementById('formFeedback');
        if (feedback) feedback.classList.remove('show');
    }

    // Enhanced admin validation function
    async function validateAdminAccess(userId) {
        try {
            const adminDoc = await db.collection('users').doc(userId).get();
            if (adminDoc.exists) {
                const adminData = adminDoc.data();
                
                // Check multiple conditions for admin access
                return adminData.userType === 'admin' && 
                       adminData.hasAdminAccess === true;
            }
            return false;
        } catch (error) {
            console.error('Admin validation error:', error);
            return false;
        }
    }

    // Function to check if student has all required documents uploaded
    function hasAllRequiredDocuments(studentData) {
        const documents = studentData.documents || {};
        return documents.idDocument && 
               documents.proofOfRegistration && 
               documents.feeStatement;
    }

    // Function to redirect after login based on user type
    function redirectAfterLogin(userType) {
        let redirectPage = 'index.html'; // Default for students and funders
        
        if (userType === 'admin') {
            redirectPage = 'admin-dashboard.html';
        }
        // Students and funders go to homepage (index.html)
        
        console.log(`Redirecting ${userType} to: ${redirectPage}`);
        window.location.href = redirectPage;
    }

    // Enhanced error handling for Firebase authentication
    function handleFirebaseAuthError(error) {
        console.error("Firebase Auth Error:", error.code, error.message);
        
        const errorMap = {
            'auth/invalid-email': {
                message: 'Invalid email address format.',
                field: 'email',
                showFieldError: true
            },
            'auth/user-disabled': {
                message: 'This account has been disabled. Please contact support.',
                field: 'email',
                showFieldError: true
            },
            'auth/user-not-found': {
                message: 'No account found with this email address.',
                field: 'email',
                showFieldError: true
            },
            'auth/wrong-password': {
                message: 'Incorrect password. Please try again.',
                field: 'password',
                showFieldError: true
            },
            'auth/invalid-credential': {
                message: 'Invalid login credentials. Please check your email and password.',
                field: 'both',
                showFieldError: true
            },
            'auth/too-many-requests': {
                message: 'Too many failed login attempts. Please try again later or reset your password.',
                field: 'both',
                showFieldError: false
            },
            'auth/network-request-failed': {
                message: 'Network error. Please check your internet connection and try again.',
                field: 'both',
                showFieldError: false
            },
            'auth/operation-not-allowed': {
                message: 'Email/password login is not enabled. Please contact support.',
                field: 'both',
                showFieldError: false
            },
            'auth/user-token-expired': {
                message: 'Your session has expired. Please log in again.',
                field: 'both',
                showFieldError: false
            },
            'auth/requires-recent-login': {
                message: 'Please log in again to perform this action.',
                field: 'both',
                showFieldError: false
            }
        };

        const errorInfo = errorMap[error.code] || {
            message: 'Login failed. Please try again.',
            field: 'both',
            showFieldError: false
        };

        // Show field-specific errors if applicable
        if (errorInfo.showFieldError) {
            if (errorInfo.field === 'email' || errorInfo.field === 'both') {
                const emailError = document.getElementById('emailCredentialsError');
                if (emailError) {
                    emailError.textContent = errorInfo.message;
                    emailError.classList.add('show');
                }
            }
            
            if (errorInfo.field === 'password' || errorInfo.field === 'both') {
                const passwordError = document.getElementById('passwordCredentialsError');
                if (passwordError) {
                    passwordError.textContent = errorInfo.message;
                    passwordError.classList.add('show');
                }
            }
        }

        // Show main alert message
        showAlert(errorInfo.message, 'error');
        
        return errorInfo;
    }

    // Handle login with session persistence
    async function handleLogin(){
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        try {
            loginButton.disabled=true;
            loginSpinner.style.display='inline';
            loginText.style.display='none';
            clearCredentialErrors();
            hideFormFeedback();
            hidePermissionWarning();

            console.log("Attempting login for:", email);
            
            // Verify Firebase is properly initialized
            if (!firebase.apps.length) {
                throw new Error('Firebase not properly initialized');
            }

            // Use session persistence for security
            await auth.setPersistence(firebase.auth.Auth.Persistence.SESSION);
            
            const userCredential = await auth.signInWithEmailAndPassword(email, password);
            const user = userCredential.user;
            console.log("Login successful, user ID:", user.uid);

            // Check if email is verified
            if (user.emailVerified === false) {
                console.warn("User email not verified");
                showAlert('Please verify your email address for full access.', 'warning');
            }

            // Get user data from Firestore and store in localStorage for current session
            const userDoc = await db.collection('users').doc(user.uid).get();
            if (userDoc.exists) {
                const userData = userDoc.data();
                await storeUserData(user, userData);
                
                console.log("Login successful! Redirecting...");
                showAlert('Login successful! Redirecting...', 'success');
                
                const userType = userData.userType || 'student';
                
                setTimeout(() => {
                    redirectAfterLogin(userType);
                }, 1000);
            } else {
                throw new Error('User document not found');
            }

        } catch(error){
            console.error("Login error:", error);
            resetLoginButton();
            handleFirebaseAuthError(error);
        }
    }

    // ===== SOCIAL LOGIN FUNCTIONS =====

    // Handle Google Login
    async function handleGoogleLogin() {
        try {
            // Show loading state
            googleLoginBtn.classList.add('social-login-loading');
            googleLoginBtn.disabled = true;
            
            // Set persistence for session
            await auth.setPersistence(firebase.auth.Auth.Persistence.SESSION);
            
            // Create Google provider
            const provider = new firebase.auth.GoogleAuthProvider();
            
            // Add scopes if needed
            provider.addScope('email');
            provider.addScope('profile');
            
            // Sign in with popup
            const result = await auth.signInWithPopup(provider);
            const user = result.user;
            
            console.log("Google login successful:", user);
            
            // Check if user exists in Firestore
            const userDoc = await db.collection('users').doc(user.uid).get();
            
            if (userDoc.exists) {
                // Existing user - store data and redirect
                const userData = userDoc.data();
                await storeUserData(user, userData);
                
                showAlert('Google login successful! Redirecting...', 'success');
                
                const userType = userData.userType || 'student';
                setTimeout(() => {
                    redirectAfterLogin(userType);
                }, 1000);
            } else {
                // New user - create user document
                await createUserFromSocialLogin(user, 'google');
            }
            
        } catch (error) {
            console.error("Google login error:", error);
            handleSocialLoginError(error, 'Google');
        } finally {
            // Reset button state
            googleLoginBtn.classList.remove('social-login-loading');
            googleLoginBtn.disabled = false;
        }
    }

    // Handle Facebook Login
    async function handleFacebookLogin() {
        try {
            // Show loading state
            facebookLoginBtn.classList.add('social-login-loading');
            facebookLoginBtn.disabled = true;
            
            // Set persistence for session
            await auth.setPersistence(firebase.auth.Auth.Persistence.SESSION);
            
            // Create Facebook provider
            const provider = new firebase.auth.FacebookAuthProvider();
            
            // Add scopes
            provider.addScope('email');
            provider.addScope('public_profile');
            
            // Sign in with popup
            const result = await auth.signInWithPopup(provider);
            const user = result.user;
            
            console.log("Facebook login successful:", user);
            
            // Check if user exists in Firestore
            const userDoc = await db.collection('users').doc(user.uid).get();
            
            if (userDoc.exists) {
                // Existing user - store data and redirect
                const userData = userDoc.data();
                await storeUserData(user, userData);
                
                showAlert('Facebook login successful! Redirecting...', 'success');
                
                const userType = userData.userType || 'student';
                setTimeout(() => {
                    redirectAfterLogin(userType);
                }, 1000);
            } else {
                // New user - create user document
                await createUserFromSocialLogin(user, 'facebook');
            }
            
        } catch (error) {
            console.error("Facebook login error:", error);
            handleSocialLoginError(error, 'Facebook');
        } finally {
            // Reset button state
            facebookLoginBtn.classList.remove('social-login-loading');
            facebookLoginBtn.disabled = false;
        }
    }

    // Handle Apple Login
    async function handleAppleLogin() {
        try {
            // Show loading state
            appleLoginBtn.classList.add('social-login-loading');
            appleLoginBtn.disabled = true;
            
            // Set persistence for session
            await auth.setPersistence(firebase.auth.Auth.Persistence.SESSION);
            
            // Create Apple provider
            const provider = new firebase.auth.OAuthProvider('apple.com');
            
            // Add scopes
            provider.addScope('email');
            provider.addScope('name');
            
            // Sign in with popup
            const result = await auth.signInWithPopup(provider);
            const user = result.user;
            
            console.log("Apple login successful:", user);
            
            // Check if user exists in Firestore
            const userDoc = await db.collection('users').doc(user.uid).get();
            
            if (userDoc.exists) {
                // Existing user - store data and redirect
                const userData = userDoc.data();
                await storeUserData(user, userData);
                
                showAlert('Apple login successful! Redirecting...', 'success');
                
                const userType = userData.userType || 'student';
                setTimeout(() => {
                    redirectAfterLogin(userType);
                }, 1000);
            } else {
                // New user - create user document
                await createUserFromSocialLogin(user, 'apple');
            }
            
        } catch (error) {
            console.error("Apple login error:", error);
            handleSocialLoginError(error, 'Apple');
        } finally {
            // Reset button state
            appleLoginBtn.classList.remove('social-login-loading');
            appleLoginBtn.disabled = false;
        }
    }

    // Create user document for social login
    async function createUserFromSocialLogin(user, provider) {
        try {
            // Extract user data
            const displayName = user.displayName || 'Social User';
            const email = user.email;
            const firstName = displayName.split(' ')[0] || 'User';
            const lastName = displayName.split(' ').slice(1).join(' ') || '';
            
            // Create user document
            const userData = {
                firstName: firstName,
                lastName: lastName,
                email: email,
                userType: 'student', // Default to student
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                emailVerified: user.emailVerified || false,
                authProvider: provider,
                verificationStatus: 'pending'
            };
            
            // Save to Firestore
            await db.collection('users').doc(user.uid).set(userData);
            
            // Store in localStorage
            await storeUserData(user, userData);
            
            showAlert(`${provider} login successful! Welcome to FundMyFuture!`, 'success');
            
            // Redirect to profile completion or dashboard
            setTimeout(() => {
                window.location.href = 'student-profile-setup.html';
            }, 1500);
            
        } catch (error) {
            console.error("Error creating user document:", error);
            showAlert('Error setting up your account. Please try again.', 'error');
        }
    }

    // Handle social login errors
    function handleSocialLoginError(error, provider) {
        console.error(`${provider} login error:`, error);
        
        const errorMap = {
            'auth/account-exists-with-different-credential': {
                message: 'An account already exists with the same email address but different sign-in credentials. Try signing in with a different method.'
            },
            'auth/popup-blocked': {
                message: 'The sign-in popup was blocked by your browser. Please allow popups for this site.'
            },
            'auth/popup-closed-by-user': {
                message: 'The sign-in popup was closed before completing the sign-in process.'
            },
            'auth/cancelled-popup-request': {
                message: 'Another sign-in popup is already open.'
            },
            'auth/unauthorized-domain': {
                message: 'This domain is not authorized for OAuth operations. Please contact support.'
            },
            'auth/operation-not-allowed': {
                message: `${provider} sign-in is not enabled. Please contact support.`
            }
        };
        
        const errorInfo = errorMap[error.code] || {
            message: `${provider} sign-in failed. Please try again.`
        };
        
        showAlert(errorInfo.message, 'error');
    }

    // Real-time validation
    document.getElementById('email').addEventListener('input', function(){
        if(this.value) {
            this.classList.toggle('is-valid', validateEmail(this.value));
            this.classList.toggle('is-invalid', !validateEmail(this.value));
        }
        // Clear credential errors when user starts typing
        const emailError = document.getElementById('emailCredentialsError');
        if (emailError) emailError.classList.remove('show');
        hideFormFeedback();
        hidePermissionWarning();
    });

    document.getElementById('password').addEventListener('input', function(){
        if(this.value) {
            this.classList.toggle('is-valid', this.value.length>=6);
            this.classList.toggle('is-invalid', this.value.length<6);
        }
        // Clear credential errors when user starts typing
        const passwordError = document.getElementById('passwordCredentialsError');
        if (passwordError) passwordError.classList.remove('show');
        hideFormFeedback();
        hidePermissionWarning();
    });

    // Submit event for email/password login
    loginForm.addEventListener('submit', async e => {
        e.preventDefault();
        console.log("Form submitted");
        
        if(!validateForm()){
            showAlert('Please fill in all required fields correctly.', 'error');
            return;
        }
        
        console.log("Form validated, attempting login...");
        await handleLogin();
    });

    // Social login event listeners
    googleLoginBtn.addEventListener('click', handleGoogleLogin);
    facebookLoginBtn.addEventListener('click', handleFacebookLogin);
    appleLoginBtn.addEventListener('click', handleAppleLogin);

    function showAlert(message, type) {
        const alertContainer = document.getElementById('alertContainer');
        const alertId = 'alert-' + Date.now();
        const alertDiv = document.createElement('div');
        alertDiv.id = alertId;
        alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type === 'warning' ? 'warning' : 'success'} alert-dismissible fade show form-alert`;
        alertDiv.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
        alertContainer.appendChild(alertDiv);
        
        // Auto-remove alert after delay
        const delay = type === 'danger' || type === 'error' ? 8000 : 5000;
        setTimeout(() => { 
            if (document.getElementById(alertId)) {
                alertDiv.remove();
            }
        }, delay);
    }

    // Navbar functionality
    const navList = document.querySelector('.navbar-nav');

    // Function to build the logged-in navbar
    function updateNavbar(userName, userType) {
        if (!navList) return;

        // Clear all existing items (removes duplicates and old menu links)
        navList.innerHTML = '';

        // Add one DONATE NOW button
        const donateItem = document.createElement('li');
        donateItem.className = 'nav-item me-3';
        donateItem.innerHTML = `<a class="btn donate-btn ms-2" href="donate.html">DONATE NOW</a>`;

        // Add DASHBOARD (based on user type) - NAVBAR WILL NOW SHOW DASHBOARD LINK
        const dashboardItem = document.createElement('li');
        dashboardItem.className = 'nav-item';
        const dashboardPage =
            userType === 'student'
                ? 'student-dashboard.html'
                : userType === 'funder'
                ? 'funder-dashboard.html'
                : 'admin-dashboard.html';
        dashboardItem.innerHTML = `<a class="nav-link" href="${dashboardPage}">DASHBOARD</a>`;

        // Add dynamic Welcome message
        const welcomeItem = document.createElement('li');
        welcomeItem.className = 'nav-item';
        welcomeItem.innerHTML = `<span class="nav-link fw-bold">Welcome, ${userName}</span>`;

        // Add LOGOUT button
        const logoutItem = document.createElement('li');
        logoutItem.className = 'nav-item';
        logoutItem.innerHTML = `<button class="btn btn-outline-light ms-2" id="logoutBtn">LOGOUT</button>`;

        // Append all to the navbar
        navList.appendChild(donateItem);
        navList.appendChild(dashboardItem);
        navList.appendChild(welcomeItem);
        navList.appendChild(logoutItem);

        // Handle logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await auth.signOut();
                clearLocalStorage();
                window.location.href = 'index.html';
            } catch (error) {
                console.error("Logout error:", error);
                showAlert('Error during logout. Please try again.', 'error');
            }
        });
    }

    // Handle logged-out state (default navbar)
    function showDefaultNavbar() {
        if (!navList) return;
        navList.innerHTML = `
            <li class="nav-item me-3">
                <a class="btn donate-btn ms-2" href="donate.html">DONATE NOW</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="sign-up-funderStudent.html">STUDENTS</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="sign-up-funderStudent.html">FUNDERS</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="about.html">ABOUT US</a>
            </li>
            <li class="nav-item me-2" id="login-area">
                <a class="btn login-btn fw-bolder" href="login.html">LOGIN</a>
            </li>
        `;
    }

    // Authentication changes - only show logged in state if user exists in current session
    auth.onAuthStateChanged(user => {
        if (user) {
            // User is logged in for current session only
            const storedName = localStorage.getItem('userName') || 'User';
            const storedType = localStorage.getItem('userType') || 'student';
            updateNavbar(storedName, storedType);
        } else {
            // No user in current session
            showDefaultNavbar();
        }
    });

    console.log("Login page Firebase initialized successfully");
});
</script>

   <!-- Dynamic navbar -->
<script src="./js/navbar-auth.js"></script>
</body>
</html>